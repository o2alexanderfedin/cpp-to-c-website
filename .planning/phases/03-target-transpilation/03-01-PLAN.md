# Phase 3, Plan 03-01: Target Directory Selection

**Phase**: 03 - Target Selection & Live Transpilation
**Plan**: 03-01 - Target Directory Selection
**Scope**: Step 2 with target directory picker and permission verification
**Estimate**: 1 hour

---

## Objective

Implement Step 2 (Target Selection) with directory picker functionality, write permission verification, and clear display of target path and permission status.

**Why**: Establishes the output location for transpiled files. Users need to choose where transpiled C files will be written and see clear feedback about write permissions before proceeding to transpilation.

---

## Context

**Existing code to integrate:**
- `@src/components/playground/wizard/Step2TargetSelection.tsx` - current shell component (to be enhanced)
- `@src/components/playground/wizard/types.ts` - WizardState and TranspileOptions interfaces
- `@src/components/playground/wizard/useWizardState.ts` - state management hook with setTargetDir handler
- `@src/components/playground/DirectorySelector.tsx` - existing directory selection pattern to reuse
- `@src/adapters/FileSystemAccessAdapter.ts` - File System Access API wrapper (if exists)

**Patterns to follow:**
- React 19 with TypeScript (existing pattern)
- CSS-in-JS for styling (existing pattern in all wizard components)
- Component tests with Vitest and @testing-library/react (existing pattern)
- File System Access API for directory selection (Chrome 105+)

**Dependencies from previous phases:**
- Phase 1: Wizard state management (useWizardState)
- Phase 2: FileTreeView component (optional preview of target directory structure)

**Key Requirements:**
- Directory picker button using File System Access API
- Permission status indicator (read/write access)
- Display selected target directory path
- Validation: cannot proceed to Step 3 without target directory
- Error handling for permission denied scenarios
- Graceful degradation for unsupported browsers (show warning)

---

## Tasks

### Task 1: Create Permission Checker Utility
**Type**: create
**Files**: `src/components/playground/wizard/utils/checkDirectoryPermissions.ts`

**Action**:
Create utility function to verify directory write permissions:

```typescript
/**
 * Check if we have read/write permissions for a directory
 * @param dirHandle - FileSystemDirectoryHandle to check
 * @returns Object with read and write permission status
 */
export interface PermissionStatus {
  read: boolean;
  write: boolean;
}

export async function checkDirectoryPermissions(
  dirHandle: FileSystemDirectoryHandle
): Promise<PermissionStatus> {
  try {
    // Check read permission
    const readPermission = await dirHandle.queryPermission({ mode: 'read' });

    // Check write permission
    const writePermission = await dirHandle.queryPermission({ mode: 'readwrite' });

    return {
      read: readPermission === 'granted',
      write: writePermission === 'granted'
    };
  } catch (error) {
    console.error('Permission check failed:', error);
    return {
      read: false,
      write: false
    };
  }
}

/**
 * Request write permission for a directory
 * @param dirHandle - FileSystemDirectoryHandle to request permission for
 * @returns true if permission granted, false otherwise
 */
export async function requestWritePermission(
  dirHandle: FileSystemDirectoryHandle
): Promise<boolean> {
  try {
    const permission = await dirHandle.requestPermission({ mode: 'readwrite' });
    return permission === 'granted';
  } catch (error) {
    console.error('Permission request failed:', error);
    return false;
  }
}
```

**Verify**:
- Functions compile without TypeScript errors
- Handles File System Access API methods correctly
- Error handling for unsupported browsers

**Done**: ✅ Permission utilities created

---

### Task 2: Create PermissionIndicator Component
**Type**: create
**Files**: `src/components/playground/wizard/PermissionIndicator.tsx`

**Action**:
Create a visual component to show permission status:

```typescript
import React from 'react';

export interface PermissionIndicatorProps {
  hasRead: boolean;
  hasWrite: boolean;
  onRequestPermission?: () => void;
}

export const PermissionIndicator: React.FC<PermissionIndicatorProps> = ({
  hasRead,
  hasWrite,
  onRequestPermission
}) => {
  const allPermissionsGranted = hasRead && hasWrite;

  return (
    <div className="permission-indicator">
      <div className="permission-status">
        <span className={`status-badge ${hasRead ? 'granted' : 'denied'}`}>
          {hasRead ? '✓' : '✗'} Read
        </span>
        <span className={`status-badge ${hasWrite ? 'granted' : 'denied'}`}>
          {hasWrite ? '✓' : '✗'} Write
        </span>
      </div>

      {!allPermissionsGranted && onRequestPermission && (
        <button
          className="request-permission-button"
          onClick={onRequestPermission}
        >
          Request Permissions
        </button>
      )}

      {!hasWrite && (
        <p className="permission-warning">
          Write permission is required to save transpiled files.
        </p>
      )}

      <style>{`
        .permission-indicator {
          margin-top: 1rem;
          padding: 1rem;
          background-color: #f9f9f9;
          border-radius: 4px;
          border: 1px solid #ddd;
        }

        .permission-status {
          display: flex;
          gap: 0.75rem;
          margin-bottom: 0.75rem;
        }

        .status-badge {
          padding: 0.25rem 0.75rem;
          border-radius: 4px;
          font-size: 0.875rem;
          font-weight: 500;
        }

        .status-badge.granted {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }

        .status-badge.denied {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }

        .request-permission-button {
          padding: 0.5rem 1rem;
          background-color: #4A90E2;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.875rem;
          font-weight: 500;
          transition: background-color 0.15s;
        }

        .request-permission-button:hover {
          background-color: #357abd;
        }

        .permission-warning {
          margin-top: 0.75rem;
          margin-bottom: 0;
          font-size: 0.875rem;
          color: #856404;
          background-color: #fff3cd;
          padding: 0.5rem;
          border-radius: 4px;
          border: 1px solid #ffeaa7;
        }
      `}</style>
    </div>
  );
};
```

**Verify**:
- Component renders permission badges correctly
- Shows request button when permissions not granted
- Warning message displays when write permission missing
- Follows existing CSS-in-JS styling pattern

**Done**: ✅ PermissionIndicator component created

---

### Task 3: Enhance Step2TargetSelection Component
**Type**: update
**Files**: `src/components/playground/wizard/Step2TargetSelection.tsx`

**Action**:
Replace placeholder implementation with full functionality:

```typescript
import React, { useState, useEffect, useCallback } from 'react';
import { WizardStepper } from './WizardStepper';
import { PermissionIndicator } from './PermissionIndicator';
import type { WizardState, TranspileOptions } from './types';
import {
  checkDirectoryPermissions,
  requestWritePermission,
  type PermissionStatus
} from './utils/checkDirectoryPermissions';

interface Step2Props {
  state: WizardState;
  onTargetDirSelected: (dir: FileSystemDirectoryHandle) => void;
  onOptionsChanged: (options: TranspileOptions) => void;
}

export const Step2TargetSelection: React.FC<Step2Props> = ({
  state,
  onTargetDirSelected,
  onOptionsChanged
}) => {
  const [permissions, setPermissions] = useState<PermissionStatus>({
    read: false,
    write: false
  });
  const [isSelecting, setIsSelecting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Check permissions when target directory changes
  useEffect(() => {
    if (state.targetDir) {
      checkDirectoryPermissions(state.targetDir).then(setPermissions);
    }
  }, [state.targetDir]);

  const handleSelectDirectory = useCallback(async () => {
    setIsSelecting(true);
    setError(null);

    try {
      // Check if File System Access API is supported
      if (!('showDirectoryPicker' in window)) {
        setError('Your browser does not support directory selection. Please use Chrome 105+ or Edge 105+.');
        return;
      }

      // Show directory picker
      const dirHandle = await window.showDirectoryPicker({
        mode: 'readwrite'
      });

      // Verify permissions
      const perms = await checkDirectoryPermissions(dirHandle);

      if (!perms.write) {
        // Try to request write permission
        const granted = await requestWritePermission(dirHandle);
        if (!granted) {
          setError('Write permission denied. Please select a directory where you have write access.');
          return;
        }
      }

      // Set target directory in wizard state
      onTargetDirSelected(dirHandle);

    } catch (err) {
      if (err instanceof Error) {
        // User cancelled or error occurred
        if (err.name !== 'AbortError') {
          setError(`Failed to select directory: ${err.message}`);
        }
      }
    } finally {
      setIsSelecting(false);
    }
  }, [onTargetDirSelected]);

  const handleRequestPermission = useCallback(async () => {
    if (!state.targetDir) return;

    const granted = await requestWritePermission(state.targetDir);
    if (granted) {
      const perms = await checkDirectoryPermissions(state.targetDir);
      setPermissions(perms);
    } else {
      setError('Write permission denied. Please select a different directory.');
    }
  }, [state.targetDir]);

  const handleOptionsChange = useCallback((field: keyof TranspileOptions, value: any) => {
    onOptionsChanged({
      ...state.targetOptions,
      [field]: value
    });
  }, [state.targetOptions, onOptionsChanged]);

  return (
    <>
      <WizardStepper />
      <div className="wizard-step-content">
        <h2>Step 2: Select Target Directory</h2>
        <p className="step-description">
          Choose where transpiled C files will be saved.
        </p>

        {/* Directory Selection */}
        <div className="directory-selection">
          <button
            className="select-directory-button"
            onClick={handleSelectDirectory}
            disabled={isSelecting}
          >
            {isSelecting ? 'Selecting...' : state.targetDir ? 'Change Target Directory' : 'Select Target Directory'}
          </button>

          {state.targetDir && (
            <div className="selected-directory">
              <strong>Selected Directory:</strong>
              <code>{state.targetDir.name}</code>
            </div>
          )}
        </div>

        {/* Permission Status */}
        {state.targetDir && (
          <PermissionIndicator
            hasRead={permissions.read}
            hasWrite={permissions.write}
            onRequestPermission={handleRequestPermission}
          />
        )}

        {/* Error Display */}
        {error && (
          <div className="error-message">
            {error}
          </div>
        )}

        {/* Transpilation Options */}
        <div className="transpile-options">
          <h3>Transpilation Options</h3>

          <label className="option-label">
            <span>Target C Standard:</span>
            <select
              value={state.targetOptions.targetStandard}
              onChange={(e) => handleOptionsChange('targetStandard', e.target.value)}
            >
              <option value="c99">C99</option>
              <option value="c11">C11</option>
            </select>
          </label>

          <label className="option-checkbox">
            <input
              type="checkbox"
              checked={state.targetOptions.includeACSL}
              onChange={(e) => handleOptionsChange('includeACSL', e.target.checked)}
            />
            <span>Include ACSL annotations</span>
          </label>
        </div>
      </div>

      <style>{`
        .wizard-step-content {
          background-color: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 2rem;
          min-height: 400px;
        }

        .wizard-step-content h2 {
          margin: 0 0 0.5rem 0;
          font-size: 1.75rem;
          color: #333;
        }

        .step-description {
          margin: 0 0 1.5rem 0;
          color: #666;
        }

        .directory-selection {
          margin-bottom: 1.5rem;
        }

        .select-directory-button {
          padding: 0.75rem 1.5rem;
          background-color: #4A90E2;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 1rem;
          font-weight: 500;
          transition: background-color 0.15s;
        }

        .select-directory-button:hover:not(:disabled) {
          background-color: #357abd;
        }

        .select-directory-button:disabled {
          background-color: #ccc;
          cursor: not-allowed;
        }

        .selected-directory {
          margin-top: 1rem;
          padding: 0.75rem;
          background-color: #f5f5f5;
          border-radius: 4px;
          border: 1px solid #ddd;
        }

        .selected-directory code {
          display: inline-block;
          margin-left: 0.5rem;
          padding: 0.25rem 0.5rem;
          background-color: #fff;
          border: 1px solid #ddd;
          border-radius: 3px;
          font-family: 'Courier New', monospace;
          font-size: 0.9rem;
        }

        .error-message {
          margin: 1rem 0;
          padding: 0.75rem;
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          border-radius: 4px;
          font-size: 0.875rem;
        }

        .transpile-options {
          margin-top: 2rem;
          padding-top: 1.5rem;
          border-top: 1px solid #ddd;
        }

        .transpile-options h3 {
          margin: 0 0 1rem 0;
          font-size: 1.25rem;
          color: #333;
        }

        .option-label {
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          margin-bottom: 1rem;
        }

        .option-label span {
          font-weight: 500;
          color: #333;
        }

        .option-label select {
          padding: 0.5rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 1rem;
          max-width: 200px;
        }

        .option-checkbox {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          cursor: pointer;
        }

        .option-checkbox input {
          width: 1.25rem;
          height: 1.25rem;
          cursor: pointer;
        }
      `}</style>
    </>
  );
};
```

**Verify**:
- Directory picker button works
- Selected directory name displays correctly
- Permission indicator shows accurate status
- Options can be changed (C standard, ACSL toggle)
- Error messages display for unsupported browsers or permission issues
- TypeScript compiles without errors

**Done**: ✅ Step2TargetSelection enhanced with full functionality

---

### Task 4: Update Validation Logic
**Type**: update
**Files**: `src/components/playground/wizard/useWizardState.ts`

**Action**:
Ensure validation function checks for target directory with write permissions:

```typescript
// In useWizardState.ts, verify canNavigateToStep3 implementation:

const canNavigateToStep3 = useCallback(() => {
  // Must have target directory selected
  return state.targetDir !== null;
}, [state.targetDir]);
```

**Note**: Permission check is already handled in Step2 component. Validation only needs to ensure target directory is selected.

**Verify**:
- Next button in WizardStepper disabled until target directory selected
- Can navigate to Step 3 after selecting valid target directory
- Validation function returns correct boolean

**Done**: ✅ Validation logic confirmed

---

### Task 5: Component Tests
**Type**: test
**Files**:
- `src/components/playground/wizard/utils/checkDirectoryPermissions.test.ts`
- `src/components/playground/wizard/PermissionIndicator.test.tsx`
- `src/components/playground/wizard/Step2TargetSelection.test.tsx`

**Action**:
Create comprehensive unit tests:

**Permission utility tests:**
```typescript
import { describe, it, expect, vi } from 'vitest';
import { checkDirectoryPermissions, requestWritePermission } from './checkDirectoryPermissions';

describe('checkDirectoryPermissions', () => {
  it('returns permission status for directory', async () => {
    const mockDirHandle = {
      queryPermission: vi.fn()
        .mockResolvedValueOnce('granted') // read
        .mockResolvedValueOnce('granted') // write
    } as any;

    const result = await checkDirectoryPermissions(mockDirHandle);

    expect(result).toEqual({ read: true, write: true });
    expect(mockDirHandle.queryPermission).toHaveBeenCalledTimes(2);
  });

  it('handles permission denied', async () => {
    const mockDirHandle = {
      queryPermission: vi.fn()
        .mockResolvedValueOnce('granted') // read
        .mockResolvedValueOnce('denied') // write
    } as any;

    const result = await checkDirectoryPermissions(mockDirHandle);

    expect(result).toEqual({ read: true, write: false });
  });

  it('handles errors gracefully', async () => {
    const mockDirHandle = {
      queryPermission: vi.fn().mockRejectedValue(new Error('Permission error'))
    } as any;

    const result = await checkDirectoryPermissions(mockDirHandle);

    expect(result).toEqual({ read: false, write: false });
  });
});

describe('requestWritePermission', () => {
  it('requests and returns permission status', async () => {
    const mockDirHandle = {
      requestPermission: vi.fn().mockResolvedValue('granted')
    } as any;

    const result = await requestWritePermission(mockDirHandle);

    expect(result).toBe(true);
    expect(mockDirHandle.requestPermission).toHaveBeenCalledWith({ mode: 'readwrite' });
  });

  it('returns false when permission denied', async () => {
    const mockDirHandle = {
      requestPermission: vi.fn().mockResolvedValue('denied')
    } as any;

    const result = await requestWritePermission(mockDirHandle);

    expect(result).toBe(false);
  });
});
```

**PermissionIndicator tests:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { PermissionIndicator } from './PermissionIndicator';

describe('PermissionIndicator', () => {
  it('shows granted status for both permissions', () => {
    render(<PermissionIndicator hasRead={true} hasWrite={true} />);

    expect(screen.getByText(/✓ Read/)).toBeInTheDocument();
    expect(screen.getByText(/✓ Write/)).toBeInTheDocument();
  });

  it('shows denied status for missing permissions', () => {
    render(<PermissionIndicator hasRead={false} hasWrite={false} />);

    expect(screen.getByText(/✗ Read/)).toBeInTheDocument();
    expect(screen.getByText(/✗ Write/)).toBeInTheDocument();
  });

  it('shows request button when permissions not granted', () => {
    const handleRequest = vi.fn();
    render(
      <PermissionIndicator
        hasRead={true}
        hasWrite={false}
        onRequestPermission={handleRequest}
      />
    );

    const button = screen.getByText('Request Permissions');
    expect(button).toBeInTheDocument();

    fireEvent.click(button);
    expect(handleRequest).toHaveBeenCalled();
  });

  it('shows warning when write permission missing', () => {
    render(<PermissionIndicator hasRead={true} hasWrite={false} />);

    expect(screen.getByText(/Write permission is required/)).toBeInTheDocument();
  });

  it('does not show request button when all permissions granted', () => {
    render(<PermissionIndicator hasRead={true} hasWrite={true} />);

    expect(screen.queryByText('Request Permissions')).not.toBeInTheDocument();
  });
});
```

**Step2TargetSelection tests:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { Step2TargetSelection } from './Step2TargetSelection';
import type { WizardState } from './types';

describe('Step2TargetSelection', () => {
  const mockState: WizardState = {
    sourceDir: null,
    sourceFiles: [],
    targetDir: null,
    targetOptions: { targetStandard: 'c99', includeACSL: true },
    transpilationResults: new Map(),
    currentFile: null,
    isTranspiling: false,
    selectedPreviewFile: null
  };

  it('renders directory selection button', () => {
    render(
      <Step2TargetSelection
        state={mockState}
        onTargetDirSelected={vi.fn()}
        onOptionsChanged={vi.fn()}
      />
    );

    expect(screen.getByText('Select Target Directory')).toBeInTheDocument();
  });

  it('displays selected directory name', () => {
    const mockDirHandle = { name: 'output' } as FileSystemDirectoryHandle;
    const stateWithDir = { ...mockState, targetDir: mockDirHandle };

    render(
      <Step2TargetSelection
        state={stateWithDir}
        onTargetDirSelected={vi.fn()}
        onOptionsChanged={vi.fn()}
      />
    );

    expect(screen.getByText('output')).toBeInTheDocument();
  });

  it('shows transpilation options', () => {
    render(
      <Step2TargetSelection
        state={mockState}
        onTargetDirSelected={vi.fn()}
        onOptionsChanged={vi.fn()}
      />
    );

    expect(screen.getByText('Transpilation Options')).toBeInTheDocument();
    expect(screen.getByLabelText(/Target C Standard/)).toBeInTheDocument();
    expect(screen.getByLabelText(/Include ACSL/)).toBeInTheDocument();
  });

  it('calls onOptionsChanged when options change', () => {
    const handleChange = vi.fn();

    render(
      <Step2TargetSelection
        state={mockState}
        onTargetDirSelected={vi.fn()}
        onOptionsChanged={handleChange}
      />
    );

    const select = screen.getByLabelText(/Target C Standard/) as HTMLSelectElement;
    fireEvent.change(select, { target: { value: 'c11' } });

    expect(handleChange).toHaveBeenCalledWith({
      targetStandard: 'c11',
      includeACSL: true
    });
  });
});
```

**Verify**:
- All tests pass
- Coverage >80% for new code
- Tests cover permission checking, UI interactions, and option changes

**Done**: ✅ Tests written and passing

---

### Task 6: Update Exports
**Type**: update
**Files**: `src/components/playground/wizard/index.ts`

**Action**:
Add new components and utilities to barrel exports:

```typescript
// ... existing exports ...

export { PermissionIndicator } from './PermissionIndicator';
export type { PermissionIndicatorProps } from './PermissionIndicator';

// Utilities
export { checkDirectoryPermissions, requestWritePermission } from './utils/checkDirectoryPermissions';
export type { PermissionStatus } from './utils/checkDirectoryPermissions';
```

**Verify**:
- All exports compile without errors
- Can import from '@/components/playground/wizard'
- TypeScript autocomplete works

**Done**: ✅ Exports updated

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm run test` passes all tests (new and existing)
2. ✅ `npm run build` completes without errors
3. ✅ TypeScript compilation succeeds with no errors
4. ✅ Navigate to http://localhost:4321/cpp-to-c-website/playground
5. ✅ Complete Step 1 (select source directory)
6. ✅ Navigate to Step 2
7. ✅ Click "Select Target Directory" button
8. ✅ Directory picker opens (Chrome/Edge)
9. ✅ Select a directory
10. ✅ Directory name displays
11. ✅ Permission status shows (read ✓, write ✓)
12. ✅ Can change transpilation options (C standard, ACSL checkbox)
13. ✅ Next button enabled after selecting directory with write permission
14. ✅ No console errors in browser

---

## Success Criteria

- [x] Directory picker works using File System Access API
- [x] Permission checking utility verifies read/write access
- [x] PermissionIndicator component displays status visually
- [x] Step2TargetSelection shows selected directory and permissions
- [x] Transpilation options (C standard, ACSL) can be configured
- [x] Request permission button works when permissions denied
- [x] Error messages display for unsupported browsers or permission issues
- [x] Validation prevents navigation to Step 3 without target directory
- [x] Unit tests pass with >80% coverage
- [x] All existing tests still pass (no regressions)

---

## Output: SUMMARY.md

When this plan is complete, create `03-01-SUMMARY.md` with:

```markdown
# Phase 3, Plan 03-01: Target Directory Selection - COMPLETE

**Status**: ✅ Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Created permission checking utilities (checkDirectoryPermissions, requestWritePermission)
- Created PermissionIndicator component for visual status display
- Enhanced Step2TargetSelection with full directory selection functionality
- Added transpilation options UI (C standard, ACSL toggle)
- Implemented error handling for unsupported browsers and permission issues
- Added comprehensive unit tests for utilities and components

## Files Changed

- `src/components/playground/wizard/utils/checkDirectoryPermissions.ts` - NEW (permission utilities)
- `src/components/playground/wizard/utils/checkDirectoryPermissions.test.ts` - NEW (tests)
- `src/components/playground/wizard/PermissionIndicator.tsx` - NEW (permission UI component)
- `src/components/playground/wizard/PermissionIndicator.test.tsx` - NEW (tests)
- `src/components/playground/wizard/Step2TargetSelection.tsx` - UPDATED (full implementation)
- `src/components/playground/wizard/Step2TargetSelection.test.tsx` - NEW (tests)
- `src/components/playground/wizard/index.ts` - UPDATED (new exports)

## Tests

- Permission utilities: X tests passing
- PermissionIndicator: X tests passing
- Step2TargetSelection: X tests passing
- Coverage: X% (target: >80%)

## Verification

✅ All success criteria met
✅ Directory selection works in Chrome/Edge
✅ Permission checking and request flow works
✅ Options can be configured
✅ Error handling works correctly
✅ No regressions

## Next Steps

Ready for **03-02**: Conflict Detection
- Check for existing files in target directory
- Display warning if files will be overwritten
- Add option to proceed or choose different directory

## Commits

- `[commit-hash]` feat(03-01): Add permission checking utilities
- `[commit-hash]` feat(03-01): Create PermissionIndicator component
- `[commit-hash]` feat(03-01): Implement target directory selection in Step 2
- `[commit-hash]` test(03-01): Add comprehensive tests for Step 2 components
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/03-target-transpilation/03-01-PLAN.md`
