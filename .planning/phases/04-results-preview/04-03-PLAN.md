# Phase 4, Plan 04-03: Results Step Integration

**Phase**: 04 - Results Preview & Download
**Plan**: 04-03 - Results Step Integration
**Scope**: Wire FileTreeView and DualPaneViewer into Step 4 with state management
**Estimate**: 2 hours

---

## Objective

Integrate the FileTreeView and DualPaneViewer components into Step4Results, connecting them to wizard state to enable interactive file preview with source/transpiled code comparison.

**Why**: Brings all Phase 4 components together into a functional results view where users can browse transpiled files in a tree, click to preview any file, and see source/result side-by-side with syntax highlighting. This completes the core functionality of Step 4.

---

## Context

**Existing code to enhance:**
- `@src/components/playground/wizard/Step4Results.tsx` - shell component to enhance
- `@src/components/playground/wizard/types.ts` - WizardState with transpilationResults and selectedPreviewFile
- `@src/components/playground/wizard/useWizardState.ts` - state management hook with handlers

**Components to use:**
- `@src/components/playground/wizard/FileTreeView.tsx` - tree component (from Phase 2)
- `@src/components/playground/wizard/DualPaneViewer.tsx` - split-pane viewer (from 04-01)
- `@src/components/playground/wizard/FileContentDisplay.tsx` - file content with syntax highlighting (from 04-01/04-02)

**Patterns to follow:**
- React 19 with TypeScript (existing pattern)
- CSS-in-JS for styling (existing pattern in all current components)
- Component tests with Vitest and @testing-library/react (existing pattern)
- Use wizard state for data flow

**Key Requirements:**
- Display FileTreeView showing transpiled files from wizard state
- Click file in tree → load in DualPaneViewer
- Load both source and transpiled content
- Show file statistics (total files, success/error counts)
- Handle empty state (no transpilation results)
- Handle error state (some files failed)
- Highlight current selected file in tree
- Smooth transitions between file selections

---

## Tasks

### Task 1: Implement File Loading Logic
**Type**: create
**Files**: `src/components/playground/wizard/utils/loadFileContent.ts`

**Action**:
Create utility function to load file content from FileSystemFileHandle:

```typescript
import type { FileInfo } from '../types';

/**
 * Load text content from a FileSystemFileHandle
 * @param handle - File handle to read
 * @returns File content as string
 */
export async function loadFileContent(handle: FileSystemFileHandle): Promise<string> {
  try {
    const file = await handle.getFile();
    const content = await file.text();
    return content;
  } catch (error) {
    console.error('Failed to load file content:', error);
    throw new Error(`Failed to read file: ${handle.name}`);
  }
}

/**
 * Find FileInfo by path in file list
 * @param files - List of FileInfo objects
 * @param path - File path to find
 * @returns FileInfo or undefined
 */
export function findFileByPath(files: FileInfo[], path: string): FileInfo | undefined {
  return files.find(f => f.path === path);
}
```

**Verify**:
- Functions compile without TypeScript errors
- Error handling for failed file reads
- Can be tested with mock FileSystemFileHandle

**Done**: ✅ File loading utilities created

---

### Task 2: Enhance Step4Results with Tree and Viewer
**Type**: update
**Files**: `src/components/playground/wizard/Step4Results.tsx`

**Action**:
Transform Step4Results from shell to full-featured results view:

```typescript
import React from 'react';
import { WizardStepper } from './WizardStepper';
import { FileTreeView } from './FileTreeView';
import { DualPaneViewer } from './DualPaneViewer';
import type { WizardState, FileInfo, TranspileResult } from './types';
import { loadFileContent, findFileByPath } from './utils/loadFileContent';

interface Step4Props {
  state: WizardState;
  onFileSelected: (filePath: string) => void;
  onDownload: () => void;
}

export const Step4Results: React.FC<Step4Props> = ({
  state,
  onFileSelected,
  onDownload
}) => {
  // Local state for loaded file contents
  const [sourceContent, setSourceContent] = React.useState<string>('');
  const [transpileContent, setTranspileContent] = React.useState<string>('');
  const [isLoading, setIsLoading] = React.useState<boolean>(false);
  const [loadError, setLoadError] = React.useState<string | null>(null);

  // Get list of files that were transpiled (from state.sourceFiles)
  const transpiledFiles = React.useMemo(() => {
    return state.sourceFiles.filter(file =>
      state.transpilationResults.has(file.path)
    );
  }, [state.sourceFiles, state.transpilationResults]);

  // Calculate statistics
  const stats = React.useMemo(() => {
    const total = state.transpilationResults.size;
    const successful = Array.from(state.transpilationResults.values())
      .filter(r => r.success).length;
    const failed = total - successful;

    return { total, successful, failed };
  }, [state.transpilationResults]);

  // Load file contents when selectedPreviewFile changes
  React.useEffect(() => {
    const loadFile = async () => {
      if (!state.selectedPreviewFile) {
        setSourceContent('');
        setTranspileContent('');
        return;
      }

      setIsLoading(true);
      setLoadError(null);

      try {
        // Find source file
        const sourceFile = findFileByPath(state.sourceFiles, state.selectedPreviewFile);
        if (!sourceFile) {
          throw new Error('Source file not found');
        }

        // Load source content
        const source = await loadFileContent(sourceFile.handle);
        setSourceContent(source);

        // Get transpilation result
        const result = state.transpilationResults.get(state.selectedPreviewFile);
        if (result?.success && result.cCode) {
          setTranspileContent(result.cCode);
        } else if (result?.error) {
          setTranspileContent(`// Transpilation failed:\n// ${result.error}`);
        } else {
          setTranspileContent('// No transpiled output available');
        }
      } catch (error) {
        console.error('Error loading file:', error);
        setLoadError(error instanceof Error ? error.message : 'Unknown error');
        setSourceContent('');
        setTranspileContent('');
      } finally {
        setIsLoading(false);
      }
    };

    loadFile();
  }, [state.selectedPreviewFile, state.sourceFiles, state.transpilationResults]);

  // Handle file selection from tree
  const handleFileSelect = React.useCallback((file: FileInfo) => {
    onFileSelected(file.path);
  }, [onFileSelected]);

  // Empty state: no transpilation results
  if (state.transpilationResults.size === 0) {
    return (
      <>
        <WizardStepper />
        <div className="wizard-step-content">
          <div className="empty-state">
            <h2>No Results Yet</h2>
            <p>Complete transpilation in Step 3 to view results here.</p>
          </div>
        </div>

        <style>{`
          .wizard-step-content {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 2rem;
            min-height: 400px;
          }

          .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
          }

          .empty-state h2 {
            margin: 0 0 1rem 0;
            color: #999;
          }
        `}</style>
      </>
    );
  }

  return (
    <>
      <WizardStepper />
      <div className="wizard-step-content">
        <div className="results-header">
          <h2>Step 4: Results</h2>

          {/* Statistics */}
          <div className="results-stats">
            <div className="stat">
              <span className="stat-label">Total:</span>
              <span className="stat-value">{stats.total}</span>
            </div>
            <div className="stat stat-success">
              <span className="stat-label">Success:</span>
              <span className="stat-value">{stats.successful}</span>
            </div>
            {stats.failed > 0 && (
              <div className="stat stat-error">
                <span className="stat-label">Failed:</span>
                <span className="stat-value">{stats.failed}</span>
              </div>
            )}
          </div>
        </div>

        {/* Main content: Tree + Viewer */}
        <div className="results-content">
          {/* Left: File tree */}
          <div className="results-tree">
            <h3>Transpiled Files</h3>
            <FileTreeView
              files={transpiledFiles}
              selectedFile={state.selectedPreviewFile || undefined}
              onFileSelect={handleFileSelect}
              height={500}
            />
          </div>

          {/* Right: Dual-pane viewer */}
          <div className="results-viewer">
            {loadError ? (
              <div className="load-error">
                <h3>Error Loading File</h3>
                <p>{loadError}</p>
              </div>
            ) : isLoading ? (
              <div className="loading-state">
                <p>Loading file contents...</p>
              </div>
            ) : (
              <DualPaneViewer
                sourceContent={sourceContent}
                sourceFilename={state.selectedPreviewFile || undefined}
                transpileContent={transpileContent}
                transpileFilename={
                  state.selectedPreviewFile
                    ? state.selectedPreviewFile.replace(/\.(cpp|cc|cxx)$/i, '.c')
                    : undefined
                }
              />
            )}
          </div>
        </div>
      </div>

      <style>{`
        .wizard-step-content {
          background-color: #fff;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 2rem;
          min-height: 600px;
        }

        .results-header {
          margin-bottom: 1.5rem;
        }

        .results-header h2 {
          margin: 0 0 1rem 0;
          font-size: 1.75rem;
          color: #333;
        }

        .results-stats {
          display: flex;
          gap: 1.5rem;
        }

        .stat {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.5rem 1rem;
          background-color: #f5f5f5;
          border-radius: 4px;
        }

        .stat-label {
          font-size: 0.9rem;
          color: #666;
        }

        .stat-value {
          font-size: 1.25rem;
          font-weight: 600;
          color: #333;
        }

        .stat-success .stat-value {
          color: #4caf50;
        }

        .stat-error .stat-value {
          color: #f44336;
        }

        .results-content {
          display: grid;
          grid-template-columns: 300px 1fr;
          gap: 1.5rem;
          height: 500px;
        }

        .results-tree {
          display: flex;
          flex-direction: column;
        }

        .results-tree h3 {
          margin: 0 0 0.75rem 0;
          font-size: 1rem;
          color: #666;
        }

        .results-viewer {
          display: flex;
          flex-direction: column;
        }

        .load-error,
        .loading-state {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          background-color: #fafafa;
          border: 1px solid #ddd;
          border-radius: 8px;
          padding: 2rem;
        }

        .load-error {
          color: #f44336;
        }

        .load-error h3 {
          margin: 0 0 0.5rem 0;
        }

        .loading-state {
          color: #666;
          font-style: italic;
        }

        @media (max-width: 768px) {
          .results-content {
            grid-template-columns: 1fr;
            grid-template-rows: 250px 1fr;
            height: auto;
          }
        }
      `}</style>
    </>
  );
};
```

**Component features:**
1. Displays statistics (total, success, failed counts)
2. Shows FileTreeView with transpiled files
3. Highlights selected file in tree
4. Loads source and transpiled content on selection
5. Displays content in DualPaneViewer
6. Loading state while files load
7. Error state for failed file loads
8. Empty state when no results
9. Responsive layout (tree + viewer side-by-side)

**Verify**:
- Statistics display correctly
- Tree shows transpiled files
- Clicking file loads content
- DualPaneViewer shows source and transpiled code
- Loading states work
- Error handling works
- Empty state displays when appropriate
- No TypeScript errors

**Done**: ✅ Step4Results fully implemented

---

### Task 3: Update PlaygroundWizard Integration
**Type**: update
**Files**: `src/components/playground/wizard/PlaygroundWizard.tsx`

**Action**:
Verify Step4Results receives correct state and handlers (should already be correct from 01-02):

```typescript
// In PlaygroundWizard.tsx - verify this is correct:

<Step4Results
  state={state}
  onFileSelected={handlers.setSelectedPreviewFile}
  onDownload={() => {/* TODO: Implement in 04-04 */}}
/>
```

**Verify**:
- Step4Results receives wizard state
- onFileSelected handler wired to setSelectedPreviewFile
- State updates trigger re-render
- No TypeScript errors

**Done**: ✅ PlaygroundWizard integration verified

---

### Task 4: Component Tests
**Type**: test
**Files**: `src/components/playground/wizard/Step4Results.test.tsx`, `utils/loadFileContent.test.ts`

**Action**:
Create comprehensive tests:

**utils/loadFileContent.test.ts**:
```typescript
import { describe, it, expect, vi } from 'vitest';
import { loadFileContent, findFileByPath } from './loadFileContent';
import type { FileInfo } from '../types';

describe('loadFileContent', () => {
  it('loads file content from handle', async () => {
    const mockHandle = {
      name: 'test.cpp',
      getFile: vi.fn().mockResolvedValue({
        text: vi.fn().mockResolvedValue('file content'),
      }),
    } as unknown as FileSystemFileHandle;

    const content = await loadFileContent(mockHandle);
    expect(content).toBe('file content');
  });

  it('throws error when file read fails', async () => {
    const mockHandle = {
      name: 'test.cpp',
      getFile: vi.fn().mockRejectedValue(new Error('Read failed')),
    } as unknown as FileSystemFileHandle;

    await expect(loadFileContent(mockHandle)).rejects.toThrow('Failed to read file');
  });
});

describe('findFileByPath', () => {
  const mockFiles: FileInfo[] = [
    { path: 'src/main.cpp', name: 'main.cpp', handle: {} as any, size: 100 },
    { path: 'src/helper.cpp', name: 'helper.cpp', handle: {} as any, size: 200 },
  ];

  it('finds file by path', () => {
    const file = findFileByPath(mockFiles, 'src/main.cpp');
    expect(file).toBeDefined();
    expect(file?.name).toBe('main.cpp');
  });

  it('returns undefined for non-existent path', () => {
    const file = findFileByPath(mockFiles, 'missing.cpp');
    expect(file).toBeUndefined();
  });
});
```

**Step4Results.test.tsx**:
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Step4Results } from './Step4Results';
import type { WizardState } from './types';

// Mock FileTreeView and DualPaneViewer
vi.mock('./FileTreeView', () => ({
  FileTreeView: ({ files, onFileSelect }: any) => (
    <div data-testid="file-tree">
      {files.map((f: any) => (
        <button key={f.path} onClick={() => onFileSelect(f)}>
          {f.name}
        </button>
      ))}
    </div>
  ),
}));

vi.mock('./DualPaneViewer', () => ({
  DualPaneViewer: ({ sourceContent, transpileContent }: any) => (
    <div data-testid="dual-pane">
      <div data-testid="source">{sourceContent}</div>
      <div data-testid="transpile">{transpileContent}</div>
    </div>
  ),
}));

describe('Step4Results', () => {
  const mockState: WizardState = {
    sourceDir: {} as any,
    sourceFiles: [
      {
        path: 'test.cpp',
        name: 'test.cpp',
        handle: {
          getFile: vi.fn().mockResolvedValue({
            text: vi.fn().mockResolvedValue('// C++ source'),
          }),
        } as any,
        size: 100,
      },
    ],
    targetDir: {} as any,
    targetOptions: { targetStandard: 'c99', includeACSL: true },
    transpilationResults: new Map([
      ['test.cpp', { success: true, cCode: '// C output' }],
    ]),
    currentFile: null,
    isTranspiling: false,
    selectedPreviewFile: null,
  };

  it('shows empty state when no transpilation results', () => {
    const emptyState = { ...mockState, transpilationResults: new Map() };
    render(
      <Step4Results
        state={emptyState}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    expect(screen.getByText('No Results Yet')).toBeInTheDocument();
  });

  it('displays statistics', () => {
    render(
      <Step4Results
        state={mockState}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    expect(screen.getByText('Total:')).toBeInTheDocument();
    expect(screen.getByText('1')).toBeInTheDocument(); // total count
    expect(screen.getByText('Success:')).toBeInTheDocument();
  });

  it('renders file tree with transpiled files', () => {
    render(
      <Step4Results
        state={mockState}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    expect(screen.getByTestId('file-tree')).toBeInTheDocument();
    expect(screen.getByText('test.cpp')).toBeInTheDocument();
  });

  it('calls onFileSelected when file clicked', async () => {
    const handleFileSelect = vi.fn();
    render(
      <Step4Results
        state={mockState}
        onFileSelected={handleFileSelect}
        onDownload={vi.fn()}
      />
    );

    const fileButton = screen.getByText('test.cpp');
    await userEvent.click(fileButton);

    expect(handleFileSelect).toHaveBeenCalledWith('test.cpp');
  });

  it('loads and displays file content when file selected', async () => {
    const stateWithSelection = {
      ...mockState,
      selectedPreviewFile: 'test.cpp',
    };

    render(
      <Step4Results
        state={stateWithSelection}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    await waitFor(() => {
      expect(screen.getByTestId('source')).toHaveTextContent('// C++ source');
      expect(screen.getByTestId('transpile')).toHaveTextContent('// C output');
    });
  });

  it('shows loading state while loading file', async () => {
    const stateWithSelection = {
      ...mockState,
      selectedPreviewFile: 'test.cpp',
    };

    render(
      <Step4Results
        state={stateWithSelection}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    // Should show loading briefly
    expect(screen.getByText(/Loading file contents/i)).toBeInTheDocument();
  });

  it('displays error state when file load fails', async () => {
    const stateWithBadFile = {
      ...mockState,
      sourceFiles: [
        {
          path: 'bad.cpp',
          name: 'bad.cpp',
          handle: {
            getFile: vi.fn().mockRejectedValue(new Error('Read failed')),
          } as any,
          size: 100,
        },
      ],
      selectedPreviewFile: 'bad.cpp',
    };

    render(
      <Step4Results
        state={stateWithBadFile}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    await waitFor(() => {
      expect(screen.getByText('Error Loading File')).toBeInTheDocument();
    });
  });

  it('shows failed transpilation in output pane', async () => {
    const stateWithError = {
      ...mockState,
      transpilationResults: new Map([
        ['test.cpp', { success: false, error: 'Parse error' }],
      ]),
      selectedPreviewFile: 'test.cpp',
    };

    render(
      <Step4Results
        state={stateWithError}
        onFileSelected={vi.fn()}
        onDownload={vi.fn()}
      />
    );

    await waitFor(() => {
      expect(screen.getByTestId('transpile')).toHaveTextContent('Parse error');
    });
  });
});
```

**Test coverage goals:**
- Step4Results: empty state, statistics, tree rendering, file selection, loading, errors
- loadFileContent utility: success and error cases
- Target: >80% coverage

**Verify**:
- All tests pass
- Coverage report shows >80%
- Async loading tests use waitFor correctly
- Mocks work properly

**Done**: ✅ Tests written and passing

---

### Task 5: Manual Testing in Browser
**Type**: manual test
**Files**: N/A (browser testing)

**Action**:
Test full Step 4 flow with realistic wizard state:

**Browser testing checklist:**
1. Start dev server: `npm run dev`
2. Navigate to playground
3. Complete Steps 1-3 (or mock the state)
4. Navigate to Step 4
5. Verify:
   - ✅ Statistics display (total, success, failed counts)
   - ✅ File tree shows transpiled files
   - ✅ Tree shows folder structure correctly
   - ✅ No file selected initially (or auto-select first)
   - ✅ Click file in tree
   - ✅ Loading indicator appears briefly
   - ✅ DualPaneViewer loads with content
   - ✅ Left pane shows C++ source with syntax highlighting
   - ✅ Right pane shows C output with syntax highlighting
   - ✅ Selected file highlighted in tree
   - ✅ Click different file → content updates
   - ✅ File transition is smooth
   - ✅ No console errors
   - ✅ Layout is responsive

**Test error scenarios:**
6. Mock a failed transpilation result
7. Verify:
   - ✅ Failed count shows in statistics
   - ✅ Clicking failed file shows error message in right pane
   - ✅ Error message is readable

**Test empty state:**
8. Clear transpilationResults from state
9. Verify:
   - ✅ Empty state message displays
   - ✅ No tree or viewer shown

**Performance checks:**
- ✅ File loading is fast (<100ms)
- ✅ Tree selection updates immediately
- ✅ No lag when switching files
- ✅ Syntax highlighting doesn't block UI

**Verify**:
- All visual checks pass
- Interactions feel smooth
- Error states are clear
- No console warnings or errors

**Done**: ✅ Manual browser testing complete

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm run test` passes all tests
2. ✅ `npm run build` succeeds without errors
3. ✅ `npm run dev` starts without errors
4. ✅ Navigate to playground → Step 4
5. ✅ Statistics display correctly
6. ✅ File tree shows transpiled files
7. ✅ Can click file to select
8. ✅ DualPaneViewer loads source and transpiled content
9. ✅ Both panes have syntax highlighting
10. ✅ Selected file highlighted in tree
11. ✅ Loading state shows briefly
12. ✅ Can switch between files smoothly
13. ✅ Error handling works for failed loads
14. ✅ Empty state displays when appropriate
15. ✅ No TypeScript errors in IDE
16. ✅ No console errors in browser

---

## Success Criteria

- [x] loadFileContent utility loads file content from handle
- [x] findFileByPath utility finds files in array
- [x] Step4Results displays transpilation statistics
- [x] FileTreeView integrated showing transpiled files
- [x] Clicking file in tree selects it (updates state)
- [x] File selection triggers content loading
- [x] DualPaneViewer displays source and transpiled code
- [x] Syntax highlighting works in both panes
- [x] Selected file highlighted in tree
- [x] Loading state during file load
- [x] Error state for failed file loads
- [x] Empty state when no transpilation results
- [x] Responsive layout (tree + viewer)
- [x] Smooth file switching
- [x] Unit tests pass with >80% coverage
- [x] Components follow existing patterns
- [x] Manual browser testing confirms functionality
- [x] All existing tests still pass (no regressions)

---

## Output: SUMMARY.md

When this plan is complete, create `04-03-SUMMARY.md` with:

```markdown
# Phase 4, Plan 04-03: Results Step Integration - COMPLETE

**Status**: ✅ Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Created loadFileContent utility to read file content from FileSystemFileHandle
- Created findFileByPath utility to find files in array
- Enhanced Step4Results with full functionality:
  - Transpilation statistics display
  - FileTreeView showing transpiled files
  - File selection from tree
  - Async file content loading
  - DualPaneViewer with source/transpiled comparison
  - Loading and error states
  - Empty state handling
- Integrated all Phase 4 components into cohesive results view
- Created comprehensive unit tests
- Verified PlaygroundWizard integration

## Files Changed

- `src/components/playground/wizard/utils/loadFileContent.ts` - NEW (X lines)
- `src/components/playground/wizard/utils/loadFileContent.test.ts` - NEW (X lines)
- `src/components/playground/wizard/Step4Results.tsx` - UPDATED (full implementation)
- `src/components/playground/wizard/Step4Results.test.tsx` - NEW (X lines)
- `src/components/playground/wizard/PlaygroundWizard.tsx` - VERIFIED (no changes)

## Tests

- Unit tests: X passing, 0 failing
- loadFileContent tests: X passing
- Step4Results tests: X passing (statistics, tree, selection, loading, errors, empty)
- Coverage: X% (target: >80%)

## Verification

✅ All success criteria met
✅ No regressions in existing tests
✅ Step 4 fully functional in browser
✅ File selection and preview work smoothly
✅ All state management working correctly
✅ Error handling robust

## Deviations from Plan

[None] OR [List any changes made during implementation]

## Next Steps

Ready for **04-04**: Download Options & Polish
- Add download individual file button
- Add download all as ZIP button
- Display success metrics (files, bytes, time)
- Enhanced error summary with clickable links
- Final UI polish and refinements

## Commits

- `[commit-hash]` feat(04-03): Add file loading utilities
- `[commit-hash]` feat(04-03): Implement full Step4Results with tree and viewer
- `[commit-hash]` test(04-03): Add tests for Step4Results and utilities
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/04-results-preview/04-03-PLAN.md`
