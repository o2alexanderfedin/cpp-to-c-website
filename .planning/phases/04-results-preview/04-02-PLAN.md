# Phase 4, Plan 04-02: Syntax Highlighting

**Phase**: 04 - Results Preview & Download
**Plan**: 04-02 - Syntax Highlighting
**Scope**: Async syntax highlighting with prism-react-renderer for C++ and C
**Estimate**: 1-2 hours

---

## Objective

Add syntax highlighting to the dual-pane viewer using `prism-react-renderer` to colorize C++ source code and transpiled C output, with async loading to prevent UI blocking on large files.

**Why**: Enhances code readability by adding color-coded syntax highlighting. Using prism-react-renderer (lightweight ~2kB core, from BRIEF) instead of heavier alternatives saves bundle size while providing excellent C++ and C language support.

---

## Context

**Existing code to enhance:**
- `@src/components/playground/wizard/FileContentDisplay.tsx` - component to integrate syntax highlighting
- `@src/components/playground/wizard/DualPaneViewer.tsx` - uses FileContentDisplay for both panes
- `@src/components/playground/wizard/Step4Results.tsx` - final integration point

**Patterns to follow:**
- React 19 with TypeScript (existing pattern)
- CSS-in-JS for styling (existing pattern in all current components)
- Component tests with Vitest and @testing-library/react (existing pattern)
- Async loading for performance (non-blocking UI)

**New dependency:**
- `prism-react-renderer@^2.4.1` - Lightweight syntax highlighting (recommended in BRIEF)

**Key Requirements:**
- Support C++ language (.cpp, .h, .hpp files)
- Support C language (.c files)
- Async rendering to prevent blocking UI with large files
- Line numbers must align with highlighted code
- Theme: Use a clean, readable color scheme (light theme)
- Fallback to plain text if highlighting fails

---

## Tasks

### Task 1: Install prism-react-renderer
**Type**: dependency
**Files**: `package.json`, `package-lock.json`

**Action**:
```bash
npm install prism-react-renderer
```

**Verify**:
- Package appears in package.json dependencies
- No version conflicts with React 19
- No peer dependency warnings
- Prism core and C++/C language definitions included

**Done**: ✅ Dependency installed and no conflicts

---

### Task 2: Create SyntaxHighlighter Wrapper Component
**Type**: create
**Files**: `src/components/playground/wizard/SyntaxHighlighter.tsx`

**Action**:
Create a wrapper component around prism-react-renderer with async support:

```typescript
import React from 'react';
import { Highlight, themes } from 'prism-react-renderer';

export interface SyntaxHighlighterProps {
  code: string;
  language: 'cpp' | 'c';
  lineNumbers?: boolean;
  showLineNumbers?: boolean; // Alias for lineNumbers
  highlightLines?: number[]; // Optional: highlight specific lines
}

export const SyntaxHighlighter: React.FC<SyntaxHighlighterProps> = ({
  code,
  language,
  lineNumbers = true,
  showLineNumbers = true,
  highlightLines = [],
}) => {
  const displayLineNumbers = lineNumbers || showLineNumbers;

  // Use async rendering for large files (>1000 lines)
  const [isReady, setIsReady] = React.useState(code.split('\n').length < 1000);

  React.useEffect(() => {
    if (!isReady) {
      // Defer rendering to next frame to prevent blocking
      const timer = setTimeout(() => setIsReady(true), 0);
      return () => clearTimeout(timer);
    }
  }, [isReady, code]);

  // Loading state for large files
  if (!isReady) {
    return (
      <div className="syntax-loading">
        <p>Preparing syntax highlighting...</p>
        <style>{`
          .syntax-loading {
            padding: 2rem;
            text-align: center;
            color: #666;
            font-style: italic;
          }
        `}</style>
      </div>
    );
  }

  return (
    <Highlight
      theme={themes.github} // Clean light theme
      code={code}
      language={language}
    >
      {({ className, style, tokens, getLineProps, getTokenProps }) => (
        <div className="syntax-highlighter">
          <pre className={className} style={style}>
            {displayLineNumbers && (
              <div className="syntax-line-numbers">
                {tokens.map((line, i) => (
                  <div
                    key={i}
                    className={`syntax-line-number ${
                      highlightLines.includes(i + 1) ? 'highlighted' : ''
                    }`}
                  >
                    {i + 1}
                  </div>
                ))}
              </div>
            )}
            <div className="syntax-code-lines">
              {tokens.map((line, i) => (
                <div
                  key={i}
                  {...getLineProps({ line })}
                  className={`syntax-code-line ${
                    highlightLines.includes(i + 1) ? 'highlighted' : ''
                  }`}
                >
                  {line.map((token, key) => (
                    <span key={key} {...getTokenProps({ token })} />
                  ))}
                </div>
              ))}
            </div>
          </pre>

          <style>{`
            .syntax-highlighter {
              height: 100%;
              overflow: auto;
            }

            .syntax-highlighter pre {
              display: flex;
              margin: 0;
              padding: 0;
              font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
              font-size: 0.9rem;
              line-height: 1.6;
              min-height: 100%;
              overflow: visible;
            }

            .syntax-line-numbers {
              display: flex;
              flex-direction: column;
              background-color: #f6f8fa;
              color: #57606a;
              padding: 1rem 0.75rem;
              text-align: right;
              user-select: none;
              border-right: 1px solid #d0d7de;
              min-width: 3rem;
            }

            .syntax-line-number {
              height: 1.6em;
            }

            .syntax-line-number.highlighted {
              background-color: #fff8c5;
              color: #24292f;
              font-weight: 600;
            }

            .syntax-code-lines {
              flex: 1;
              padding: 1rem;
            }

            .syntax-code-line {
              height: 1.6em;
            }

            .syntax-code-line.highlighted {
              background-color: #fff8c5;
              display: block;
              margin-left: -1rem;
              margin-right: -1rem;
              padding-left: 1rem;
              padding-right: 1rem;
            }
          `}</style>
        </div>
      )}
    </Highlight>
  );
};
```

**Component features:**
1. Uses prism-react-renderer with GitHub light theme
2. Async rendering for files >1000 lines (prevents UI blocking)
3. Line numbers with proper alignment
4. Optional line highlighting (for future error highlighting)
5. Fallback loading state for large files
6. Supports both C++ and C languages

**Verify**:
- Component renders with syntax highlighting
- Line numbers align with code
- Async loading works for large files (>1000 lines)
- Theme colors are readable
- No TypeScript errors

**Done**: ✅ SyntaxHighlighter component created

---

### Task 3: Integrate Syntax Highlighting into FileContentDisplay
**Type**: update
**Files**: `src/components/playground/wizard/FileContentDisplay.tsx`

**Action**:
Update FileContentDisplay to use SyntaxHighlighter when available:

```typescript
import React from 'react';
import { SyntaxHighlighter } from './SyntaxHighlighter';

export interface FileContentDisplayProps {
  content: string;
  filename?: string;
  language?: 'cpp' | 'c';
  lineNumbers?: boolean;
  emptyMessage?: string;
  enableSyntaxHighlighting?: boolean; // NEW: toggle syntax highlighting
}

export const FileContentDisplay: React.FC<FileContentDisplayProps> = ({
  content,
  filename,
  language = 'cpp',
  lineNumbers = true,
  emptyMessage = 'No file selected',
  enableSyntaxHighlighting = true, // NEW: enabled by default
}) => {
  // Split content into lines for plain text rendering
  const lines = React.useMemo(() => content.split('\n'), [content]);

  // Empty state (unchanged)
  if (!content || content.trim() === '') {
    return (
      <div className="file-content-empty">
        <p>{emptyMessage}</p>

        <style>{`
          .file-content-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 0.95rem;
            font-style: italic;
          }
        `}</style>
      </div>
    );
  }

  return (
    <div className="file-content-display">
      {/* Header with filename (unchanged) */}
      {filename && (
        <div className="file-content-header">
          <span className="file-content-filename">{filename}</span>
          <span className="file-content-language">{language.toUpperCase()}</span>
        </div>
      )}

      {/* Content area - NEW: use SyntaxHighlighter if enabled */}
      <div className="file-content-wrapper">
        {enableSyntaxHighlighting ? (
          <SyntaxHighlighter
            code={content}
            language={language}
            lineNumbers={lineNumbers}
          />
        ) : (
          // Fallback: plain text rendering (old implementation)
          <pre className="file-content-code">
            {lineNumbers && (
              <div className="line-numbers">
                {lines.map((_, index) => (
                  <div key={index} className="line-number">
                    {index + 1}
                  </div>
                ))}
              </div>
            )}
            <div className="code-lines">
              <code>{content}</code>
            </div>
          </pre>
        )}
      </div>

      <style>{`
        .file-content-display {
          display: flex;
          flex-direction: column;
          height: 100%;
          background-color: #fafafa;
          border-radius: 4px;
          overflow: hidden;
        }

        .file-content-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 0.75rem 1rem;
          background-color: #f5f5f5;
          border-bottom: 1px solid #e0e0e0;
        }

        .file-content-filename {
          font-size: 0.9rem;
          font-weight: 600;
          color: #333;
        }

        .file-content-language {
          font-size: 0.75rem;
          font-weight: 600;
          color: #666;
          background-color: #e0e0e0;
          padding: 0.25rem 0.5rem;
          border-radius: 3px;
        }

        .file-content-wrapper {
          flex: 1;
          overflow: auto;
          background-color: #fff;
        }

        /* Plain text fallback styles (unchanged) */
        .file-content-code {
          display: flex;
          margin: 0;
          padding: 0;
          font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
          font-size: 0.9rem;
          line-height: 1.6;
          min-height: 100%;
        }

        .line-numbers {
          display: flex;
          flex-direction: column;
          background-color: #f5f5f5;
          color: #999;
          padding: 1rem 0.75rem;
          text-align: right;
          user-select: none;
          border-right: 1px solid #e0e0e0;
          min-width: 3rem;
        }

        .line-number {
          height: 1.6em;
        }

        .code-lines {
          flex: 1;
          padding: 1rem;
          overflow-x: auto;
        }

        .code-lines code {
          display: block;
          white-space: pre;
          font-family: inherit;
          font-size: inherit;
          line-height: inherit;
        }
      `}</style>
    </div>
  );
};
```

**Changes:**
1. Add `enableSyntaxHighlighting` prop (default: true)
2. Use SyntaxHighlighter when enabled
3. Keep plain text fallback for edge cases
4. Maintain all existing functionality
5. Backward compatible (existing code still works)

**Verify**:
- Syntax highlighting displays in FileContentDisplay
- Can toggle highlighting via prop
- Fallback to plain text works
- Line numbers still align correctly
- No TypeScript errors

**Done**: ✅ FileContentDisplay enhanced with syntax highlighting

---

### Task 4: Component Tests
**Type**: test
**Files**: `src/components/playground/wizard/SyntaxHighlighter.test.tsx`, update `FileContentDisplay.test.tsx`

**Action**:
Create tests for SyntaxHighlighter and update FileContentDisplay tests:

**SyntaxHighlighter.test.tsx**:
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import { SyntaxHighlighter } from './SyntaxHighlighter';

describe('SyntaxHighlighter', () => {
  it('renders code with syntax highlighting', () => {
    const code = 'int main() {\n  return 0;\n}';
    render(<SyntaxHighlighter code={code} language="cpp" />);

    expect(screen.getByText('int')).toBeInTheDocument();
    expect(screen.getByText('main')).toBeInTheDocument();
  });

  it('displays line numbers by default', () => {
    const code = 'line 1\nline 2\nline 3';
    render(<SyntaxHighlighter code={code} language="c" />);

    expect(screen.getByText('1')).toBeInTheDocument();
    expect(screen.getByText('2')).toBeInTheDocument();
    expect(screen.getByText('3')).toBeInTheDocument();
  });

  it('hides line numbers when disabled', () => {
    const code = 'int x = 0;';
    const { container } = render(
      <SyntaxHighlighter code={code} language="c" lineNumbers={false} />
    );

    expect(container.querySelector('.syntax-line-numbers')).not.toBeInTheDocument();
  });

  it('shows loading state for large files', async () => {
    // Create a file with >1000 lines
    const code = Array(1001).fill('int x = 0;').join('\n');
    render(<SyntaxHighlighter code={code} language="c" />);

    // Should show loading initially
    expect(screen.getByText(/Preparing syntax highlighting/i)).toBeInTheDocument();

    // Should render after async delay
    await waitFor(() => {
      expect(screen.queryByText(/Preparing syntax highlighting/i)).not.toBeInTheDocument();
    });
  });

  it('renders small files immediately', () => {
    const code = Array(500).fill('int x = 0;').join('\n');
    render(<SyntaxHighlighter code={code} language="c" />);

    // Should NOT show loading for small files
    expect(screen.queryByText(/Preparing syntax highlighting/i)).not.toBeInTheDocument();
  });

  it('supports C++ language', () => {
    const code = '#include <iostream>';
    render(<SyntaxHighlighter code={code} language="cpp" />);

    expect(screen.getByText('#include')).toBeInTheDocument();
  });

  it('supports C language', () => {
    const code = '#include <stdio.h>';
    render(<SyntaxHighlighter code={code} language="c" />);

    expect(screen.getByText('#include')).toBeInTheDocument();
  });

  it('highlights specific lines', () => {
    const code = 'line 1\nline 2\nline 3';
    const { container } = render(
      <SyntaxHighlighter code={code} language="c" highlightLines={[2]} />
    );

    const highlightedLines = container.querySelectorAll('.highlighted');
    expect(highlightedLines.length).toBeGreaterThan(0);
  });
});
```

**Update FileContentDisplay.test.tsx**:
```typescript
// Add new tests for syntax highlighting integration

it('uses syntax highlighting by default', () => {
  const code = 'int main() { return 0; }';
  render(<FileContentDisplay content={code} language="cpp" />);

  // Should render SyntaxHighlighter (check for syntax-highlighter class)
  expect(document.querySelector('.syntax-highlighter')).toBeInTheDocument();
});

it('disables syntax highlighting when prop is false', () => {
  const code = 'int main() { return 0; }';
  render(
    <FileContentDisplay
      content={code}
      language="cpp"
      enableSyntaxHighlighting={false}
    />
  );

  // Should use plain text rendering
  expect(document.querySelector('.syntax-highlighter')).not.toBeInTheDocument();
  expect(document.querySelector('.file-content-code')).toBeInTheDocument();
});
```

**Test coverage goals:**
- SyntaxHighlighter: rendering, line numbers, async loading, languages
- FileContentDisplay: syntax highlighting toggle, integration
- Target: >80% coverage

**Verify**:
- All tests pass
- Coverage report shows >80%
- Async loading test waits correctly
- No console errors during test run

**Done**: ✅ Tests updated and passing

---

### Task 5: Update DualPaneViewer (No Changes Needed)
**Type**: verify
**Files**: `src/components/playground/wizard/DualPaneViewer.tsx`

**Action**:
Verify DualPaneViewer automatically gets syntax highlighting (no code changes needed):

**Why no changes?**
- DualPaneViewer uses FileContentDisplay
- FileContentDisplay now has syntax highlighting by default
- Syntax highlighting automatically works in both panes
- No breaking changes to DualPaneViewer API

**Verify**:
- DualPaneViewer still renders correctly
- Both panes show syntax highlighting
- No TypeScript errors
- Tests still pass

**Done**: ✅ DualPaneViewer verified (no changes needed)

---

### Task 6: Export and Documentation
**Type**: update
**Files**: `src/components/playground/wizard/index.ts`

**Action**:
Add SyntaxHighlighter to barrel exports:

```typescript
// src/components/playground/wizard/index.ts

// ... existing exports ...

export { SyntaxHighlighter } from './SyntaxHighlighter';
export type { SyntaxHighlighterProps } from './SyntaxHighlighter';
```

**Documentation:**
Add JSDoc to SyntaxHighlighter:

```typescript
/**
 * SyntaxHighlighter - Async syntax highlighting for C++ and C code
 *
 * Uses prism-react-renderer for lightweight, fast syntax highlighting.
 * Automatically defers rendering for large files (>1000 lines) to prevent UI blocking.
 *
 * @example
 * ```tsx
 * <SyntaxHighlighter
 *   code={sourceCode}
 *   language="cpp"
 *   lineNumbers={true}
 * />
 * ```
 *
 * @example Highlight specific lines
 * ```tsx
 * <SyntaxHighlighter
 *   code={code}
 *   language="c"
 *   highlightLines={[5, 10, 15]}
 * />
 * ```
 */
```

**Verify**:
- Exports work correctly
- TypeScript autocomplete shows SyntaxHighlighter
- JSDoc appears in IDE tooltips

**Done**: ✅ Component exported and documented

---

### Task 7: Manual Testing in Browser
**Type**: manual test
**Files**: N/A (browser testing)

**Action**:
Test syntax highlighting with realistic C++ and C code examples:

**Test data:**
```typescript
const mockCppCode = `#include <iostream>
#include <vector>
#include <string>

// Main entry point
int main(int argc, char** argv) {
    std::vector<std::string> args(argv, argv + argc);

    for (const auto& arg : args) {
        std::cout << "Arg: " << arg << std::endl;
    }

    return 0;
}`;

const mockCCode = `#include <stdio.h>
#include <stdlib.h>

/* Main entry point */
int main(int argc, char** argv) {
    int i;

    for (i = 0; i < argc; i++) {
        printf("Arg: %s\\n", argv[i]);
    }

    return 0;
}`;
```

**Browser testing checklist:**
1. Start dev server: `npm run dev`
2. Navigate to playground → Step 4
3. Verify in browser:
   - ✅ Left pane shows C++ code with syntax highlighting
   - ✅ Right pane shows C code with syntax highlighting
   - ✅ Keywords colored correctly (int, return, for, etc.)
   - ✅ Comments styled differently (italic/gray)
   - ✅ Strings highlighted (iostream, stdio.h, etc.)
   - ✅ Preprocessor directives colored (#include)
   - ✅ Line numbers align with code
   - ✅ Colors are readable (not too bright/dark)
   - ✅ Theme matches GitHub light theme
   - ✅ Scrolling works smoothly
   - ✅ No console errors
   - ✅ No visual glitches

**Test with large file:**
4. Create mock file with >1000 lines
5. Verify:
   - ✅ Loading message appears briefly
   - ✅ Syntax highlighting renders after delay
   - ✅ No UI blocking (page stays responsive)
   - ✅ Scrolling works after rendering

**Performance checks:**
- ✅ Highlighting renders in <100ms for small files (<100 lines)
- ✅ Large files show loading state immediately
- ✅ No lag during scrolling
- ✅ Memory usage reasonable

**Verify**:
- All visual checks pass
- Syntax highlighting is readable and attractive
- No performance issues

**Done**: ✅ Manual browser testing complete

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm install` succeeds with prism-react-renderer
2. ✅ `npm run test` passes all tests (SyntaxHighlighter + updated FileContentDisplay)
3. ✅ `npm run build` succeeds without errors
4. ✅ `npm run dev` starts without errors
5. ✅ Navigate to http://localhost:4321/cpp-to-c-website/playground
6. ✅ Navigate to Step 4 in wizard
7. ✅ See dual-pane viewer with syntax-highlighted code
8. ✅ C++ code (left pane) has proper syntax colors
9. ✅ C code (right pane) has proper syntax colors
10. ✅ Line numbers align with highlighted code
11. ✅ Keywords, comments, strings highlighted correctly
12. ✅ Theme is clean and readable (GitHub light)
13. ✅ Large files show loading state then render
14. ✅ No TypeScript errors in IDE
15. ✅ No console errors in browser
16. ✅ Bundle size impact is minimal (~2kB for prism core)

---

## Success Criteria

- [x] prism-react-renderer installed and working
- [x] SyntaxHighlighter component created with async loading
- [x] Supports C++ and C languages
- [x] Uses GitHub light theme for readability
- [x] Async rendering for files >1000 lines prevents UI blocking
- [x] Line numbers align correctly with syntax-highlighted code
- [x] Optional line highlighting feature (for future error display)
- [x] FileContentDisplay integrated with syntax highlighting
- [x] enableSyntaxHighlighting prop allows toggle (default: true)
- [x] Plain text fallback works when highlighting disabled
- [x] DualPaneViewer automatically gets syntax highlighting in both panes
- [x] Unit tests pass with >80% coverage
- [x] Components follow existing patterns (React 19, TypeScript, CSS-in-JS)
- [x] Exports via barrel file
- [x] JSDoc documentation complete
- [x] Manual browser testing confirms good visual appearance
- [x] All existing tests still pass (no regressions)

---

## Output: SUMMARY.md

When this plan is complete, create `04-02-SUMMARY.md` with:

```markdown
# Phase 4, Plan 04-02: Syntax Highlighting - COMPLETE

**Status**: ✅ Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Installed prism-react-renderer (lightweight ~2kB core)
- Created SyntaxHighlighter component with async rendering
- Integrated syntax highlighting into FileContentDisplay
- Added support for C++ and C languages
- Implemented GitHub light theme for readability
- Added async loading for large files (>1000 lines)
- Created comprehensive unit tests for SyntaxHighlighter
- Updated FileContentDisplay tests for highlighting integration
- Exported SyntaxHighlighter with TypeScript types and JSDoc

## Files Changed

- `package.json` - Added prism-react-renderer dependency
- `src/components/playground/wizard/SyntaxHighlighter.tsx` - NEW (X lines)
- `src/components/playground/wizard/SyntaxHighlighter.test.tsx` - NEW (X lines)
- `src/components/playground/wizard/FileContentDisplay.tsx` - UPDATED (integrated syntax highlighting)
- `src/components/playground/wizard/FileContentDisplay.test.tsx` - UPDATED (new tests)
- `src/components/playground/wizard/index.ts` - Updated exports

## Tests

- Unit tests: X passing, 0 failing
- SyntaxHighlighter tests: X passing (async loading, languages, line numbers)
- FileContentDisplay tests: X passing (integration tests added)
- Coverage: X% (target: >80%)

## Verification

✅ All success criteria met
✅ No regressions in existing tests
✅ Syntax highlighting works beautifully in browser
✅ Async loading prevents UI blocking for large files
✅ DualPaneViewer automatically inherits highlighting in both panes
✅ Bundle size impact minimal (~2kB)

## Public Components Used

- **prism-react-renderer** (v2.4.1) - Lightweight syntax highlighter
  - ~2kB core size (350kB+ smaller than react-syntax-highlighter)
  - Built on PrismJS (battle-tested highlighting engine)
  - React 19 compatible
  - Supports C++ and C out of the box
  - GitHub light theme included

## Deviations from Plan

[None] OR [List any changes made during implementation]

## Next Steps

Ready for **04-03**: Results Step Integration
- Wire FileTreeView to show transpiled files
- Add file selection logic (click file → load in DualPaneViewer)
- Load source and transpiled content from wizard state
- Display file count and statistics
- Handle empty/error states

## Commits

- `[commit-hash]` feat(04-02): Add prism-react-renderer and SyntaxHighlighter component
- `[commit-hash]` feat(04-02): Integrate syntax highlighting into FileContentDisplay
- `[commit-hash]` test(04-02): Add tests for SyntaxHighlighter and update FileContentDisplay tests
- `[commit-hash]` docs(04-02): Export SyntaxHighlighter and add JSDoc
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/04-results-preview/04-02-PLAN.md`
