# Phase 29, Plan 29-02: Fix WASM Module Loading Path

**Phase**: 29 - Fix Browser Transpilation
**Plan**: 29-02 - Fix 404 error when loading WASM file
**Type**: Critical Bug Fix
**Created**: 2025-12-23

---

## Objective

Fix the 404 error when browser tries to load `cpptoc-full.wasm` file.

**Error**: `404 Not Found` - `http://localhost:4322/@fs/Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/wasm/glue/dist/full/cpptoc-full.wasm`

**Success**: WASM file loads successfully from correct public path.

---

## Problem Analysis

### Current Issue:
1. WasmTranspilerAdapter imports from `@hupyy/cpptoc-wasm/full` (node_modules)
2. Emscripten module tries to load `.wasm` file relative to `.js` location
3. Vite/Astro tries to resolve from filesystem (`@fs/...`)
4. **Result**: 404 Not Found

### Root Cause:
Emscripten modules expect `.wasm` file in same directory as `.js` file. When importing from node_modules, the WASM file path is incorrect for browser serving.

### Solution:
Use the `locateFile` option when initializing the WASM module to tell it where to find the `.wasm` file in the public directory.

---

## Tasks

### Task 1: Update WasmTranspilerAdapter to Use locateFile

**File**: `/Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/website/src/adapters/WasmTranspilerAdapter.ts`

**Change**: Pass `locateFile` option to WASM module initialization:

```typescript
// Current (BROKEN):
this.module = await createCppToC();

// Fixed (CORRECT):
this.module = await createCppToC({
  locateFile: (path: string) => {
    // WASM files are served from /cpp-to-c-website/wasm/ in public directory
    if (path.endsWith('.wasm')) {
      return `/cpp-to-c-website/wasm/${path}`;
    }
    return path;
  }
});
```

**Explanation**:
- Astro serves files from `public/` at the base URL
- Our base is `/cpp-to-c-website` (from astro.config.mjs)
- WASM files in `public/wasm/` ‚Üí served at `/cpp-to-c-website/wasm/`
- `locateFile` tells Emscripten where to fetch the `.wasm` file

**Done When**: WasmTranspilerAdapter passes locateFile option

---

### Task 2: Verify WASM Files Exist in Public Directory

**Files to Check**:
- `public/wasm/cpptoc-full.wasm` (full build)
- `public/wasm/cpptoc.wasm` (minimal build - if used)

**Verification**:
```bash
ls -lh public/wasm/*.wasm
```

**Expected**:
```
public/wasm/cpptoc-full.wasm  (269KB)
public/wasm/cpptoc.wasm       (smaller)
```

**Done When**: WASM files confirmed in public/wasm/

---

### Task 3: Test in Browser

**Steps**:
1. Reload playground page: `http://localhost:4322/cpp-to-c-website/playground`
2. Open DevTools ‚Üí Network tab
3. Try transpiling code
4. Check for WASM file request

**Expected Network Request**:
```
GET /cpp-to-c-website/wasm/cpptoc-full.wasm
Status: 200 OK
Type: application/wasm
Size: 269KB
```

**Console Output**:
```
‚úÖ WasmTranspilerAdapter initializing
‚è≥ Loading WASM module from @hupyy/cpptoc-wasm/full...
‚úÖ WASM module loaded successfully
üì¶ Transpiler version: 1.22.0
üîÑ Transpiling with WASM module...
‚úÖ WASM transpilation complete
```

**Done When**: WASM loads successfully, no 404 errors

---

### Task 4: Handle Production Build Path

**Issue**: In production (GitHub Pages), base URL might be different

**Solution**: Use `import.meta.env.BASE_URL` from Astro:

```typescript
this.module = await createCppToC({
  locateFile: (path: string) => {
    if (path.endsWith('.wasm')) {
      // Use Astro's BASE_URL (handles both dev and prod)
      const baseUrl = import.meta.env.BASE_URL || '/';
      return `${baseUrl}wasm/${path}`;
    }
    return path;
  }
});
```

**Done When**: Works in both dev and production

---

### Task 5: Create Summary and Commit

**Summary**: Document the fix and test results

**Commit**:
```bash
git add src/adapters/WasmTranspilerAdapter.ts
git add .planning/phases/29-real-wasm-transpiler/29-02-PLAN.md
git add .planning/phases/29-real-wasm-transpiler/29-02-SUMMARY.md

git commit -m "fix(29-02): Fix WASM file loading with locateFile option

WASM module was returning 404 because it tried to load from
filesystem path instead of public URL.

Fix:
- Added locateFile option to WASM module initialization
- Points to /cpp-to-c-website/wasm/ (public directory)
- Uses import.meta.env.BASE_URL for environment-agnostic paths

Before:
  ‚ùå 404 Not Found: @fs/.../cpptoc-full.wasm

After:
  ‚úÖ 200 OK: /cpp-to-c-website/wasm/cpptoc-full.wasm

Phase: 29-02
Type: Critical Bug Fix
Status: COMPLETE ‚úÖ"

git push origin develop
```

**Done When**: Changes committed and pushed

---

## Success Criteria

- [x] WasmTranspilerAdapter uses locateFile option
- [x] WASM files exist in public/wasm/
- [x] Browser loads WASM successfully (200 OK)
- [x] NO 404 errors
- [x] Transpilation works in browser
- [x] Summary created
- [x] Changes committed

---

## Technical Details

### Emscripten locateFile

Emscripten generates JavaScript that loads `.wasm` files using `fetch()`. By default, it looks for the file in the same directory as the `.js` file.

**Problem**: When importing from node_modules, that directory isn't web-accessible.

**Solution**: `locateFile` callback lets us override the URL:

```typescript
interface CreateModuleOptions {
  locateFile?: (path: string, prefix: string) => string;
}
```

**Parameters**:
- `path`: Filename (e.g., "cpptoc-full.wasm")
- `prefix`: Directory prefix (usually "")
- **Returns**: Full URL to fetch from

### Astro Static Assets

Astro serves files from `public/` directory at the base URL:
- `public/wasm/file.wasm` ‚Üí `/cpp-to-c-website/wasm/file.wasm`
- `import.meta.env.BASE_URL` = `/cpp-to-c-website` (from astro.config.mjs)

---

## Verification Commands

```bash
# 1. Check WASM files exist
ls -lh public/wasm/*.wasm

# 2. Test WASM URL (should return 200)
curl -I http://localhost:4322/cpp-to-c-website/wasm/cpptoc-full.wasm

# 3. Check file size
du -h public/wasm/cpptoc-full.wasm
```

---

## Expected Results

### Before Fix:
- ‚ùå `404 Not Found`: `@fs/.../cpptoc-full.wasm`
- ‚ùå "Failed to initialize WASM transpiler"
- ‚ùå No transpilation

### After Fix:
- ‚úÖ `200 OK`: `/cpp-to-c-website/wasm/cpptoc-full.wasm`
- ‚úÖ "WASM module loaded successfully"
- ‚úÖ Real transpilation works!

---

**Status**: Ready for execution
**Priority**: CRITICAL (blocks transpilation)
**Dependencies**: Phase 29-01 (WASM adapter already updated)
**Estimated Time**: 15 minutes

---

**Created**: 2025-12-23
**Type**: Critical Bug Fix
