# Phase 16-02: Header Compatibility Testing - C and C++ Headers

**Phase**: Runtime Integration Testing
**Plan**: 16-02 (Header Integration)
**Target**: Verify transpiled code works with both C and C++ standard library headers
**Current**: Headers only tested structurally, not at runtime
**Priority**: HIGH - Critical for WebAssembly on-demand header loading

---

## Objective

Systematically test that transpiled C code correctly integrates with:
1. **C standard library headers** (stdio.h, stdlib.h, string.h, etc.)
2. **C++ standard library headers used in source** (iostream, vector, string, etc.)
3. **User-defined headers** (custom .h files)
4. **Mixed C/C++ header scenarios** (common in real codebases)

**Why this matters**:
- WebAssembly scenario provides source but headers load on-demand
- Must verify transpiled code correctly declares functions from headers
- Current testing doesn't verify header compatibility at runtime
- Investigation revealed: "No actual header loading or resolution in WASM"

---

## Execution Context

<execution_context>
**Reference files**:
- `@tests/RuntimeIntegrationTest.cpp` - Runtime test framework (from 16-01)
- `@tests/helpers/RuntimeTestHarness.h` - Test harness API
- `@tests/HeaderSeparatorTest.cpp` - Current header testing patterns
- `@src/HeaderSeparator.cpp` - Header/implementation routing logic
- `@wasm/bindings/minimal.cpp` - WASM placeholder (header loading context)
</execution_context>

---

## Context

**Investigation Findings** (from Phase 16-01 research):

**Current Header Handling**:
- HeaderSeparator routes declarations to .h vs .c files
- No actual header resolution or loading mechanism
- System headers come from Clang's compilation database
- WebASM build uses placeholders (cannot bundle Clang/LLVM)

**WebAssembly Challenge**:
```
WASM Scenario:
1. User provides C++ source code (string)
2. Source uses #include <stdio.h>, #include <vector>, etc.
3. Headers NOT provided with source (must load on-demand)
4. Transpiler must know what's in headers to generate correct C code
5. Generated C code must compile with those headers

Current Gap: No mechanism for WASM to provide headers
```

**Testing Gap**:
- HeaderSeparatorTest only validates AST structure
- No runtime verification that generated C works with headers
- No testing of header-dependent functionality (printf, malloc, etc.)

**C Standard Library Headers** (must support):
- `stdio.h` - I/O functions (printf, scanf, fopen, etc.)
- `stdlib.h` - Memory, random, exit (malloc, free, rand, exit)
- `string.h` - String operations (strlen, strcpy, strcat, etc.)
- `math.h` - Math functions (sqrt, pow, sin, cos)
- `time.h` - Time functions (time, clock, difftime)
- `assert.h` - Assertions (assert macro)

**C++ Headers** (in source, transpiled to C equivalents):
- `<iostream>` → stdio.h (cout/cin → printf/scanf)
- `<vector>` → custom C arrays
- `<string>` → C strings (char*)
- `<algorithm>` → inline implementations

---

## Tasks

<tasks>

### Task 1: Create HeaderCompatibilityTest Fixture
<task type="auto">
**Action**: Create `tests/HeaderCompatibilityTest.cpp` extending RuntimeIntegrationTest

**Implementation**:
```cpp
class HeaderCompatibilityTest : public RuntimeIntegrationTest {
protected:
    // Helper: Test C header usage
    void assertCHeaderWorks(const std::string& header,
                           const std::string& test_code,
                           const std::string& expected_output = "") {
        std::string full_code = "#include <" + header + ">\n" + test_code;
        assertTranspiledRuns(full_code, expected_output);
    }

    // Helper: Test multiple headers together
    void assertHeaderCombinationWorks(
        const std::vector<std::string>& headers,
        const std::string& test_code,
        const std::string& expected_output = "") {

        std::string includes;
        for (const auto& h : headers) {
            includes += "#include <" + h + ">\n";
        }
        assertTranspiledRuns(includes + test_code, expected_output);
    }

    // Helper: Test custom header file
    void assertCustomHeaderWorks(
        const std::string& header_content,
        const std::string& impl_code,
        const std::string& expected_output = "") {

        // Write custom header to temp file
        std::string header_file = harness->createTempHeaderFile(header_content);

        // Transpile with custom include path
        std::vector<std::string> args = {
            "-I", std::filesystem::path(header_file).parent_path().string()
        };

        auto result = harness->transpileCompileExecute(impl_code, args);
        ASSERT_TRUE(result.success) << result.stderr_output;

        if (!expected_output.empty()) {
            EXPECT_EQ(result.stdout_output, expected_output);
        }
    }
};
```

**Files**:
- Create `tests/HeaderCompatibilityTest.cpp`
- Update `tests/CMakeLists.txt`

**Verify**:
```bash
cd /Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/build
make HeaderCompatibilityTest -j8
```

**Done when**:
- [ ] HeaderCompatibilityTest.cpp created
- [ ] Fixture compiles successfully
- [ ] Helper methods implemented
- [ ] Integrated with CTest
</task>

### Task 2: Test C Standard Library Headers (15 tests)
<task type="auto">
**Action**: Add comprehensive tests for C standard library headers

**Test Matrix**:

**1. stdio.h** (5 tests):
```cpp
TEST_F(HeaderCompatibilityTest, StdioH_Printf) {
    const char* code = R"(
        int main() { printf("Hello, %s!\n", "World"); return 0; }
    )";
    assertCHeaderWorks("stdio.h", code, "Hello, World!\n");
}

TEST_F(HeaderCompatibilityTest, StdioH_Sprintf) {
    const char* code = R"(
        int main() {
            char buf[100];
            sprintf(buf, "%d + %d = %d", 2, 3, 5);
            printf("%s\n", buf);
            return 0;
        }
    )";
    assertCHeaderWorks("stdio.h", code, "2 + 3 = 5\n");
}

TEST_F(HeaderCompatibilityTest, StdioH_FileOperations) {
    const char* code = R"(
        int main() {
            FILE* f = fopen("/tmp/test_header_file.txt", "w");
            if (f) {
                fprintf(f, "test content\n");
                fclose(f);
                printf("success\n");
            }
            return 0;
        }
    )";
    assertCHeaderWorks("stdio.h", code, "success\n");
}

TEST_F(HeaderCompatibilityTest, StdioH_Scanf) { /* ... */ }
TEST_F(HeaderCompatibilityTest, StdioH_Sscanf) { /* ... */ }
```

**2. stdlib.h** (4 tests):
```cpp
TEST_F(HeaderCompatibilityTest, StdlibH_Malloc) {
    const char* code = R"(
        int main() {
            int* p = (int*)malloc(sizeof(int) * 10);
            p[5] = 42;
            printf("%d\n", p[5]);
            free(p);
            return 0;
        }
    )";
    assertCHeaderWorks("stdlib.h", code, "42\n");
}

TEST_F(HeaderCompatibilityTest, StdlibH_Atoi) { /* ... */ }
TEST_F(HeaderCompatibilityTest, StdlibH_Rand) { /* ... */ }
TEST_F(HeaderCompatibilityTest, StdlibH_Exit) { /* ... */ }
```

**3. string.h** (3 tests):
```cpp
TEST_F(HeaderCompatibilityTest, StringH_Strlen) {
    const char* code = R"(
        int main() {
            printf("%zu\n", strlen("Hello"));
            return 0;
        }
    )";
    assertCHeaderWorks("string.h", code, "5\n");
}

TEST_F(HeaderCompatibilityTest, StringH_Strcpy) { /* ... */ }
TEST_F(HeaderCompatibilityTest, StringH_Strcat) { /* ... */ }
```

**4. math.h** (2 tests):
```cpp
TEST_F(HeaderCompatibilityTest, MathH_Sqrt) {
    const char* code = R"(
        #include <stdio.h>
        int main() {
            printf("%.0f\n", sqrt(16.0));
            return 0;
        }
    )";
    assertCHeaderWorks("math.h", code, "4\n");
}

TEST_F(HeaderCompatibilityTest, MathH_Pow) { /* ... */ }
```

**5. assert.h** (1 test):
```cpp
TEST_F(HeaderCompatibilityTest, AssertH_Assert) { /* ... */ }
```

**Files**:
- Update `tests/HeaderCompatibilityTest.cpp` with 15 tests

**Verify**:
```bash
cd /Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/build
ctest -R HeaderCompatibilityTest --verbose
```

**Done when**:
- [ ] All 15 C stdlib header tests implemented
- [ ] All tests pass
- [ ] Coverage includes most-used C stdlib functions
- [ ] Tests verify correct function signatures transpiled
</task>

### Task 3: Test Header Combinations and Custom Headers
<task type="auto">
**Action**: Test multi-header scenarios and user-defined headers

**Multi-Header Tests** (5 tests):
```cpp
TEST_F(HeaderCompatibilityTest, MultiHeader_StdioStdlib) {
    const char* code = R"(
        int main() {
            int* arr = (int*)malloc(sizeof(int) * 3);
            arr[0] = 1; arr[1] = 2; arr[2] = 3;
            for (int i = 0; i < 3; i++) {
                printf("%d ", arr[i]);
            }
            printf("\n");
            free(arr);
            return 0;
        }
    )";
    assertHeaderCombinationWorks({"stdio.h", "stdlib.h"}, code, "1 2 3 \n");
}

TEST_F(HeaderCompatibilityTest, MultiHeader_StdioString) { /* ... */ }
TEST_F(HeaderCompatibilityTest, MultiHeader_AllStdlib) { /* ... */ }
```

**Custom Header Tests** (3 tests):
```cpp
TEST_F(HeaderCompatibilityTest, CustomHeader_SimpleStruct) {
    const char* header = R"(
        #ifndef POINT_H
        #define POINT_H
        struct Point { int x; int y; };
        int distance(struct Point* p);
        #endif
    )";

    const char* impl = R"(
        #include "point.h"
        #include <stdio.h>
        #include <math.h>

        int distance(struct Point* p) {
            return (int)sqrt(p->x * p->x + p->y * p->y);
        }

        int main() {
            struct Point p = {3, 4};
            printf("%d\n", distance(&p));
            return 0;
        }
    )";

    assertCustomHeaderWorks(header, impl, "5\n");
}

TEST_F(HeaderCompatibilityTest, CustomHeader_FunctionDeclarations) { /* ... */ }
TEST_F(HeaderCompatibilityTest, CustomHeader_NestedIncludes) { /* ... */ }
```

**Files**:
- Update `tests/HeaderCompatibilityTest.cpp` with 8 more tests

**Verify**:
```bash
cd /Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/build
ctest -R HeaderCompatibilityTest::Custom -V
ctest -R HeaderCompatibilityTest::Multi -V
```

**Done when**:
- [ ] 5 multi-header tests pass
- [ ] 3 custom header tests pass
- [ ] Nested include scenarios work
- [ ] Include guards properly handled
</task>

</tasks>

---

## Verification

Before declaring Phase 16-02 complete, verify ALL of these:

- ✓ HeaderCompatibilityTest fixture compiles
- ✓ All 15 C stdlib header tests pass
- ✓ All 5 multi-header combination tests pass
- ✓ All 3 custom header tests pass
- ✓ stdio.h functions work (printf, scanf, fopen, etc.)
- ✓ stdlib.h functions work (malloc, free, atoi, etc.)
- ✓ string.h functions work (strlen, strcpy, strcat, etc.)
- ✓ math.h functions work (sqrt, pow, etc.)
- ✓ Include guards properly transpiled
- ✓ Nested includes handled correctly
- ✓ Custom headers compile and link
- ✓ Total: 23 header tests passing

---

## Success Criteria

- Comprehensive C standard library header coverage (15 tests)
- Multi-header integration tests (5 tests)
- Custom header support verified (3 tests)
- Foundation for WebAssembly header provisioning (Phase 16-04)
- All tests pass with gcc and clang
- Documentation of which headers are tested

---

## Deviations Allowed

**Auto-fix bugs**: If transpiler generates incorrect header declarations, document
**Auto-add missing critical**: If additional compiler flags needed for math.h, add `-lm`
**Auto-fix blockers**: If custom header temp file creation fails, use alternative approach
**Ask about architectural**: N/A
**Log enhancements**: If some headers not fully testable, log to ISSUES.md

All deviations documented in `16-02-SUMMARY.md`.

---

## Output

Create `16-02-SUMMARY.md` with:

```markdown
# Phase 16-02: Header Compatibility Testing - SUMMARY

**Status**: [COMPLETE/PARTIAL/FAILED]
**Date**: [timestamp]
**Duration**: [hours]

## Deliverables

- [ ] HeaderCompatibilityTest fixture
- [ ] 15 C stdlib header tests
- [ ] 5 multi-header tests
- [ ] 3 custom header tests
- [ ] Total: 23 tests passing

## Header Coverage

- stdio.h: X/5 tests passing
- stdlib.h: X/4 tests passing
- string.h: X/3 tests passing
- math.h: X/2 tests passing
- assert.h: X/1 test passing
- Multi-header: X/5 tests passing
- Custom headers: X/3 tests passing

## Issues Found

[Any header compatibility bugs]

## WebAssembly Implications

[Notes on header loading requirements for WASM]

## Next Steps

- Phase 16-03: Console application end-to-end tests
- Phase 16-04: WebAssembly header provisioning mechanism
```

---

**Prepared by**: Claude Sonnet 4.5 (create-plans skill)
**Execution**: Run with `/run-plan .planning/phases/16-runtime-integration-testing/16-02-PLAN.md`
