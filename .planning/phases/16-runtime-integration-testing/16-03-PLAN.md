# Phase 16-03: Console Application End-to-End Tests

**Phase**: Runtime Integration Testing
**Plan**: 16-03 (Real-World Applications)
**Target**: Verify complete console programs transpile, compile, and execute correctly
**Current**: No console application tests exist
**Priority**: HIGH - Real-world usage validation

---

## Objective

Test end-to-end transpilation of complete console applications including:
1. **Command-line argument handling** (argc, argv)
2. **File I/O operations** (reading/writing files)
3. **Standard input/output** (stdin, stdout, stderr)
4. **Exit codes** (error handling, return codes)
5. **Multi-file programs** (main + helper modules)

**Why this matters**:
- Current tests are isolated code snippets
- Real programs have complex interactions (files, args, I/O)
- WebAssembly scenario will run full programs, not snippets
- Validates transpiler for production use cases

---

## Execution Context

<execution_context>
**Reference files**:
- `@tests/RuntimeIntegrationTest.cpp` - Runtime test framework (from 16-01)
- `@tests/HeaderCompatibilityTest.cpp` - Header testing (from 16-02)
- `@tests/real-world/` - Existing real-world C++ projects
- `@examples/` - Example programs (if any exist)
</execution_context>

---

## Context

**Investigation Findings**:
- **No console app tests** exist in current suite
- Real-world tests (`tests/real-world/`) test C++ originals, not transpiled C
- ValidationTest has minimal I/O testing
- Gap: No verification of full program lifecycle

**Console Application Scenarios**:

**1. Simple CLI Tools**:
- File copier (read one file, write another)
- Text processor (read stdin, write stdout)
- Calculator (parse args, print result)

**2. Data Processing**:
- CSV parser (read file, process rows, write output)
- Log analyzer (read logs, compute stats, report)
- File merger (combine multiple files)

**3. Interactive Programs**:
- Menu-driven apps (user input loops)
- Configuration generators
- Report generators

**4. Error Handling**:
- Invalid arguments → error message + exit code
- Missing files → error + graceful exit
- Malformed input → error recovery

---

## Tasks

<tasks>

### Task 1: Create ConsoleAppTest Fixture
<task type="auto">
**Action**: Create `tests/ConsoleAppTest.cpp` extending RuntimeIntegrationTest

**Implementation**:
```cpp
class ConsoleAppTest : public RuntimeIntegrationTest {
protected:
    // Helper: Create test input file
    std::string createInputFile(const std::string& content) {
        return harness->createTempFile(content, ".txt");
    }

    // Helper: Read output file
    std::string readOutputFile(const std::string& path) {
        std::ifstream file(path);
        return std::string(std::istreambuf_iterator<char>(file),
                          std::istreambuf_iterator<char>());
    }

    // Helper: Test console app with args
    void assertConsoleAppWorks(
        const std::string& cpp_code,
        const std::vector<std::string>& args,
        const std::string& expected_stdout = "",
        int expected_exit_code = 0) {

        auto result = harness->transpileCompileExecute(cpp_code, {}, args);

        EXPECT_EQ(result.exit_code, expected_exit_code)
            << "Exit code mismatch";

        if (!expected_stdout.empty()) {
            EXPECT_EQ(result.stdout_output, expected_stdout)
                << "Output mismatch";
        }

        ASSERT_TRUE(result.success || expected_exit_code != 0)
            << "Execution failed:\n" << result.stderr_output;
    }

    // Helper: Test app with stdin
    void assertConsoleAppWithStdin(
        const std::string& cpp_code,
        const std::string& stdin_data,
        const std::string& expected_stdout,
        int expected_exit_code = 0) {

        auto result = harness->transpileCompileExecute(cpp_code, {}, {}, stdin_data);

        EXPECT_EQ(result.exit_code, expected_exit_code);
        EXPECT_EQ(result.stdout_output, expected_stdout);
    }
};
```

**Files**:
- Create `tests/ConsoleAppTest.cpp`
- Update `tests/CMakeLists.txt`

**Verify**:
```bash
cd /Users/alexanderfedin/Projects/hapyy/hupyy-cpp-to-c/build
make ConsoleAppTest -j8
```

**Done when**:
- [ ] ConsoleAppTest.cpp created
- [ ] Fixture compiles
- [ ] Helper methods implemented
- [ ] CTest integration complete
</task>

### Task 2: Command-Line Argument Tests (5 tests)
<task type="auto">
**Action**: Test argc/argv handling in transpiled programs

**Tests**:
```cpp
TEST_F(ConsoleAppTest, NoArguments) {
    const char* code = R"(
        #include <stdio.h>
        int main(int argc, char* argv[]) {
            printf("argc=%d\n", argc);
            return 0;
        }
    )";
    assertConsoleAppWorks(code, {}, "argc=1\n", 0);
}

TEST_F(ConsoleAppTest, SingleArgument) {
    const char* code = R"(
        #include <stdio.h>
        int main(int argc, char* argv[]) {
            if (argc > 1) {
                printf("arg1=%s\n", argv[1]);
            }
            return 0;
        }
    )";
    assertConsoleAppWorks(code, {"hello"}, "arg1=hello\n", 0);
}

TEST_F(ConsoleAppTest, MultipleArguments) {
    const char* code = R"(
        #include <stdio.h>
        int main(int argc, char* argv[]) {
            for (int i = 1; i < argc; i++) {
                printf("%s ", argv[i]);
            }
            printf("\n");
            return 0;
        }
    )";
    assertConsoleAppWorks(code, {"one", "two", "three"}, "one two three \n", 0);
}

TEST_F(ConsoleAppTest, InvalidArgumentHandling) {
    const char* code = R"(
        #include <stdio.h>
        #include <stdlib.h>
        int main(int argc, char* argv[]) {
            if (argc < 2) {
                fprintf(stderr, "Error: missing argument\n");
                return 1;
            }
            printf("arg=%s\n", argv[1]);
            return 0;
        }
    )";
    auto result = harness->transpileCompileExecute(code, {}, {});
    EXPECT_EQ(result.exit_code, 1);
    EXPECT_NE(result.stderr_output.find("Error: missing argument"), std::string::npos);
}

TEST_F(ConsoleAppTest, NumericArgumentParsing) {
    const char* code = R"(
        #include <stdio.h>
        #include <stdlib.h>
        int main(int argc, char* argv[]) {
            if (argc != 3) return 1;
            int a = atoi(argv[1]);
            int b = atoi(argv[2]);
            printf("%d\n", a + b);
            return 0;
        }
    )";
    assertConsoleAppWorks(code, {"10", "32"}, "42\n", 0);
}
```

**Files**:
- Update `tests/ConsoleAppTest.cpp` with 5 tests

**Verify**:
```bash
ctest -R ConsoleAppTest -V
```

**Done when**:
- [ ] All 5 argument handling tests pass
- [ ] argc/argv correctly transpiled
- [ ] Exit codes work correctly
- [ ] stderr vs stdout separation works
</task>

### Task 3: File I/O and Real-World Application Tests (8 tests)
<task type="auto">
**Action**: Test complete programs with file operations and complex logic

**File I/O Tests** (3 tests):
```cpp
TEST_F(ConsoleAppTest, FileCopy) {
    const char* code = R"(
        #include <stdio.h>
        int main(int argc, char* argv[]) {
            if (argc != 3) return 1;

            FILE* in = fopen(argv[1], "r");
            FILE* out = fopen(argv[2], "w");

            if (!in || !out) return 2;

            char buf[1024];
            while (fgets(buf, sizeof(buf), in)) {
                fputs(buf, out);
            }

            fclose(in);
            fclose(out);
            printf("Copied successfully\n");
            return 0;
        }
    )";

    std::string input = createInputFile("line1\nline2\nline3\n");
    std::string output = harness->getTempPath("output.txt");

    assertConsoleAppWorks(code, {input, output}, "Copied successfully\n", 0);

    std::string result = readOutputFile(output);
    EXPECT_EQ(result, "line1\nline2\nline3\n");
}

TEST_F(ConsoleAppTest, LineCounter) {
    const char* code = R"(
        #include <stdio.h>
        int main(int argc, char* argv[]) {
            if (argc != 2) return 1;
            FILE* f = fopen(argv[1], "r");
            if (!f) return 2;

            int lines = 0;
            char buf[1024];
            while (fgets(buf, sizeof(buf), f)) {
                lines++;
            }
            fclose(f);

            printf("Lines: %d\n", lines);
            return 0;
        }
    )";

    std::string input = createInputFile("a\nb\nc\nd\ne\n");
    assertConsoleAppWorks(code, {input}, "Lines: 5\n", 0);
}

TEST_F(ConsoleAppTest, FileNotFoundError) { /* ... */ }
```

**Real-World App Tests** (5 tests):
```cpp
TEST_F(ConsoleAppTest, WordCount) {
    // wc-like utility: count lines, words, characters
    const char* code = R"(
        #include <stdio.h>
        #include <ctype.h>
        int main(int argc, char* argv[]) {
            if (argc != 2) return 1;
            FILE* f = fopen(argv[1], "r");
            if (!f) return 2;

            int lines = 0, words = 0, chars = 0;
            int in_word = 0;
            int c;

            while ((c = fgetc(f)) != EOF) {
                chars++;
                if (c == '\n') lines++;
                if (isspace(c)) {
                    in_word = 0;
                } else if (!in_word) {
                    in_word = 1;
                    words++;
                }
            }

            fclose(f);
            printf("%d %d %d\n", lines, words, chars);
            return 0;
        }
    )";

    std::string input = createInputFile("hello world\ntest file\n");
    // 2 lines, 4 words, 23 chars
    assertConsoleAppWorks(code, {input}, "2 4 23\n", 0);
}

TEST_F(ConsoleAppTest, SimpleCalculator) {
    // Calculator: ./calc add 10 20 → 30
    /* ... */
}

TEST_F(ConsoleAppTest, CSVParser) {
    // Parse CSV, compute sum/average
    /* ... */
}

TEST_F(ConsoleAppTest, TextFilter) {
    // Read stdin, filter lines matching pattern, write stdout
    /* ... */
}

TEST_F(ConsoleAppTest, ConfigGenerator) {
    // Generate config file from template + args
    /* ... */
}
```

**Files**:
- Update `tests/ConsoleAppTest.cpp` with 8 more tests

**Verify**:
```bash
ctest -R ConsoleAppTest::File -V
ctest -R ConsoleAppTest::Word -V
ctest -R ConsoleAppTest::CSV -V
```

**Done when**:
- [ ] All 3 file I/O tests pass
- [ ] All 5 real-world app tests pass
- [ ] File reading/writing works correctly
- [ ] Complex logic (parsing, filtering) transpiles correctly
- [ ] Error handling (file not found) works
</task>

</tasks>

---

## Verification

Before declaring Phase 16-03 complete, verify ALL of these:

- ✓ ConsoleAppTest fixture compiles
- ✓ All 5 command-line argument tests pass
- ✓ All 3 file I/O tests pass
- ✓ All 5 real-world application tests pass
- ✓ argc/argv handling correct
- ✓ stdin/stdout/stderr separation works
- ✓ File operations (fopen, fgets, fputs, fclose) work
- ✓ Error handling (missing files, invalid args) correct
- ✓ Exit codes properly returned
- ✓ Multi-file programs supported (if applicable)
- ✓ Total: 13 console app tests passing

---

## Success Criteria

- Comprehensive command-line argument testing (5 tests)
- File I/O operation testing (3 tests)
- Real-world application scenarios (5 tests)
- Validation that transpiler handles complete programs
- Foundation for WebAssembly full-program execution
- All tests execute in < 10 seconds total

---

## Deviations Allowed

**Auto-fix bugs**: If transpiler generates invalid main signature, document
**Auto-add missing critical**: If file I/O requires additional flags, add them
**Auto-fix blockers**: If temp file paths cause issues, use alternative approach
**Ask about architectural**: N/A
**Log enhancements**: If some scenarios not fully testable, log to ISSUES.md

All deviations documented in `16-03-SUMMARY.md`.

---

## Output

Create `16-03-SUMMARY.md` with:

```markdown
# Phase 16-03: Console Application End-to-End Tests - SUMMARY

**Status**: [COMPLETE/PARTIAL/FAILED]
**Date**: [timestamp]
**Duration**: [hours]

## Deliverables

- [ ] ConsoleAppTest fixture
- [ ] 5 command-line argument tests
- [ ] 3 file I/O tests
- [ ] 5 real-world application tests
- [ ] Total: 13 tests passing

## Test Results

- Command-line args: X/5 passing
- File I/O: X/3 passing
- Real-world apps: X/5 passing
- Total execution time: Xms

## Real-World Scenarios Verified

- [ ] File copy utility
- [ ] Line counter
- [ ] Word count (wc)
- [ ] Calculator
- [ ] CSV parser
- [ ] Text filter
- [ ] Config generator

## Issues Found

[Any console app transpilation bugs]

## Next Steps

- Phase 16-04: WebAssembly header provisioning mechanism
```

---

**Prepared by**: Claude Sonnet 4.5 (create-plans skill)
**Execution**: Run with `/run-plan .planning/phases/16-runtime-integration-testing/16-03-PLAN.md`
