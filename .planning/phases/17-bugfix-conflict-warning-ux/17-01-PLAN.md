# Phase 17, Plan 17-01: Fix Conflict Warning UX

**Phase**: 17 - Bugfix: Conflict Warning UX
**Plan**: 17-01 - Replace buttons with checkbox, remove redundant handler
**Scope**: Fix Step 2 conflict warning to use checkbox instead of buttons and remove non-functional "Choose Different Directory" button
**Estimate**: 30-45 minutes

---

## Objective

Fix the conflict warning UX issues identified in 5 Whys analysis:
1. **Remove redundant button**: "Choose Different Directory" button is redundant - "Change Target Directory" already exists
2. **Replace "Proceed Anyway" with checkbox**: Since proceeding happens on "Next" button click, this should be a boolean acknowledgment checkbox, not an action button
3. **Fix non-functional handler**: The `onCancel` handler in `Step2TargetSelection.tsx` is empty and does nothing

**Why**: Violates SOLID/DRY/KISS/YAGNI principles - redundant buttons, wrong UX pattern for acknowledgment, incomplete implementation

---

## Execution Context

**Files to load before starting:**
- `@src/components/playground/wizard/ConflictWarning.tsx` - Component with buttons to replace
- `@src/components/playground/wizard/ConflictWarning.test.tsx` - Tests to update
- `@src/components/playground/wizard/Step2TargetSelection.tsx` - Parent component with handler
- `@src/components/playground/wizard/types.ts` - Type definitions (if needed)

---

## Context

**Current implementation:**
- `ConflictWarning.tsx` shows two buttons: "Proceed Anyway" and "Choose Different Directory"
- `Step2TargetSelection.tsx` has `handleProceedWithConflicts()` that sets `userAcknowledgedConflicts` boolean flag
- `Step2TargetSelection.tsx` has empty `handleCancelConflicts()` that does nothing
- The "Next" button is controlled by `canProceed` boolean that checks the `userAcknowledgedConflicts` flag

**Root cause (from 5 Whys analysis):**
1. Wrong UX pattern - using modal-style buttons for what should be a simple acknowledgment checkbox
2. Incomplete implementation - cancel handler was scaffolded but never finished
3. Redundancy - "Choose Different Directory" duplicates existing "Change Target Directory" button

**Correct pattern:**
- Checkbox for user acknowledgment: "I understand that X files will be overwritten"
- Checkbox state controls whether "Next" button is enabled
- No action buttons needed - acknowledgment is passive, action happens on "Next"

---

## Tasks

### Task 1: Update ConflictWarning Tests (TDD)
**Type**: update
**Files**: `src/components/playground/wizard/ConflictWarning.test.tsx`

**Action**:
Update tests to reflect new checkbox-based API:

1. **Update prop interface tests**: Remove `onProceed` and `onCancel` tests, add `acknowledged` and `onAcknowledgeChange` tests

2. **Replace button tests with checkbox tests**:
```typescript
it('shows acknowledgment checkbox when conflicts exist', () => {
  const conflicts: FileConflict[] = [
    { sourcePath: 'main.cpp', targetFileName: 'main.c', exists: true }
  ];

  render(
    <ConflictWarning
      conflicts={conflicts}
      totalFiles={1}
      acknowledged={false}
      onAcknowledgeChange={vi.fn()}
    />
  );

  const checkbox = screen.getByRole('checkbox');
  expect(checkbox).toBeInTheDocument();
  expect(checkbox).not.toBeChecked();
  expect(screen.getByText(/I understand that 1 file will be overwritten/)).toBeInTheDocument();
});

it('calls onAcknowledgeChange when checkbox is toggled', () => {
  const handleChange = vi.fn();
  const conflicts: FileConflict[] = [
    { sourcePath: 'main.cpp', targetFileName: 'main.c', exists: true }
  ];

  render(
    <ConflictWarning
      conflicts={conflicts}
      totalFiles={1}
      acknowledged={false}
      onAcknowledgeChange={handleChange}
    />
  );

  const checkbox = screen.getByRole('checkbox');
  fireEvent.click(checkbox);

  expect(handleChange).toHaveBeenCalledTimes(1);
  expect(handleChange).toHaveBeenCalledWith(true);
});

it('checkbox reflects acknowledged state', () => {
  const conflicts: FileConflict[] = [
    { sourcePath: 'main.cpp', targetFileName: 'main.c', exists: true }
  ];

  const { rerender } = render(
    <ConflictWarning
      conflicts={conflicts}
      totalFiles={1}
      acknowledged={false}
      onAcknowledgeChange={vi.fn()}
    />
  );

  let checkbox = screen.getByRole('checkbox');
  expect(checkbox).not.toBeChecked();

  rerender(
    <ConflictWarning
      conflicts={conflicts}
      totalFiles={1}
      acknowledged={true}
      onAcknowledgeChange={vi.fn()}
    />
  );

  checkbox = screen.getByRole('checkbox');
  expect(checkbox).toBeChecked();
});

it('uses plural form for multiple files', () => {
  const conflicts: FileConflict[] = [
    { sourcePath: 'a.cpp', targetFileName: 'a.c', exists: true },
    { sourcePath: 'b.cpp', targetFileName: 'b.c', exists: true }
  ];

  render(
    <ConflictWarning
      conflicts={conflicts}
      totalFiles={2}
      acknowledged={false}
      onAcknowledgeChange={vi.fn()}
    />
  );

  expect(screen.getByText(/I understand that 2 files will be overwritten/)).toBeInTheDocument();
});
```

3. **Remove obsolete tests**:
- Remove "calls onProceed when proceed button clicked" test
- Remove "calls onCancel when cancel button clicked" test
- Remove "does not show action buttons when no conflicts" test (still no buttons, but for different reason)

4. **Keep these existing tests** (should still pass):
- Success message tests (no conflicts case)
- Conflict detection and display tests
- Show/hide details toggle tests

**Verify**:
- Tests fail initially (component not updated yet)
- New checkbox tests exist for: rendering, state, change handler, singular/plural text
- Obsolete button tests removed
- Test file compiles without errors

**Done**: ✅ Tests updated following TDD approach

---

### Task 2: Update ConflictWarning Component
**Type**: update
**Files**: `src/components/playground/wizard/ConflictWarning.tsx`

**Action**:
Replace button-based UI with checkbox-based acknowledgment:

1. **Update props interface**:
```typescript
export interface ConflictWarningProps {
  conflicts: FileConflict[];
  totalFiles: number;
  acknowledged: boolean;
  onAcknowledgeChange: (acknowledged: boolean) => void;
}
```

2. **Update component implementation**:
```typescript
export const ConflictWarning: React.FC<ConflictWarningProps> = ({
  conflicts,
  totalFiles,
  acknowledged,
  onAcknowledgeChange
}) => {
  const [showDetails, setShowDetails] = useState(false);
  const conflictingFiles = conflicts.filter(c => c.exists);
  const conflictCount = conflictingFiles.length;

  // Success case (no changes needed)
  if (conflictCount === 0) {
    return (
      <div className="conflict-warning success">
        {/* ... existing success UI ... */}
      </div>
    );
  }

  // Conflict case - use checkbox instead of buttons
  return (
    <div className="conflict-warning danger">
      <div className="warning-icon">⚠️</div>
      <div className="warning-content">
        <strong>File Conflicts Detected</strong>
        <p>
          {conflictCount} of {totalFiles} {conflictCount === 1 ? 'file' : 'files'} already {conflictCount === 1 ? 'exists' : 'exist'} in the target directory and will be overwritten.
        </p>

        {/* Show/Hide Details Toggle (unchanged) */}
        <button
          className="toggle-details"
          onClick={() => setShowDetails(!showDetails)}
        >
          {showDetails ? 'Hide' : 'Show'} conflicting files
        </button>

        {/* Conflict List (unchanged) */}
        {showDetails && (
          <div className="conflict-list">
            {/* ... existing list UI ... */}
          </div>
        )}

        {/* REPLACED: Action Buttons → Acknowledgment Checkbox */}
        <label className="acknowledgment-checkbox">
          <input
            type="checkbox"
            checked={acknowledged}
            onChange={(e) => onAcknowledgeChange(e.target.checked)}
          />
          <span>
            I understand that {conflictCount} {conflictCount === 1 ? 'file' : 'files'} will be overwritten
          </span>
        </label>
      </div>

      <style>{`
        /* ... existing styles ... */

        /* REMOVED: .conflict-actions, .proceed-button, .cancel-button */

        /* NEW: Acknowledgment checkbox styles */
        .acknowledgment-checkbox {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          margin-top: 1rem;
          padding: 0.75rem;
          background-color: rgba(255, 255, 255, 0.5);
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.15s;
        }

        .acknowledgment-checkbox:hover {
          background-color: rgba(255, 255, 255, 0.8);
        }

        .acknowledgment-checkbox input[type="checkbox"] {
          width: 1.25rem;
          height: 1.25rem;
          cursor: pointer;
          flex-shrink: 0;
        }

        .acknowledgment-checkbox span {
          color: #856404;
          font-size: 0.875rem;
          user-select: none;
        }
      `}</style>
    </div>
  );
};
```

**Verify**:
- Component compiles without TypeScript errors
- Props interface uses `acknowledged` and `onAcknowledgeChange`
- Buttons removed from render
- Checkbox renders with proper label
- Checkbox state is controlled by `acknowledged` prop
- onChange handler calls `onAcknowledgeChange` with boolean value
- Styles updated (removed button styles, added checkbox styles)

**Done**: ✅ ConflictWarning updated to checkbox pattern

---

### Task 3: Update Step2TargetSelection Component
**Type**: update
**Files**: `src/components/playground/wizard/Step2TargetSelection.tsx`

**Action**:
Update parent component to work with new checkbox-based ConflictWarning:

1. **Remove empty cancel handler**:
```typescript
// DELETE this function (lines 137-141):
const handleCancelConflicts = useCallback(() => {
  // Reset target directory selection
  setUserAcknowledgedConflicts(false);
  // User will need to select a different directory
}, []);
```

2. **Rename `handleProceedWithConflicts` to better reflect checkbox behavior**:
```typescript
const handleConflictAcknowledgment = useCallback((acknowledged: boolean) => {
  setUserAcknowledgedConflicts(acknowledged);
}, []);
```

3. **Update ConflictWarning usage** (around line 191-198):
```typescript
{conflictResult && !isScanning && (
  <ConflictWarning
    conflicts={conflictResult.conflicts}
    totalFiles={conflictResult.totalFiles}
    acknowledged={userAcknowledgedConflicts}
    onAcknowledgeChange={handleConflictAcknowledgment}
  />
)}
```

4. **Update navigation hint** (around line 234-237) to be clearer:
```typescript
{!canProceed && state.targetDir && (
  <div className="navigation-hint">
    {conflictResult && conflictResult.conflictCount > 0 && !userAcknowledgedConflicts && (
      <p>⚠️ Please acknowledge the file conflicts to proceed.</p>
    )}
    {!permissions.write && (
      <p>⚠️ Write permission required to proceed.</p>
    )}
  </div>
)}
```

**Verify**:
- Empty `handleCancelConflicts` function removed
- Handler renamed from `handleProceedWithConflicts` to `handleConflictAcknowledgment`
- Handler signature changed from `() => void` to `(acknowledged: boolean) => void`
- ConflictWarning props updated to use `acknowledged` and `onAcknowledgeChange`
- Navigation hint text unchanged (already says "acknowledge")
- TypeScript compiles without errors
- No unused imports

**Done**: ✅ Step2TargetSelection updated to work with checkbox

---

### Task 4: Update Step2TargetSelection Tests
**Type**: update
**Files**: `src/components/playground/wizard/Step2TargetSelection.test.tsx`

**Action**:
Update integration tests to work with new checkbox-based ConflictWarning:

1. **Find tests that interact with conflict warning buttons**:
   - Search for `Proceed Anyway`
   - Search for `Choose Different Directory`
   - Search for `onProceed` or `onCancel` mocks

2. **Update to use checkbox instead**:
```typescript
// BEFORE:
fireEvent.click(screen.getByText(/Proceed Anyway/));

// AFTER:
const checkbox = screen.getByRole('checkbox', { name: /I understand/i });
fireEvent.click(checkbox);
```

3. **If tests mock ConflictWarning component**, update mock props:
```typescript
// Update any mocks to use new props
vi.mock('./ConflictWarning', () => ({
  ConflictWarning: ({ acknowledged, onAcknowledgeChange }: any) => (
    <div>
      <input
        type="checkbox"
        checked={acknowledged}
        onChange={(e) => onAcknowledgeChange(e.target.checked)}
        aria-label="I understand that files will be overwritten"
      />
    </div>
  )
}));
```

4. **Verify test scenarios still cover**:
   - User can acknowledge conflicts via checkbox
   - "Next" button is disabled when conflicts exist and not acknowledged
   - "Next" button is enabled when conflicts exist and are acknowledged
   - No regressions in permission handling or directory selection

**Verify**:
- Tests compile without errors
- Tests use checkbox interaction instead of button clicks
- Test coverage maintained for conflict acknowledgment flow
- No references to removed `onProceed` or `onCancel` props

**Done**: ✅ Integration tests updated

---

### Task 5: Run All Tests
**Type**: verify
**Files**: N/A

**Action**:
```bash
npm run test -- ConflictWarning.test.tsx Step2TargetSelection.test.tsx --reporter=verbose
```

**Verify**:
- All ConflictWarning tests pass (✓)
- All Step2TargetSelection tests pass (✓)
- No test failures
- No TypeScript errors
- Test output shows checkbox-based interaction

**Done**: ✅ All tests passing

---

### Task 6: Manual Verification
**Type**: verify
**Files**: N/A

**Action**:
1. Run dev server: `npm run dev`
2. Navigate to playground
3. Complete Step 1 (select source directory)
4. Navigate to Step 2
5. Select target directory with existing files (to trigger conflicts)
6. Verify:
   - ✅ Conflict warning shows checkbox, not buttons
   - ✅ Checkbox label reads "I understand that X file(s) will be overwritten"
   - ✅ "Next" button is disabled when checkbox is unchecked
   - ✅ "Next" button is enabled when checkbox is checked
   - ✅ No "Choose Different Directory" button visible
   - ✅ "Change Target Directory" button still works (above conflict warning)
   - ✅ Checkbox state persists when toggling conflict details
   - ✅ Singular/plural text is correct (1 file vs 2 files)

**Done**: ✅ Manual verification complete

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm run test` passes all tests
2. ✅ `npm run build` completes without errors
3. ✅ TypeScript strict mode passes
4. ✅ ConflictWarning uses checkbox instead of buttons
5. ✅ Props interface updated: `acknowledged` + `onAcknowledgeChange`
6. ✅ Step2TargetSelection removes empty `handleCancelConflicts`
7. ✅ No redundant "Choose Different Directory" button
8. ✅ "Change Target Directory" button still present (not redundant)
9. ✅ Checkbox controls "Next" button enablement
10. ✅ Checkbox label has singular/plural forms
11. ✅ All tests updated to use checkbox instead of buttons
12. ✅ Manual testing confirms checkbox works correctly

---

## Success Criteria

- [x] "Proceed Anyway" button replaced with acknowledgment checkbox
- [x] "Choose Different Directory" button removed (redundant)
- [x] Empty `handleCancelConflicts` function removed
- [x] Checkbox controls `userAcknowledgedConflicts` state
- [x] "Next" button is gated by checkbox state
- [x] Singular/plural text in checkbox label
- [x] All tests updated and passing
- [x] No TypeScript errors
- [x] No DRY/KISS/YAGNI/SOLID violations
- [x] Manual testing confirms UX improvement

---

## Output: SUMMARY.md

When this plan is complete, create `17-01-SUMMARY.md` in the same directory with:
- Tasks completed
- Files modified
- Test results
- Manual verification results
- Any deviations from plan
- Commit hash

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/17-bugfix-conflict-warning-ux/17-01-PLAN.md`
