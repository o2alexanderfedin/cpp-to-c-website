# Phase 14-01: Fix ACSLStatementAnnotatorTest Exit Code 138

**Phase**: Bugfix - Critical Test Failure
**Target**: 100% test pass rate (171/171 tests)
**Current**: 99.4% (170/171 tests) - UNACCEPTABLE

## Objective

Fix the ACSLStatementAnnotatorTest exit code 138 (SIGBUS) failure that occurs during test cleanup/teardown. All 17 tests within the suite pass correctly, but the test executable crashes with exit code 138 after printing the summary, indicating a memory corruption or cleanup issue.

**Why this matters**: 99.4% is not 100%. Customer delivery requires zero failures. The exit code 138 suggests potential memory corruption that could manifest in production use of ACSL annotations.

## Context

@tests/ACSLStatementAnnotatorTest.cpp - Test file with 17 tests, all passing before crash
@src/ACSLStatementAnnotator.cpp - Implementation being tested
@include/ACSLStatementAnnotator.h - Header file

**Root Cause Hypothesis**:
The test uses `parseFunctionDecl()` helper that creates temporary `ASTUnit` objects:
```cpp
std::unique_ptr<ASTUnit> AST = tooling::buildASTFromCode(code);
```

Each test creates and destroys AST contexts. The exit code 138 (SIGBUS) occurring AFTER all tests pass suggests:
1. Dangling pointer access during cleanup
2. Double-free of AST resources
3. Memory corruption in global destructor
4. Static variable destruction order issue

## Tasks

### Task 1: Reproduce and Diagnose
**Type**: Investigation
**Files**: tests/ACSLStatementAnnotatorTest.cpp
**Action**:
1. Run test under lldb to get exact crash location:
   ```bash
   cd build
   lldb ./ACSLStatementAnnotatorTest
   run
   bt
   ```
2. Run test with AddressSanitizer to detect memory issues:
   ```bash
   cd build
   cmake -DCMAKE_CXX_FLAGS="-fsanitize=address -g" ..
   make ACSLStatementAnnotatorTest
   ./ACSLStatementAnnotatorTest
   ```
3. Run test with Valgrind for memory leak detection:
   ```bash
   valgrind --leak-check=full --track-origins=yes ./ACSLStatementAnnotatorTest
   ```
4. Document exact crash location and memory error type

**Verify**:
- Crash location identified (function, line number)
- Memory error type determined (use-after-free, double-free, etc.)
- Stack trace captured

**Done**: ☐

### Task 2: Fix Root Cause
**Type**: Code fix
**Files**: tests/ACSLStatementAnnotatorTest.cpp
**Action**:

Based on diagnosis, apply appropriate fix:

**Option A: Persistent AST Storage** (if dangling pointers detected)
```cpp
// Store AST units to prevent premature destruction
static std::vector<std::unique_ptr<ASTUnit>> persistentASTs;

FunctionDecl* parseFunctionDecl(const std::string& code, const std::string& funcName) {
    std::unique_ptr<ASTUnit> AST = tooling::buildASTFromCode(code);
    if (!AST) return nullptr;

    ASTContext& ctx = AST->getASTContext();
    TranslationUnitDecl* TU = ctx.getTranslationUnitDecl();

    FunctionDecl* result = nullptr;
    for (auto* decl : TU->decls()) {
        if (auto* func = dyn_cast<FunctionDecl>(decl)) {
            if (func->getNameAsString() == funcName) {
                result = func;
                break;
            }
        }
    }

    // Keep AST alive until program exit
    persistentASTs.push_back(std::move(AST));
    return result;
}
```

**Option B: Explicit Cleanup Order** (if static destruction order issue)
```cpp
// Add explicit cleanup before main() returns
int main() {
    // ... run all tests ...

    // Explicitly clean up in reverse order
    tests_passed = 0;
    tests_failed = 0;

    return (tests_failed == 0) ? 0 : 1;
}
```

**Option C: Remove Clang Memory Manager Issues** (if Clang-specific cleanup)
```cpp
// Use llvm::BumpPtrAllocator or disable cleanup
llvm::llvm_shutdown_obj Y;  // Add at top of main()
```

**Verify**:
- Fix applied based on diagnostic findings
- Code compiles without warnings
- Explanation documented in code comments

**Done**: ☐

### Task 3: Verify Fix
**Type**: Testing
**Files**: tests/ACSLStatementAnnotatorTest.cpp
**Action**:
1. Rebuild test executable:
   ```bash
   cd build
   make ACSLStatementAnnotatorTest -j4
   ```
2. Run test 10 times to ensure stability:
   ```bash
   for i in {1..10}; do
       echo "Run $i:"
       ./ACSLStatementAnnotatorTest || echo "FAILED on run $i"
   done
   ```
3. Verify exit code is 0:
   ```bash
   ./ACSLStatementAnnotatorTest
   echo "Exit code: $?"
   ```
4. Run full test suite to ensure no regressions:
   ```bash
   for test in *Test; do
       echo "Running $test..."
       ./$test || echo "FAILED: $test"
   done
   ```

**Verify**:
- ACSLStatementAnnotatorTest exits with code 0 (success)
- All 17 tests still pass
- No crashes in 10 consecutive runs
- No regressions in other test suites

**Done**: ☐

## Checkpoints

None - this is a focused bugfix with clear success criteria. Fix must be verified before proceeding.

## Verification

Before declaring complete, verify ALL of these:
- ✓ Crash diagnosed with lldb/AddressSanitizer/Valgrind
- ✓ Root cause identified and documented
- ✓ Fix applied and code compiles cleanly
- ✓ Test exits with code 0 (not 138)
- ✓ All 17 tests still pass
- ✓ 10 consecutive runs succeed without crashes
- ✓ Full test suite confirms 171/171 tests passing (100%)
- ✓ No memory leaks detected
- ✓ Fix documented with explanation

## Success Criteria

1. **Primary**: ACSLStatementAnnotatorTest exits with code 0
2. **Secondary**: All 171 tests across all 17 test suites pass (100% pass rate)
3. **Tertiary**: No memory errors detected by AddressSanitizer or Valgrind
4. **Documentation**: Root cause and fix clearly explained in code comments

## Output

Generate SUMMARY.md with:
```markdown
# Phase 14-01 Summary: ACSLStatementAnnotatorTest Bugfix

**Status**: COMPLETE
**Result**: 100% test pass rate achieved (171/171 tests)

## Root Cause

[Exact diagnosis from Task 1]

## Fix Applied

[Description of fix from Task 2]

## Verification Results

- Exit code: 0 (was 138)
- Test stability: 10/10 consecutive runs successful
- Full test suite: 171/171 passing (100%)
- Memory leaks: None detected
- Regressions: None

## Files Modified

- tests/ACSLStatementAnnotatorTest.cpp - [description of changes]

## Commit

[Commit hash and message]

## Production Status

✅ TRANSPILER NOW 100% TEST PASS RATE - READY FOR CUSTOMER DELIVERY
```

---

**Prepared by**: Claude Sonnet 4.5 (Autonomous Agent)
**Date**: 2024-12-20
**Execution**: Use `/run-plan .planning/phases/14-bugfix-acsl-test/14-01-PLAN.md`
