# Phase 27, Plan 27-04: Standard Library Headers Bundle

**Phase**: 27 - WASM VFS Integration
**Plan**: 27-04 - Bundle C++ Standard Library Headers
**Type**: Research + Implementation
**Created**: 2025-12-23

---

## Objective

Bundle minimal C++ standard library headers for WASM transpiler, enabling realistic C++ code without external dependencies.

**Success**: Can transpile C++ code using `<vector>`, `<algorithm>`, `<iostream>`, etc. in browser.

---

## Context

### Current State
- ‚úÖ VFS working (27-01)
- ‚úÖ Include paths working (27-02)
- ‚úÖ WASM bindings updated (27-03)
- ‚ùå No stdlib headers available in WASM

### The Problem
```cpp
#include <vector>    // ‚ùå Not found in WASM
#include <iostream>  // ‚ùå Not found
std::vector<int> v;  // ‚ùå Can't compile
```

Need to bundle headers as virtual files.

---

## Tasks

### Task 1: Research Minimal Header Set

**Action**: Identify essential C++ standard library headers
**Priority**: CRITICAL

**Research Questions**:
1. What headers are most commonly used in typical C++ code?
2. What's the minimal set for basic C++ features?
3. Which headers have minimal dependencies?
4. What's the total size of minimal header bundle?

**Common Headers** (priority order):
```
Core:
  <cstddef>, <cstdint>, <cstdlib>, <cstring>

Containers:
  <vector>, <array>, <string>

Algorithms:
  <algorithm>, <iterator>

Utilities:
  <utility>, <memory>, <type_traits>

I/O (optional, large):
  <iostream>, <sstream>
```

**Verification**:
- Document header dependencies
- Estimate total bundle size
- Identify size/feature tradeoffs

**Done When**: Minimal header list documented with sizes

---

### Task 2: Extract Headers from Clang Installation

**Action**: Copy headers from Clang's resource directory
**Priority**: CRITICAL

**Steps**:
```bash
# Find Clang resource directory
clang -print-resource-dir

# Typical location: /usr/local/lib/clang/XX.X.X/include

# Copy C++ standard library headers
# Location varies:
#   macOS: /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/usr/include/c++/v1
#   Linux: /usr/include/c++/<version>

# Create bundle directory
mkdir -p wasm/stdlib-headers

# Copy essential headers
cp -r /path/to/c++/headers wasm/stdlib-headers/
```

**Files to Extract**:
- C++ stdlib headers (`<vector>`, etc.)
- C standard library headers (`<stdio.h>`, etc.)
- Clang builtin headers (`<stddef.h>`, `<stdint.h>`)

**Verification**:
- All headers copied
- Dependencies included
- Total size measured

**Done When**: Headers extracted to wasm/stdlib-headers/

---

### Task 3: Create Header Bundle Script

**Action**: Script to convert headers to JSON/compressed format
**Priority**: HIGH

**File to Create**: `wasm/scripts/bundle-headers.js`

**Script**:
```javascript
#!/usr/bin/env node
const fs = require('fs');
const path = require('path');

const headersDir = path.join(__dirname, '../stdlib-headers');
const outputFile = path.join(__dirname, '../glue/dist/headers/stdlib-bundle.json');

function collectHeaders(dir, baseDir = dir) {
    const files = [];
    const entries = fs.readdirSync(dir, { withFileTypes: true });

    for (const entry of entries) {
        const fullPath = path.join(dir, entry.name);
        if (entry.isDirectory()) {
            files.push(...collectHeaders(fullPath, baseDir));
        } else {
            const relativePath = path.relative(baseDir, fullPath);
            const content = fs.readFileSync(fullPath, 'utf8');
            files.push({
                path: '/' + relativePath.replace(/\\/g, '/'),
                content
            });
        }
    }

    return files;
}

const headers = collectHeaders(headersDir);

fs.writeFileSync(outputFile, JSON.stringify(headers, null, 2));
console.log(`‚úÖ Bundled ${headers.length} headers`);
console.log(`üì¶ Size: ${(JSON.stringify(headers).length / 1024).toFixed(1)} KB`);
```

**Run**:
```bash
cd wasm
node scripts/bundle-headers.js
```

**Verification**:
- JSON bundle created
- All headers included
- Paths are correct (absolute)

**Done When**: Bundle script working, JSON generated

---

### Task 4: Create Header Loader for JavaScript

**Action**: JavaScript function to load stdlib headers into VFS
**Priority**: CRITICAL

**File to Create**: `wasm/glue/src/stdlib-loader.ts`

**Code**:
```typescript
import stdlibBundle from '../dist/headers/stdlib-bundle.json';

export interface VirtualFile {
    path: string;
    content: string;
}

/**
 * Load standard library headers for WASM transpiler
 *
 * @returns Array of virtual files for C++ stdlib
 */
export function loadStdLibHeaders(): VirtualFile[] {
    return stdlibBundle as VirtualFile[];
}

/**
 * Get include paths for standard library
 *
 * @returns Array of include directories
 */
export function getStdLibIncludePaths(): string[] {
    // Extract unique directories from header paths
    const dirs = new Set<string>();

    for (const file of stdlibBundle as VirtualFile[]) {
        const dir = file.path.substring(0, file.path.lastIndexOf('/'));
        if (dir) {
            dirs.add(dir);
        }
    }

    return Array.from(dirs);
}
```

**Verification**:
- Loader compiles
- Returns correct types
- Paths are absolute

**Done When**: Loader function working

---

### Task 5: Integrate with WASM Wrapper

**Action**: Update WASM wrapper to auto-load stdlib
**Priority**: HIGH

**File to Update**: `wasm/glue/src/index.ts`

**Code**:
```typescript
import createModule from '../dist/full/cpptoc.js';
import { loadStdLibHeaders, getStdLibIncludePaths } from './stdlib-loader';

export async function initializeTranspiler() {
    const Module = await createModule();
    const transpiler = new Module.Transpiler();

    // Load stdlib headers
    const stdlibHeaders = loadStdLibHeaders();
    const includePaths = getStdLibIncludePaths();

    return {
        transpiler,
        Module,
        stdlibHeaders,
        includePaths
    };
}

export { loadStdLibHeaders, getStdLibIncludePaths };
```

**Verification**:
- Initialization function works
- Headers loaded automatically
- Include paths extracted

**Done When**: Wrapper integrates stdlib loading

---

### Task 6: Test with Realistic C++ Code

**Action**: Create test with actual C++ stdlib usage
**Priority**: CRITICAL

**File to Create**: `wasm/test/test-stdlib.js`

**Test**:
```javascript
#!/usr/bin/env node
const { initializeTranspiler } = require('../glue/dist/index.js');

initializeTranspiler().then(({ transpiler, Module, stdlibHeaders, includePaths }) => {
    console.log(`Loaded ${stdlibHeaders.length} stdlib headers`);
    console.log(`Include paths: ${includePaths.join(', ')}`);

    // Create options with stdlib
    const options = new Module.TranspileOptions();

    // Add stdlib headers as virtual files
    const virtualFiles = new Module.VirtualFileVector();
    for (const header of stdlibHeaders) {
        const vf = new Module.VirtualFile();
        vf.path = header.path;
        vf.content = header.content;
        virtualFiles.push_back(vf);
    }
    options.virtualFiles = virtualFiles;

    // Add include paths
    const paths = new Module.StringVector();
    for (const path of includePaths) {
        paths.push_back(path);
    }
    options.includePaths = paths;

    // Test with vector
    const cpp = `
        #include <vector>
        int main() {
            std::vector<int> v;
            v.push_back(42);
            return v[0];
        }
    `;

    const result = transpiler.transpile(cpp, options);

    console.log('Success:', result.success);
    if (!result.success) {
        console.log('Diagnostics:', result.diagnostics.size());
        for (let i = 0; i < result.diagnostics.size(); i++) {
            const diag = result.diagnostics.get(i);
            console.log(`  ${diag.severity}: ${diag.message}`);
        }
    }

    if (result.success) {
        console.log('‚úÖ Test PASSED - C++ stdlib works!');
        process.exit(0);
    } else {
        console.log('‚ùå Test FAILED');
        process.exit(1);
    }
});
```

**Verification**:
- `<vector>` resolves
- Code transpiles successfully
- NO "file not found" errors

**Done When**: Stdlib test passes

---

### Task 7: Documentation & Summary

**File to Create**: `27-04-SUMMARY.md`

Document:
- Headers bundled (count, size)
- How to use stdlib with WASM
- Bundle generation process
- Test results

**Done When**: Summary complete

---

### Task 8: Commit Changes

```bash
git add wasm/stdlib-headers/
git add wasm/scripts/bundle-headers.js
git add wasm/glue/dist/headers/stdlib-bundle.json
git add wasm/glue/src/stdlib-loader.ts
git add wasm/glue/src/index.ts
git add wasm/test/test-stdlib.js
git add website/.planning/phases/27-wasm-vfs-integration/27-04-SUMMARY.md

git commit -m "feat(27-04): Bundle C++ standard library headers for WASM"
git push origin develop
```

---

## Success Criteria

- [ ] Minimal header set identified
- [ ] Headers extracted from Clang
- [ ] JSON bundle created
- [ ] Loader function working
- [ ] Stdlib test passes
- [ ] Documentation complete
- [ ] Committed and pushed

---

## Verification

```bash
# 1. Generate bundle
cd wasm
node scripts/bundle-headers.js

# 2. Build wrapper
cd glue
npm run build

# 3. Test stdlib
cd ..
node test/test-stdlib.js

# Expected: ‚úÖ Test PASSED
```

---

**Status**: üìã Plan Ready
**Dependencies**: 27-01 ‚úÖ, 27-02 ‚úÖ, 27-03 ‚úÖ
**Time Estimate**: 4-6 hours (includes research)
