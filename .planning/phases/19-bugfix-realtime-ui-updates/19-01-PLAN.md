# Phase 19, Plan 19-01: Fix Real-Time UI Updates During Transpilation

**Phase**: 19 - Bugfix: Real-time UI updates
**Plan**: 19-01 - Add progress/metrics to all transpilation events
**Type**: Bugfix
**Estimate**: 1 hour
**Created**: 2025-12-22

---

## Objective

Fix the Step 3 transpilation UI to update file tree status and metrics (elapsed time, speed, estimated remaining) in real-time as files are being transpiled.

**Why This Matters**:
- Users see "85 successful" but frozen metrics (0:00 elapsed, 0.0 files/sec, 0:00 remaining)
- File tree doesn't update to show which files completed/failed during execution
- Poor UX - looks like the app is frozen even though transpilation is running
- All the event infrastructure exists, just missing data in the events

**Success**: File tree updates in real-time, metrics update every file completion, users see live progress

---

## Context

### Current State (Broken)

**Screenshot shows**:
- ✅ Progress bar working (0 of 161 files 0%)
- ✅ Success count working (85 successful)
- ❌ Elapsed time: 0:00 (should be updating)
- ❌ Speed: 0.0 files/sec (should be updating)
- ❌ Estimated remaining: 0:00 (should be updating)
- ❌ File tree: Shows folders but no individual file status indicators

**Root Cause**:
```typescript
// TranspilationController.ts - LINE 323-328 (PARALLEL MODE)
this.emit({
  type: TranspilationEventType.FILE_COMPLETED,
  filePath,
  fileName: targetFileName,
  result
  // ❌ MISSING: progress, metrics
});

// LINE 367-371 (SEQUENTIAL MODE)
this.emit({
  type: TranspilationEventType.FILE_STARTED,
  filePath: file.path,
  fileName: file.name,
  progress: { ... }  // ✅ Has progress
  // ❌ MISSING: metrics
});
```

**Expected Behavior**:
Every FILE_* event should include:
1. `progress: { current, total, percentage }`
2. `metrics: { elapsedMs, filesPerSecond, estimatedRemainingMs }`

This data already exists in `this.completedFiles`, `this.startTime`, etc., just not being included in events.

### Architecture

```
TranspilationController
  ├── transpile() → fires events
  ├── transpileParallel() → FILE_COMPLETED events missing data
  ├── transpileSequential() → FILE_COMPLETED events missing data
  └── emit() → sends to useTranspilation hook
        ↓
useTranspilation hook
  ├── onProgress() → updates progress state ✅
  ├── onMetrics() → updates metrics state ✅
  └── Both called from event.progress/event.metrics
        ↓
Step3Transpilation component
  ├── Displays metrics (elapsed, speed, remaining)
  └── Passes fileStatuses to FileTreeView
```

**Problem**: Events missing `progress` and `metrics` properties → callbacks never called → UI never updates

---

## Tasks

### Task 1: Add Progress/Metrics Helper Methods
**Type**: Code Enhancement
**Action**: Add helper methods to calculate current progress and metrics
**Files**: `src/components/playground/wizard/controllers/TranspilationController.ts`

**Steps**:
1. Read TranspilationController (lines 1-450)
2. Add private method `getCurrentProgress()` that returns current/total/percentage
3. Add private method `getCurrentMetrics()` that calculates elapsed/speed/estimated
4. Use existing class properties: `startTime`, `completedFiles`, `totalPausedTime`, `sourceFiles.length`

**Example Implementation**:
```typescript
private getCurrentProgress() {
  const total = this.sourceFiles?.length ?? 0;
  const current = this.completedFiles;
  return {
    current,
    total,
    percentage: total > 0 ? (current / total) * 100 : 0
  };
}

private getCurrentMetrics() {
  const now = Date.now();
  const elapsedMs = now - this.startTime - this.totalPausedTime;
  const filesPerSecond = elapsedMs > 0
    ? (this.completedFiles / elapsedMs) * 1000
    : 0;
  const remaining = this.sourceFiles.length - this.completedFiles;
  const estimatedRemainingMs = filesPerSecond > 0
    ? (remaining / filesPerSecond) * 1000
    : 0;

  return {
    elapsedMs,
    filesPerSecond,
    estimatedRemainingMs
  };
}
```

**Verify**:
- ✅ TypeScript compiles without errors
- ✅ Helper methods are private
- ✅ Return types match event interface
- ✅ Edge cases handled (division by zero, etc.)

**Done When**: Helper methods added and compile cleanly

---

### Task 2: Update All Event Emissions
**Type**: Bugfix
**Action**: Add progress/metrics to all FILE_* event emissions
**Files**: `src/components/playground/wizard/controllers/TranspilationController.ts`

**Steps**:
1. Find all `this.emit()` calls for FILE_COMPLETED and FILE_ERROR
2. Update parallel mode emissions (around line 323-336):
   ```typescript
   this.emit({
     type: TranspilationEventType.FILE_COMPLETED,
     filePath,
     fileName: targetFileName,
     result,
     progress: this.getCurrentProgress(),    // ← ADD
     metrics: this.getCurrentMetrics()       // ← ADD
   });
   ```
3. Update sequential mode emissions (around line 413-432):
   - FILE_COMPLETED events
   - FILE_ERROR events
4. Verify FILE_STARTED events already have progress (keep existing)

**Locations to Update**:
- Line ~323-328: Parallel FILE_COMPLETED
- Line ~330-336: Parallel FILE_ERROR
- Line ~413-419: Sequential FILE_COMPLETED
- Line ~428-433: Sequential FILE_ERROR

**Verify**:
- ✅ All FILE_COMPLETED events include progress + metrics
- ✅ All FILE_ERROR events include progress + metrics
- ✅ TypeScript compiles without errors
- ✅ No duplicate metric calculations (use helper methods)

**Done When**: All 4 event locations updated, code compiles

---

### Task 3: Manual Verification in Browser
**Type**: Testing
**Action**: Test real-time updates during transpilation
**Files**: None (browser testing)

**Steps**:
1. Ensure dev server running (check /tmp/claude/tasks/b02b747.output)
2. Open: http://localhost:4321/cpp-to-c-website/playground
3. Select source directory with C++ files
4. Select target directory
5. Start transpilation
6. Observe during execution:
   - ✅ Elapsed time counts up (e.g., 0:01, 0:02, 0:03...)
   - ✅ Speed updates (e.g., 2.5 files/sec, 3.1 files/sec...)
   - ✅ Estimated remaining counts down
   - ✅ File tree shows individual files with status icons
   - ✅ Progress bar updates smoothly

**Expected Metrics Example** (for 161 files):
```
ELAPSED TIME: 0:08 (8 seconds)
SPEED: 20.1 files/sec
ESTIMATED REMAINING: 0:04 (4 seconds remaining)

Progress: 85 of 161 files (52%)
```

**Verify**:
- ✅ Metrics update every 1-2 seconds (as files complete)
- ✅ No frozen 0:00 values
- ✅ File tree updates in real-time
- ✅ Final metrics are accurate when complete

**Done When**: UI updates confirmed working in browser

---

### Task 4: Commit Fix
**Type**: Git
**Action**: Commit the working fix
**Files**: `TranspilationController.ts`

**Steps**:
1. Stage changes: `git add src/components/playground/wizard/controllers/TranspilationController.ts`
2. Commit with descriptive message
3. Reference Phase 19-01

**Commit Message**:
```
fix(19-01): Add real-time progress/metrics updates to transpilation events

Root cause: FILE_COMPLETED and FILE_ERROR events were missing progress
and metrics data, causing UI to freeze at 0:00 elapsed, 0.0 files/sec.

Solution:
- Added getCurrentProgress() helper to calculate current/total/percentage
- Added getCurrentMetrics() helper to calculate elapsed/speed/estimated
- Updated all FILE_* event emissions to include progress and metrics
- Both parallel and sequential modes now emit complete event data

Impact:
- File tree updates in real-time as files complete
- Elapsed time, speed, and estimated remaining update live
- Users see accurate progress during long transpilation runs

Fixes: Phase 19-01 - Real-time UI updates during transpilation
```

**Verify**:
- ✅ Commit created successfully
- ✅ Commit message is descriptive
- ✅ References Phase 19-01

**Done When**: Changes committed to git

---

## Verification

**Overall Success Criteria**:
- ✅ Helper methods added to calculate progress/metrics
- ✅ All FILE_COMPLETED events include progress/metrics
- ✅ All FILE_ERROR events include progress/metrics
- ✅ TypeScript compiles without errors
- ✅ Elapsed time updates in real-time (not frozen at 0:00)
- ✅ Speed updates in real-time (not frozen at 0.0 files/sec)
- ✅ Estimated remaining updates in real-time
- ✅ File tree shows individual file statuses during execution
- ✅ Changes committed to git

**Definition of Done**:
- Browser testing confirms metrics update live
- File tree updates as files complete
- No frozen UI during transpilation
- Commit created with detailed explanation

---

## Output

Create `19-01-SUMMARY.md` with:

### What Was Completed
- ✅ List each task with completion status
- ✅ Helper methods created
- ✅ Event emissions updated (4 locations)
- ✅ Browser verification results

### Code Changes
```diff
# src/components/playground/wizard/controllers/TranspilationController.ts

+ private getCurrentProgress() {
+   const total = this.sourceFiles?.length ?? 0;
+   const current = this.completedFiles;
+   return { current, total, percentage: total > 0 ? (current / total) * 100 : 0 };
+ }

+ private getCurrentMetrics() {
+   const now = Date.now();
+   const elapsedMs = now - this.startTime - this.totalPausedTime;
+   const filesPerSecond = elapsedMs > 0 ? (this.completedFiles / elapsedMs) * 1000 : 0;
+   const remaining = this.sourceFiles.length - this.completedFiles;
+   const estimatedRemainingMs = filesPerSecond > 0 ? (remaining / filesPerSecond) * 1000 : 0;
+   return { elapsedMs, filesPerSecond, estimatedRemainingMs };
+ }

  this.emit({
    type: TranspilationEventType.FILE_COMPLETED,
    filePath,
    fileName: targetFileName,
    result,
+   progress: this.getCurrentProgress(),
+   metrics: this.getCurrentMetrics()
  });
```

### Verification Results
**Before Fix**:
- ❌ Elapsed time: 0:00 (frozen)
- ❌ Speed: 0.0 files/sec (frozen)
- ❌ Estimated: 0:00 (frozen)
- ❌ File tree: No status indicators

**After Fix**:
- ✅ Elapsed time: Updates every file completion
- ✅ Speed: Live calculation (e.g., 18.5 files/sec)
- ✅ Estimated: Counts down accurately
- ✅ File tree: Shows success/error icons in real-time

### Commits
- Commit hash and message

### Impact
- Users see live progress during transpilation
- Better UX - no appearance of frozen app
- Accurate time estimates for large projects
- File tree provides visual feedback during execution

---

## Notes

### Why This Was Missed Initially

The original implementation correctly set up:
1. ✅ Event system (TranspilationController.emit())
2. ✅ Hook callbacks (useTranspilation onProgress/onMetrics)
3. ✅ UI state management (Step3Transpilation useState)
4. ✅ File counting (completedFiles tracker)

But forgot to:
❌ Include progress/metrics in FILE_* events

This is a classic "plumbing exists but not connected" bug.

### Future Enhancements

Could add to ISSUES.md:
- Throttle metric updates to 100ms intervals (reduce re-renders)
- Show per-file timing (slowest files, average time)
- Visual "pulse" animation on current file in tree
- Estimated completion time (absolute timestamp, not relative)

---

**Status**: ⬜ Not Started
**Next**: Execute this plan to fix real-time UI updates
