# Phase 15-01: GTest Setup & Real-World Test Migration

**Sub-Phase**: 15-01 of 4
**Target**: Set up Google Test infrastructure and migrate 252 real-world integration tests
**Effort**: 12-16 hours
**Risk**: LOW

## Objective

Establish Google Test (GTest) framework in the build system and migrate the 252 real-world integration tests as a proof-of-concept. These tests use a clean helper function pattern that maps directly to GTest assertions, making them ideal candidates for initial migration.

**Why start here**:
- Real-world tests have the cleanest, most consistent patterns (Variant C - helper functions)
- Low risk of test behavior changes
- Validates GTest infrastructure before tackling more complex tests
- Provides working examples for subsequent migrations

## Context

**Files to migrate** (5 test suites, 252 tests):
- `tests/real-world/json-parser/test_json_parser.cpp` (68 tests)
- `tests/real-world/resource-manager/test_resource_manager.cpp` (98 tests)
- `tests/real-world/logger/test_logger.cpp` (24 tests)
- `tests/real-world/string-formatter/test_string_formatter.cpp` (61 tests)
- `tests/real-world/test-framework/test_test_framework.cpp` (9 tests)

**Current Pattern** (Variant C - Helper Function):
```cpp
void test(const std::string& name, bool condition) {
    if (condition) {
        std::cout << "[PASS] " << name << std::endl;
    } else {
        std::cout << "[FAIL] " << name << std::endl;
        tests_failed++;
    }
}

// Usage
test("Parse null", value == nullptr);
test("Array size", array->size() == 3);
```

**Target Pattern** (GTest):
```cpp
TEST(JsonParserTest, ParseNull) {
    ASSERT_EQ(value, nullptr);
}

TEST(JsonParserTest, ArraySize) {
    ASSERT_EQ(array->size(), 3);
}
```

## Tasks

### Task 1: Set up Google Test Framework
**Type**: Build system configuration
**Files**: CMakeLists.txt, tests/real-world/*/CMakeLists.txt
**Action**:

1. Add Google Test to main CMakeLists.txt:
```cmake
# Option 1: FetchContent (recommended - no system dependency)
include(FetchContent)
FetchContent_Declare(
  googletest
  GIT_REPOSITORY https://github.com/google/googletest.git
  GIT_TAG v1.14.0  # Latest stable release
)
# For Windows: Prevent overriding the parent project's compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

# Option 2: Find installed GTest (alternative)
# find_package(GTest REQUIRED)
```

2. Enable CTest integration:
```cmake
enable_testing()
include(GoogleTest)
```

3. Update each real-world test CMakeLists.txt to link GTest:
```cmake
# Before
add_executable(test_json_parser test_json_parser.cpp)
target_include_directories(test_json_parser PRIVATE ${CMAKE_SOURCE_DIR}/include)

# After
add_executable(test_json_parser test_json_parser.cpp)
target_link_libraries(test_json_parser PRIVATE GTest::gtest GTest::gtest_main cpptoc_core)
target_include_directories(test_json_parser PRIVATE ${CMAKE_SOURCE_DIR}/include)
gtest_discover_tests(test_json_parser)
```

4. Build and verify GTest infrastructure:
```bash
cd build
cmake ..
make gtest gtest_main  # Verify GTest builds
```

**Verify**:
- GTest successfully fetched/found
- gtest and gtest_main libraries available
- CMake configuration completes without errors

**Done**: ✅

### Task 2: Migrate JSON Parser Tests (68 tests)
**Type**: Test migration
**Files**: tests/real-world/json-parser/test_json_parser.cpp
**Action**:

1. Create migration template:
```cpp
#include <gtest/gtest.h>
#include "json_parser.h"  // Existing includes

// Test fixture for common setup (if needed)
class JsonParserTest : public ::testing::Test {
protected:
    void SetUp() override {
        // Common setup code
    }

    void TearDown() override {
        // Common cleanup code
    }
};

// Migrate each test() call to TEST() or TEST_F()
TEST(JsonParserTest, ParseNull) {
    JSONValue* value = parseJSON("null");
    ASSERT_NE(value, nullptr);
    ASSERT_EQ(value->getType(), JSONType::Null);
}

// For tests needing shared setup, use TEST_F with fixture
TEST_F(JsonParserTest, ComplexObjectParsing) {
    // Uses fixture setup
    ASSERT_TRUE(parser->parse(complexJson));
}
```

2. Convert all 68 `test()` calls to `TEST()` macros:
   - `test("name", condition)` → `TEST(JsonParserTest, TestName) { ASSERT_TRUE(condition); }`
   - Use descriptive test names (CamelCase)
   - Replace boolean conditions with specific assertions:
     - `==` → `ASSERT_EQ(actual, expected)`
     - `!=` → `ASSERT_NE(actual, expected)`
     - `<` → `ASSERT_LT(actual, expected)`
     - Boolean → `ASSERT_TRUE()` / `ASSERT_FALSE()`
     - Pointer null → `ASSERT_EQ(ptr, nullptr)` or `ASSERT_NE(ptr, nullptr)`

3. Remove custom test infrastructure:
   - Delete `test()` helper function
   - Delete `tests_passed`, `tests_failed` counters
   - Delete manual test counting and summary code

4. Build and run tests:
```bash
cd build
make test_json_parser
./test_json_parser  # Should see GTest output
```

**Verify**:
- All 68 tests convert to TEST() macros
- Tests compile without errors
- All tests pass (same behavior as before)
- GTest output shows 68 tests passed

**Done**: ✅

### Task 3: Migrate Resource Manager Tests (98 tests)
**Type**: Test migration
**Files**: tests/real-world/resource-manager/test_resource_manager.cpp
**Action**:

Follow same pattern as Task 2:
1. Create test fixtures for shared resources (ResourceHandle, FileHandle, ResourcePool)
2. Convert all 98 `test()` calls to `TEST()` or `TEST_F()` macros
3. Group related tests into test suites (ResourceHandleTest, ScopeGuardTest, FileHandleTest, etc.)
4. Remove custom infrastructure
5. Build and verify

**Example fixture**:
```cpp
class ResourceHandleTest : public ::testing::Test {
protected:
    int* resource_ptr = nullptr;
    bool cleanup_called = false;

    void SetUp() override {
        resource_ptr = new int(42);
        cleanup_called = false;
    }

    void TearDown() override {
        // Cleanup if not already done by test
    }
};

TEST_F(ResourceHandleTest, CreateAndDestroy) {
    ResourceHandle<int> handle(resource_ptr, [&](int* ptr) {
        cleanup_called = true;
        delete ptr;
    });

    ASSERT_NE(handle.get(), nullptr);
    ASSERT_EQ(*handle, 42);
}
```

**Verify**:
- All 98 tests passing
- Fixtures used appropriately for shared setup
- Resource cleanup verified

**Done**: ✅

### Task 4: Migrate Logger Tests (24 tests)
**Type**: Test migration
**Files**: tests/real-world/logger/test_logger.cpp
**Action**:

1. Create test fixtures (ConsoleLoggerTest, FileLoggerTest, MultiLoggerTest)
2. Handle file I/O cleanup in fixtures (delete temp log files in TearDown)
3. Convert all 24 tests
4. Verify log file creation and content with GTest matchers

**Example**:
```cpp
class FileLoggerTest : public ::testing::Test {
protected:
    std::string log_filename = "test_log.txt";

    void TearDown() override {
        std::remove(log_filename.c_str());  // Clean up log file
    }
};

TEST_F(FileLoggerTest, LogToFile) {
    FileLogger logger(log_filename, LogLevel::Info);
    logger.log(LogLevel::Info, "TestLogger", "Test message");

    // Verify file exists and contains message
    std::ifstream file(log_filename);
    ASSERT_TRUE(file.is_open());

    std::string line;
    std::getline(file, line);
    EXPECT_TRUE(line.find("Test message") != std::string::npos);
}
```

**Verify**:
- All 24 tests passing
- Temporary files cleaned up
- No file I/O leaks

**Done**: ✅

### Task 5: Migrate String Formatter Tests (61 tests)
**Type**: Test migration
**Files**: tests/real-world/string-formatter/test_string_formatter.cpp
**Action**:

1. Create test suites by category (FormatterTest, StringBuilderTest, FormatStreamTest)
2. Convert all 61 tests
3. Use `EXPECT_STREQ()` for C-string comparisons
4. Use `EXPECT_EQ()` for std::string comparisons

**Example**:
```cpp
TEST(FormatterTest, FormatInteger) {
    Formatter fmt;
    EXPECT_EQ(fmt.format(42), "42");
}

TEST(FormatterTest, FormatDouble) {
    Formatter fmt;
    EXPECT_EQ(fmt.format(3.14, Precision(2)), "3.14");
}

TEST(StringBuilderTest, AppendMultipleTypes) {
    StringBuilder sb;
    sb << 42 << " " << 3.14 << " " << "test";
    EXPECT_EQ(sb.str(), "42 3.14 test");
}
```

**Verify**:
- All 61 tests passing
- String comparisons use appropriate matchers
- No memory leaks in string operations

**Done**: ✅

### Task 6: Migrate Test Framework Example Tests (9 tests)
**Type**: Test migration
**Files**: tests/real-world/test-framework/test_test_framework.cpp
**Action**:

1. Migrate simple math and string tests (9 tests)
2. Demonstrate GTest fixtures in example
3. Update as reference implementation for future test writing

**Verify**:
- All 9 tests passing
- Serves as good example for team

**Done**: ✅ (18 individual tests from 9 test suites, all passing)
**Migration Details**:
- 9 test suites migrated (BasicAssertions, PointerAssertions, ExceptionAssertions, MathFixture, String, Arithmetic, Float, Boolean, Container)
- 18 individual TEST/TEST_F cases created
- Demonstrated GTest fixtures with SetUp/TearDown
- Clean migration from custom TestFramework to Google Test
- CMakeLists.txt updated with FetchContent for Google Test v1.14.0
- All tests passing via both direct execution and CTest integration
- File serves as reference implementation with comprehensive comments

### Task 7: Update CMakeLists.txt for Test Discovery
**Type**: Build system update
**Files**: tests/real-world/*/CMakeLists.txt, main CMakeLists.txt
**Action**:

1. Add CTest integration to main CMakeLists.txt:
```cmake
enable_testing()

# Add subdirectories
add_subdirectory(tests/real-world/json-parser)
add_subdirectory(tests/real-world/resource-manager)
add_subdirectory(tests/real-world/logger)
add_subdirectory(tests/real-world/string-formatter)
add_subdirectory(tests/real-world/test-framework)
```

2. Each test CMakeLists.txt uses `gtest_discover_tests()`:
```cmake
gtest_discover_tests(test_json_parser
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    PROPERTIES LABELS "integration;real-world"
)
```

3. Verify test discovery:
```bash
cd build
cmake ..
ctest --show-only  # Should list all 252 tests
```

**Verify**:
- CTest discovers all 252 tests
- `make test` or `ctest` runs all tests
- Test labels applied for categorization

**Done**: ✅

### Task 8: Validate Migration Success
**Type**: Verification
**Action**:

1. Run all 252 tests via CTest:
```bash
cd build
ctest --output-on-failure --verbose
```

2. Verify 100% pass rate (252/252)

3. Compare execution time with original tests:
```bash
# Original (custom framework)
time ./test_json_parser

# GTest version
time ./test_json_parser
```

4. Check for memory leaks (should be none):
```bash
valgrind --leak-check=full ./test_json_parser
```

5. Generate GTest XML output:
```bash
./test_json_parser --gtest_output=xml:json_parser_results.xml
```

**Verify**:
- All 252 tests passing (100%)
- Execution time similar or better than original
- No memory leaks detected
- XML output generated successfully for CI/CD

**Done**: ✅

## Checkpoints

**Checkpoint 1** (after Task 1): GTest infrastructure working
- Can build and link GTest libraries
- Example "hello world" GTest compiles and runs

**Checkpoint 2** (after Tasks 2-6): All tests migrated
- 252 tests converted to GTest format
- All tests passing
- No custom framework code in migrated files

**Checkpoint 3** (after Task 7): CTest integration complete
- `make test` runs all 252 tests
- Test discovery working

## Verification

Before declaring 15-01 complete, verify ALL of these:
- ✓ GTest framework integrated into build system
- ✓ All 252 real-world tests migrated to GTest
- ✓ All 252 tests passing (100% pass rate)
- ✓ Custom framework code removed from real-world tests
- ✓ CTest discovers and runs all tests
- ✓ Test execution time documented (baseline for future comparison)
- ✓ No regressions in test behavior
- ✓ XML output generation works for CI/CD
- ✓ No memory leaks detected

## Success Criteria

- All 252 real-world tests use GTest (TEST/TEST_F macros)
- `make test` successfully runs all 252 tests
- 100% pass rate maintained post-migration
- GTest infrastructure ready for Phase 15-02 (core unit tests)

## Output

Generate summary at: `.planning/phases/15-test-migration-gtest/15-01-SUMMARY.md`

```markdown
# Phase 15-01 Summary: GTest Setup & Real-World Test Migration

**Status**: COMPLETE
**Result**: 252 tests successfully migrated to Google Test

## Accomplishments

1. **GTest Infrastructure**:
   - Google Test v1.14.0 integrated via CMake FetchContent
   - CTest enabled for test discovery and execution
   - All real-world test CMakeLists.txt updated

2. **Tests Migrated** (252 total):
   - JSON Parser: 68 tests ✅
   - Resource Manager: 98 tests ✅
   - Logger: 24 tests ✅
   - String Formatter: 61 tests ✅
   - Test Framework Example: 9 tests ✅

3. **Infrastructure**:
   - Test discovery via `gtest_discover_tests()`
   - XML output generation for CI/CD
   - Test categorization with labels

## Metrics

- **Execution Time**: [X] seconds (baseline: [Y] seconds)
- **Pass Rate**: 252/252 (100%)
- **Memory Leaks**: 0
- **Build Time**: [X] seconds (GTest compilation included)

## Next Steps

Proceed to Phase 15-02: Migrate macro-based core unit tests (300 tests)
```

---

**Prepared by**: Claude Sonnet 4.5
**Date**: 2025-12-20
**Execution**: `/run-plan .planning/phases/15-test-migration-gtest/15-01-PLAN.md`
