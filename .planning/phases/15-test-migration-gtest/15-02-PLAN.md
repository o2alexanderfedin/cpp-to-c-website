# Phase 15-02: Core Unit Tests Migration (Macro-Based)

**Sub-Phase**: 15-02 of 4
**Target**: Migrate 300 macro-based core unit tests to Google Test
**Effort**: 20-28 hours
**Risk**: MEDIUM

## Objective

Migrate the 300 core unit tests that use macro-based custom framework (Variant B) to Google Test. These tests use custom macros like `TEST_START`, `TEST_PASS`, `TEST_FAIL`, and `ASSERT` which need to be replaced with GTest equivalents.

**Why this phase**:
- Macro-based tests are moderately complex (custom macros, some fixtures)
- Tackle medium-complexity migration before hardest tests
- Build expertise before Phase 15-03 (inline-style tests)

## Context

**Files to migrate** (approximately 13-15 test suites, ~300 tests):
- Feature interaction tests (FeatureInteractionTest, FeatureCombinationTest)
- Lambda and operator tests (LambdaTranslatorTest, OperatorOverloadingTest)
- Move semantics tests (MoveSemanticTranslatorTest, MoveSemanticIntegrationTest)
- Template metaprogramming tests (TypeTraitsTest, MetaprogrammingTest)
- Edge cases and error handling (EdgeCasesTest, ErrorHandlingTest)

**Current Pattern** (Variant B - Macro-Based):
```cpp
#define TEST_START(name) std::cout << "Running " << name << "... ";
#define TEST_PASS(name) { std::cout << "✓" << std::endl; tests_passed++; }
#define TEST_FAIL(name, msg) { std::cout << "✗ FAILED: " << msg << std::endl; tests_failed++; }
#define ASSERT(expr, msg) if (!(expr)) { TEST_FAIL("", msg); return; }

void test_interaction_templates_exceptions() {
    TEST_START("test_interaction_templates_exceptions");

    auto AST = createAST(code);
    ASSERT(AST, "Failed to parse code");
    ASSERT(findException(AST), "Exception handling not found");

    TEST_PASS("test_interaction_templates_exceptions");
}
```

**Target Pattern** (GTest):
```cpp
TEST(FeatureInteractionTest, TemplatesWithExceptions) {
    auto AST = createAST(code);
    ASSERT_NE(AST, nullptr) << "Failed to parse code";
    ASSERT_TRUE(findException(AST)) << "Exception handling not found";
}
```

## Tasks

### Task 1: Analyze Test Structure and Extract Fixtures
**Type**: Analysis and refactoring
**Files**: All macro-based test files
**Action**:

1. Identify common setup patterns across tests:
   - Do tests share helper functions (e.g., `createAST`, `parseCode`)?
   - Are there repeated initialization sequences?
   - Is there cleanup code after tests?

2. Design GTest fixtures to capture shared setup:
```cpp
class TemplateTestFixture : public ::testing::Test {
protected:
    std::unique_ptr<ASTUnit> AST;
    ASTContext* ctx = nullptr;

    void SetUp() override {
        // Common setup code
    }

    void TearDown() override {
        // Cleanup
        AST.reset();
    }

    // Helper methods
    FunctionDecl* parseFunction(const std::string& code) {
        // ...
    }
};
```

3. Document fixture patterns to guide migration

**Verify**:
- Common setup identified for each test suite
- Fixtures designed (at least one per suite)
- Helper functions planned for migration

**Done**: ☐

### Task 2: Migrate LambdaTranslatorTest (60 tests)
**Type**: Test migration
**Files**: tests/LambdaTranslatorTest.cpp
**Action**:

1. Create LambdaTranslatorTest fixture:
```cpp
class LambdaTranslatorTest : public ::testing::Test {
protected:
    void SetUp() override {
        // Initialize AST parsing infrastructure
    }

    ASTUnitPtr parseCode(const std::string& code) {
        return tooling::buildASTFromCode(code);
    }

    FunctionDecl* findLambda(const ASTUnitPtr& AST) {
        // Helper to find lambda in AST
    }
};
```

2. Migrate all 60 tests:
   - Replace `TEST_START/PASS/FAIL` with `TEST_F(LambdaTranslatorTest, TestName)`
   - Replace `ASSERT(expr, msg)` with `ASSERT_TRUE(expr) << msg`
   - Use descriptive test names (e.g., `test_capture_by_value_single` → `CaptureByValueSingle`)

3. Group tests by category (Basic, Capture, Closure, Types, EdgeCases)

4. Build and verify:
```bash
make LambdaTranslatorTest
./LambdaTranslatorTest
```

**Verify**:
- All 60 tests passing
- Fixture reduces code duplication
- Test output clean and descriptive

**Done**: ☐

### Task 3: Migrate OperatorOverloadingTest (62 tests)
**Type**: Test migration
**Files**: tests/OperatorOverloadingTest.cpp
**Action**:

1. Create OperatorOverloadingTest fixture
2. Migrate all 62 tests grouped by operator category:
   - Arithmetic (15 tests)
   - Comparison (10 tests)
   - Subscript & Call (12 tests)
   - Special operators (12 tests)
   - Conversion operators (10 tests)
   - Stream operators (3 tests)

3. Build and verify

**Verify**:
- All 62 tests passing
- Operators categorized clearly

**Done**: ☐

### Task 4: Migrate Move Semantics Tests (~75 tests total)
**Type**: Test migration
**Files**:
- MoveSemanticTranslatorTest.cpp (50 tests)
- MoveConstructorTranslationTest.cpp (7 tests)
- MoveAssignmentTranslationTest.cpp (9 tests)
- StdMoveTranslationTest.cpp (10 tests)
- RvalueRefParameterTest.cpp (10 tests)
- MoveSemanticIntegrationTest.cpp (15 tests)

**Action**:

1. Create shared fixture for move semantics tests:
```cpp
class MoveSemanticTestFixture : public ::testing::Test {
protected:
    void SetUp() override {
        // Setup for C++11/14/17 move semantics testing
    }

    bool hasMoveConstructor(const CXXRecordDecl* cls) {
        // Helper to detect move constructor
    }

    bool hasMoveAssignment(const CXXRecordDecl* cls) {
        // Helper to detect move assignment
    }
};
```

2. Migrate each file to GTest
3. Build and verify all ~75 tests

**Verify**:
- All move semantics tests passing
- Consistent fixture usage

**Done**: ☐

### Task 5: Migrate Template Metaprogramming Tests (85 tests total)
**Type**: Test migration
**Files**:
- TypeTraitsTest.cpp (40 tests)
- MetaprogrammingTest.cpp (45 tests)

**Action**:

1. Create fixtures for type traits and metaprogramming
2. Migrate all 85 tests
3. Handle compile-time vs runtime assertions properly

**Example**:
```cpp
TEST(TypeTraitsTest, IsIntegral) {
    auto AST = parseCode("#include <type_traits>\n"
                         "static_assert(std::is_integral<int>::value);");
    ASSERT_NE(AST, nullptr);
    // Verify type trait detection in transpiled code
}
```

**Verify**:
- All 85 tests passing
- Compile-time checks handled correctly

**Done**: ☐

### Task 6: Migrate Feature Interaction Tests (60 tests total)
**Type**: Test migration
**Files**:
- FeatureInteractionTest.cpp (30 tests)
- FeatureCombinationTest.cpp (20 tests)
- EdgeCasesTest.cpp (30 tests)
- ErrorHandlingTest.cpp (25 tests)

**Action**:

1. Create fixtures for complex interaction scenarios
2. Migrate all tests with careful attention to:
   - Multi-feature interactions (templates + exceptions, RAII + inheritance)
   - Edge cases (empty inputs, maximum nesting, unusual types)
   - Error handling (invalid constructs, unsupported features)

3. Use `EXPECT_*` for non-fatal assertions where appropriate:
```cpp
TEST(FeatureInteractionTest, TemplatesWithExceptions) {
    auto AST = parseCode(complexCode);
    ASSERT_NE(AST, nullptr);

    EXPECT_TRUE(hasTemplates(AST));
    EXPECT_TRUE(hasExceptions(AST));
    EXPECT_TRUE(hasRAII(AST));
}
```

**Verify**:
- All interaction tests passing
- Edge cases covered
- Error handling tests validate expected failures

**Done**: ☐

### Task 7: Remove Custom Macro Definitions
**Type**: Cleanup
**Files**: All migrated test files
**Action**:

1. Search for and remove all custom macro definitions:
```bash
grep -r "define TEST_START" tests/ --include="*.cpp"
grep -r "define TEST_PASS" tests/ --include="*.cpp"
grep -r "define TEST_FAIL" tests/ --include="*.cpp"
grep -r "define ASSERT" tests/ --include="*.cpp"
```

2. Remove manual test counters:
```cpp
// DELETE these:
int tests_passed = 0;
int tests_failed = 0;
// DELETE summary printing code
```

3. Verify no custom macros remain:
```bash
grep -r "#define TEST_" tests/ --include="*.cpp" | wc -l  # Should be 0
```

**Verify**:
- No custom TEST_ macros in migrated files
- No manual test counting code
- Clean GTest-only implementation

**Done**: ☐

### Task 8: Update CMakeLists.txt for Core Tests
**Type**: Build system update
**Files**: tests/CMakeLists.txt
**Action**:

1. Update test linking to use GTest:
```cmake
# For each test file
add_executable(LambdaTranslatorTest tests/LambdaTranslatorTest.cpp)
target_link_libraries(LambdaTranslatorTest PRIVATE
    GTest::gtest
    GTest::gtest_main
    cpptoc_core
)
gtest_discover_tests(LambdaTranslatorTest
    PROPERTIES LABELS "core;lambda"
)
```

2. Add all migrated tests to CTest
3. Verify discovery:
```bash
ctest --show-only | grep -c "Test #"  # Should show all tests
```

**Verify**:
- All 300 tests discovered by CTest
- Tests properly labeled (core, unit, etc.)

**Done**: ☐

### Task 9: Validate Migration Success
**Type**: Verification
**Action**:

1. Run all 300 migrated tests:
```bash
ctest -L "core" --output-on-failure
```

2. Verify 100% pass rate

3. Check execution time:
```bash
ctest -L "core" --timeout 300  # Should complete well under 5 minutes
```

4. Memory leak check on representative tests:
```bash
valgrind --leak-check=full ./LambdaTranslatorTest
valgrind --leak-check=full ./OperatorOverloadingTest
```

5. Generate XML reports for CI/CD:
```bash
ctest -L "core" --output-junit core_tests.xml
```

**Verify**:
- All 300 tests passing (100%)
- No memory leaks
- XML output generated
- Execution time reasonable

**Done**: ☐

## Checkpoints

**Checkpoint 1** (after Task 1): Fixtures designed
- Common patterns identified
- Fixtures documented

**Checkpoint 2** (after Tasks 2-6): All tests migrated
- 300 tests converted to GTest
- All passing

**Checkpoint 3** (after Task 7-8): Cleanup complete
- No custom macros remaining
- CTest integration done

## Verification

Before declaring 15-02 complete, verify ALL of these:
- ✓ All 300 macro-based tests migrated to GTest
- ✓ All 300 tests passing (100% pass rate)
- ✓ Custom macro definitions removed
- ✓ GTest fixtures used appropriately
- ✓ CTest discovers all tests
- ✓ No memory leaks
- ✓ XML output working for CI/CD
- ✓ No regressions in test behavior

## Success Criteria

- All 300 macro-based tests use GTest (TEST/TEST_F)
- Fixtures reduce code duplication significantly
- `ctest -L "core"` runs all 300 tests successfully
- Ready for Phase 15-03 (inline-style tests)

## Output

Generate summary at: `.planning/phases/15-test-migration-gtest/15-02-SUMMARY.md`

---

**Prepared by**: Claude Sonnet 4.5
**Date**: 2025-12-20
**Execution**: `/run-plan .planning/phases/15-test-migration-gtest/15-02-PLAN.md`
