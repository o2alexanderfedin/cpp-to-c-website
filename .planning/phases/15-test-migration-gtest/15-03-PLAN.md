# Phase 15-03: Core Unit Tests Migration (Inline-Style)

**Sub-Phase**: 15-03 of 4
**Target**: Migrate 434 inline-style core unit tests to Google Test
**Effort**: 35-45 hours
**Risk**: MEDIUM-HIGH

## Objective

Migrate the remaining 434 core unit tests that use inline assertion style (Variant A) to Google Test. These tests have the most inconsistent patterns and will require the most refactoring (test splitting, fixture extraction, assertion improvement).

**Why this is most complex**:
- Tests often have multiple assertions per function (violates "one assertion per test" guideline)
- Minimal structure (no macros, just raw `assert()` + `std::cout`)
- Significant fixture extraction needed
- Tests must be split into smaller, focused test cases

## Context

**Files to migrate** (approximately 20-25 test suites, ~434 tests):
- ACSL annotation tests (ACSLStatementAnnotatorTest, ACSLClassAnnotatorTest, etc.)
- Transpilation phase tests (StandaloneFunctionTranslationTest, etc.)
- RTTI and exception tests (RTTIIntegrationTest, ExceptionIntegrationTest, etc.)
- Coroutine tests (CoroutineDetectorTest, CoroutineIntegrationTest, etc.)
- Virtual inheritance tests (VirtualBaseDetectionTest, VTTGeneratorTest, etc.)
- Runtime mode tests (RuntimeModeInlineTest, RuntimeModeLibraryTest, etc.)

**Current Pattern** (Variant A - Inline Assertions):
```cpp
void testSimpleClassPrimitiveMembers() {
    std::cout << "Test 1: Simple class with primitive members... ";

    const char* code = "class Point { int x; int y; };";
    auto AST = parseCode(code);
    assert(AST && "Failed to parse code");

    CXXRecordDecl* cls = findClass(AST, "Point");
    assert(cls && "Class not found");
    assert(cls->getNumFields() == 2 && "Expected 2 fields");

    std::cout << "PASSED\n";
}
```

**Target Pattern** (GTest - Split Tests):
```cpp
class ACSLClassAnnotatorTest : public ::testing::Test {
protected:
    std::unique_ptr<ASTUnit> AST;

    void SetUp() override {
        // Common setup
    }

    CXXRecordDecl* findClass(const std::string& name) {
        // Helper method
    }
};

TEST_F(ACSLClassAnnotatorTest, ParsesSimpleClass) {
    const char* code = "class Point { int x; int y; };";
    AST = parseCode(code);
    ASSERT_NE(AST, nullptr) << "Failed to parse code";
}

TEST_F(ACSLClassAnnotatorTest, FindsClassByName) {
    const char* code = "class Point { int x; int y; };";
    AST = parseCode(code);

    CXXRecordDecl* cls = findClass("Point");
    ASSERT_NE(cls, nullptr) << "Class 'Point' not found";
}

TEST_F(ACSLClassAnnotatorTest, CountsFieldsCorrectly) {
    const char* code = "class Point { int x; int y; };";
    AST = parseCode(code);

    CXXRecordDecl* cls = findClass("Point");
    ASSERT_EQ(cls->getNumFields(), 2) << "Expected exactly 2 fields";
}
```

## Tasks

### Task 1: Analyze and Categorize Inline-Style Tests
**Type**: Analysis
**Files**: All inline-style test files
**Action**:

1. Categorize by complexity:
   - **Simple** (1-2 assertions): Easy to migrate
   - **Medium** (3-5 assertions): Need test splitting
   - **Complex** (6+ assertions): Significant refactoring

2. Identify common setup patterns per test suite

3. Document splitting strategy:
   - One test should verify one behavior
   - Extract multi-assertion tests into multiple focused tests
   - Share setup via fixtures

**Verify**:
- Test complexity categorized
- Splitting strategy documented
- Fixtures planned

**Done**: ☐

### Task 2: Migrate ACSL Annotation Tests (~79 tests total)
**Type**: Test migration
**Files**:
- ACSLStatementAnnotatorTest.cpp (18 tests)
- ACSLBehaviorAnnotatorTest.cpp (15 tests)
- ACSLClassAnnotatorTest.cpp (10 tests)
- ACSLFunctionAnnotatorTest.cpp (15 tests)
- ACSLLoopAnnotatorTest.cpp (12 tests)
- ACSLMemoryPredicateAnalyzerTest.cpp (12 tests)
- ACSLGeneratorTest.cpp (7 tests)

**Action**:

1. Create shared ACSL fixture:
```cpp
class ACSLTestFixture : public ::testing::Test {
protected:
    std::unique_ptr<ASTUnit> AST;
    ASTContext* ctx = nullptr;

    void SetUp() override {
        // Initialize ACSL generator infrastructure
    }

    void TearDown() override {
        AST.reset();
    }

    ASTUnitPtr parseCode(const std::string& code) {
        return tooling::buildASTFromCodeWithArgs(code, clangArgs);
    }

    std::string generateACSL(const Decl* decl) {
        ACSLGenerator generator(ctx);
        return generator.generate(decl);
    }
};
```

2. Migrate each ACSL test file:
   - Split multi-assertion tests
   - Use fixtures for shared setup
   - Group related tests

3. Special attention to ACSLStatementAnnotatorTest (had exit code 138 issue - ensure proper cleanup)

**Verify**:
- All ~79 ACSL tests passing
- No memory leaks (especially ACSLStatementAnnotatorTest)
- Fixtures reduce duplication

**Done**: ☐

### Task 3: Migrate Transpilation Phase Tests (~65 tests total)
**Type**: Test migration
**Files**:
- StandaloneFunctionTranslationTest.cpp (15 tests)
- VirtualBaseDetectionTest.cpp (8 tests)
- VirtualBaseOffsetTableTest.cpp (8 tests)
- VTTGeneratorTest.cpp (8 tests)
- ConstructorSplitterTest.cpp (8 tests)
- HierarchyTraversalTest.cpp (8 tests)
- CrossCastTraversalTest.cpp (7 tests)
- DynamicCastCrossCastTest.cpp (7 tests)

**Action**:

1. Create fixtures per transpilation phase:
```cpp
class StandaloneFunctionTest : public ::testing::Test {
protected:
    void SetUp() override {
        initializeVirtualMethodSupport();
        initializeExceptionHandling();
        initializeRTTI();
    }

    FunctionDecl* parseFunction(const std::string& code) {
        // Parse and return function
    }

    std::string translateFunction(FunctionDecl* func) {
        // Translate to C
    }
};
```

2. Migrate each transpilation test file
3. Ensure virtual method, exception, and RTTI tests maintain behavior

**Verify**:
- All ~65 transpilation tests passing
- C code generation verified
- Name mangling correct

**Done**: ☐

### Task 4: Migrate Exception & RTTI Tests (~42 tests total)
**Type**: Test migration
**Files**:
- ExceptionIntegrationTest.cpp (11 tests)
- ExceptionRuntimeTest.cpp (12 tests)
- ExceptionPerformanceTest.cpp (4 tests)
- RTTIIntegrationTest.cpp (15 tests)

**Action**:

1. Create fixtures for exception and RTTI testing:
```cpp
class ExceptionTestFixture : public ::testing::Test {
protected:
    void SetUp() override {
        initializeExceptionHandling();
    }

    bool hasExceptionHandling(const FunctionDecl* func) {
        // Detect exception handling
    }
};
```

2. Migrate exception tests (preserve performance benchmarks in ExceptionPerformanceTest)
3. Migrate RTTI tests (typeid, dynamic_cast validation)

**Verify**:
- All ~42 tests passing
- Performance benchmarks still functional
- RTTI type checking works

**Done**: ☐

### Task 5: Migrate Coroutine Tests (~43 tests total)
**Type**: Test migration
**Files**:
- CoroutineDetectorTest.cpp (15 tests)
- SuspendPointIdentifierTest.cpp (7 tests)
- StateMachineTransformerTest.cpp (7 tests)
- PromiseTranslatorTest.cpp (7 tests)
- CoroutineIntegrationTest.cpp (7 tests)

**Action**:

1. Create coroutine test fixture:
```cpp
class CoroutineTestFixture : public ::testing::Test {
protected:
    void SetUp() override {
        // C++20 coroutine infrastructure
    }

    bool isCoroutine(const FunctionDecl* func) {
        // Detect co_await/co_yield/co_return
    }
};
```

2. Migrate all coroutine tests
3. Verify state machine transformation

**Verify**:
- All ~43 coroutine tests passing
- Suspend points detected correctly
- Promise types identified

**Done**: ☐

### Task 6: Migrate Runtime Mode Tests (~39 tests total)
**Type**: Test migration
**Files**:
- RuntimeModeLibraryTest.cpp (12 tests)
- RuntimeModeInlineTest.cpp (10 tests) - **CRITICAL: Was fixed in commit 34d7f54**
- RuntimeFeatureFlagsTest.cpp (15 tests)
- ResumeDestroyFunctionTest.cpp (7 tests)
- FrameAllocationTest.cpp (7 tests)
- SizeOptimizationTest.cpp (14 tests)

**Action**:

1. Create runtime mode fixtures
2. Migrate tests carefully (especially RuntimeModeInlineTest - recently fixed)
3. Preserve size optimization benchmarks

**Special attention**: RuntimeModeInlineTest
- Was fixed for embedded runtime code (commit 34d7f54)
- Ensure fix is preserved during migration
- Test inline mode embedding thoroughly

**Verify**:
- All ~39 runtime tests passing
- RuntimeModeInlineTest fix preserved (no regressions)
- Size optimization metrics maintained

**Done**: ☐

### Task 7: Migrate Remaining Core Tests (~166 tests)
**Type**: Test migration
**Files**: All remaining inline-style test files
**Action**:

1. Migrate systematically file by file
2. Use established fixture patterns
3. Split multi-assertion tests

**Verify**:
- All remaining tests passing
- Consistent GTest usage across all files

**Done**: ☐

### Task 8: Remove Inline Assertion Infrastructure
**Type**: Cleanup
**Files**: All migrated test files
**Action**:

1. Remove all `assert()` + `std::cout` patterns:
```bash
# Find remaining inline assertions
grep -r "std::cout.*PASSED" tests/ --include="*.cpp"
grep -r "assert.*&&" tests/ --include="*.cpp"
```

2. Remove manual test output code:
```cpp
// DELETE
std::cout << "Test X: ...";
std::cout << "PASSED\n";
```

3. Verify clean GTest-only code

**Verify**:
- No inline assertion patterns remain
- Clean GTest implementation

**Done**: ☐

### Task 9: Update CMakeLists.txt for All Core Tests
**Type**: Build system update
**Files**: tests/CMakeLists.txt
**Action**:

1. Update all test targets to link GTest:
```cmake
foreach(test_name IN ITEMS
    ACSLStatementAnnotatorTest
    ACSLBehaviorAnnotatorTest
    # ... all test names
)
    add_executable(${test_name} tests/${test_name}.cpp)
    target_link_libraries(${test_name} PRIVATE
        GTest::gtest
        GTest::gtest_main
        cpptoc_core
    )
    gtest_discover_tests(${test_name}
        PROPERTIES LABELS "core;unit"
    )
endforeach()
```

2. Verify all 434 tests discovered

**Verify**:
- All 434 tests in CTest
- Proper labeling

**Done**: ☐

### Task 10: Comprehensive Validation
**Type**: Verification
**Action**:

1. Run ALL migrated tests (phases 15-01 through 15-03):
```bash
ctest --output-on-failure  # All 986 tests
```

2. Verify 100% pass rate (986/986)

3. Memory leak check on all test suites:
```bash
for test in build/*Test; do
    echo "Checking $test..."
    valgrind --leak-check=summary --error-exitcode=1 "$test" 2>&1 | grep -E "leaked|lost"
done
```

4. Performance check (total execution time):
```bash
time ctest
```

5. Generate comprehensive XML report:
```bash
ctest --output-junit all_tests.xml
```

**Verify**:
- All 986 tests passing (100%)
- Zero memory leaks across all tests
- Total execution time reasonable (<15 minutes)
- XML report complete

**Done**: ☐

## Checkpoints

**Checkpoint 1** (after Task 1): Analysis complete
- Tests categorized by complexity
- Splitting strategy defined

**Checkpoint 2** (after Tasks 2-7): All tests migrated
- 434 tests converted
- All passing

**Checkpoint 3** (after Tasks 8-9): Cleanup complete
- No custom code remaining
- Build system updated

## Verification

Before declaring 15-03 complete, verify ALL of these:
- ✓ All 434 inline-style tests migrated to GTest
- ✓ All 434 tests passing (100% pass rate)
- ✓ Multi-assertion tests split appropriately
- ✓ Fixtures extensively used
- ✓ No inline assertion code remaining
- ✓ All 986 tests (phases 01-03 combined) passing
- ✓ No memory leaks across entire suite
- ✓ RuntimeModeInlineTest fix preserved
- ✓ No regressions

## Success Criteria

- All 434 inline-style tests use GTest
- Combined with phases 15-01 and 15-02: 986 tests total passing
- `ctest` runs all tests successfully
- Ready for Phase 15-04 (unified execution & coverage)

## Output

Generate summary at: `.planning/phases/15-test-migration-gtest/15-03-SUMMARY.md`

---

**Prepared by**: Claude Sonnet 4.5
**Date**: 2025-12-20
**Execution**: `/run-plan .planning/phases/15-test-migration-gtest/15-03-PLAN.md`
