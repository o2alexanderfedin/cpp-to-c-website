# Phase 1, Plan 01-03: Wizard E2E Tests

**Phase**: 01 - Wizard Foundation & Navigation
**Plan**: 01-03 - Wizard E2E Tests
**Scope**: End-to-end test coverage for wizard navigation
**Estimate**: 1 hour

---

## Objective

Create comprehensive end-to-end tests for the wizard navigation flow using Playwright. This ensures the complete wizard user experience works correctly across all steps with proper validation enforcement.

**Why**: E2E tests verify the full user journey (not just isolated components), catch integration issues between react-use-wizard and our components, and ensure step validation rules work in a real browser environment.

---

## Context

**Existing code from 01-01 and 01-02:**
- `@src/components/playground/wizard/PlaygroundWizard.tsx` - wizard shell with state management
- `@src/components/playground/wizard/WizardStepper.tsx` - visual stepper component
- `@src/components/playground/wizard/Step1SourceSelection.tsx` through `Step4Results.tsx` - step components
- `@src/components/playground/wizard/useWizardState.ts` - state management hook
- `@src/pages/playground.astro` - playground page with wizard

**Existing E2E test patterns:**
- `@tests/e2e/specs/` - E2E test directory structure
- Playwright for browser automation
- Tests run in Chromium, Firefox, and WebKit (if available)

**Patterns to follow:**
- Playwright test framework
- Page Object Model (POM) for reusable page interactions
- Accessibility testing (keyboard navigation, ARIA labels)
- Multiple browser support (Chromium required, others optional)

**Testing approach:**
- Test the happy path (navigate through all 4 steps)
- Test back navigation
- Test validation (can't skip steps without data)
- Test visual feedback (active step highlighting)
- Test accessibility (keyboard navigation, screen reader support)

---

## Tasks

### Task 1: Create Wizard Page Object
**Type**: create
**Files**: `tests/e2e/pages/WizardPage.ts`

**Action**:
Create a Page Object Model for the wizard to encapsulate interactions:

```typescript
import { Page, Locator } from '@playwright/test';

/**
 * Page Object for Wizard navigation
 *
 * Encapsulates wizard interactions for E2E tests
 */
export class WizardPage {
  readonly page: Page;
  readonly wizardContainer: Locator;
  readonly nextButton: Locator;
  readonly backButton: Locator;
  readonly step1Content: Locator;
  readonly step2Content: Locator;
  readonly step3Content: Locator;
  readonly step4Content: Locator;
  readonly stepIndicators: Locator;

  constructor(page: Page) {
    this.page = page;
    this.wizardContainer = page.locator('.playground-wizard');

    // Navigation buttons
    this.nextButton = page.getByRole('button', { name: /next/i });
    this.backButton = page.getByRole('button', { name: /back/i });

    // Step content areas
    this.step1Content = page.getByRole('heading', { name: /step 1.*source/i });
    this.step2Content = page.getByRole('heading', { name: /step 2.*target/i });
    this.step3Content = page.getByRole('heading', { name: /step 3.*transpil/i });
    this.step4Content = page.getByRole('heading', { name: /step 4.*results/i });

    // Step indicator circles
    this.stepIndicators = page.locator('.wizard-step');
  }

  /**
   * Navigate to playground page
   */
  async goto() {
    await this.page.goto('/cpp-to-c-website/playground');
    await this.wizardContainer.waitFor({ state: 'visible' });
  }

  /**
   * Click Next button
   */
  async clickNext() {
    await this.nextButton.click();
    // Wait for navigation to complete
    await this.page.waitForTimeout(100);
  }

  /**
   * Click Back button
   */
  async clickBack() {
    await this.backButton.click();
    await this.page.waitForTimeout(100);
  }

  /**
   * Get current step number based on visible content
   */
  async getCurrentStep(): Promise<number> {
    if (await this.step1Content.isVisible()) return 1;
    if (await this.step2Content.isVisible()) return 2;
    if (await this.step3Content.isVisible()) return 3;
    if (await this.step4Content.isVisible()) return 4;
    throw new Error('No step content is visible');
  }

  /**
   * Check if Next button is enabled
   */
  async isNextEnabled(): Promise<boolean> {
    return !(await this.nextButton.isDisabled());
  }

  /**
   * Check if Back button is enabled
   */
  async isBackEnabled(): Promise<boolean> {
    return !(await this.backButton.isDisabled());
  }

  /**
   * Get active step indicator number
   */
  async getActiveStepNumber(): Promise<number> {
    const activeStep = this.stepIndicators.filter({ hasText: /^(1|2|3|4)$/ }).locator('.active').first();
    const text = await activeStep.textContent();
    return parseInt(text || '0', 10);
  }

  /**
   * Navigate using keyboard (Tab to Next button, Enter to click)
   */
  async navigateNextWithKeyboard() {
    await this.nextButton.focus();
    await this.page.keyboard.press('Enter');
    await this.page.waitForTimeout(100);
  }

  /**
   * Navigate back using keyboard
   */
  async navigateBackWithKeyboard() {
    await this.backButton.focus();
    await this.page.keyboard.press('Enter');
    await this.page.waitForTimeout(100);
  }
}
```

**Verify**:
- Page object compiles without TypeScript errors
- All locators use semantic selectors (roles, labels)
- Methods are well-documented

**Done**: ✅ Wizard page object created

---

### Task 2: Create Wizard Navigation E2E Tests
**Type**: test
**Files**: `tests/e2e/specs/wizard-navigation.spec.ts`

**Action**:
Create comprehensive E2E tests for wizard navigation:

```typescript
import { test, expect } from '@playwright/test';
import { WizardPage } from '../pages/WizardPage';

test.describe('Wizard Navigation', () => {
  let wizardPage: WizardPage;

  test.beforeEach(async ({ page }) => {
    wizardPage = new WizardPage(page);
    await wizardPage.goto();
  });

  test('displays wizard on playground page', async () => {
    await expect(wizardPage.wizardContainer).toBeVisible();
    await expect(wizardPage.step1Content).toBeVisible();
  });

  test('starts on step 1 by default', async () => {
    const currentStep = await wizardPage.getCurrentStep();
    expect(currentStep).toBe(1);
  });

  test('Next button is enabled on step 1', async () => {
    const isEnabled = await wizardPage.isNextEnabled();
    expect(isEnabled).toBe(true);
  });

  test('Back button is disabled on step 1', async () => {
    const isEnabled = await wizardPage.isBackEnabled();
    expect(isEnabled).toBe(false);
  });

  test('can navigate forward through all steps', async () => {
    // Step 1 → Step 2
    await wizardPage.clickNext();
    expect(await wizardPage.getCurrentStep()).toBe(2);
    await expect(wizardPage.step2Content).toBeVisible();

    // Step 2 → Step 3
    await wizardPage.clickNext();
    expect(await wizardPage.getCurrentStep()).toBe(3);
    await expect(wizardPage.step3Content).toBeVisible();

    // Step 3 → Step 4
    await wizardPage.clickNext();
    expect(await wizardPage.getCurrentStep()).toBe(4);
    await expect(wizardPage.step4Content).toBeVisible();
  });

  test('can navigate backward through all steps', async () => {
    // Navigate to step 4
    await wizardPage.clickNext();
    await wizardPage.clickNext();
    await wizardPage.clickNext();
    expect(await wizardPage.getCurrentStep()).toBe(4);

    // Step 4 → Step 3
    await wizardPage.clickBack();
    expect(await wizardPage.getCurrentStep()).toBe(3);
    await expect(wizardPage.step3Content).toBeVisible();

    // Step 3 → Step 2
    await wizardPage.clickBack();
    expect(await wizardPage.getCurrentStep()).toBe(2);
    await expect(wizardPage.step2Content).toBeVisible();

    // Step 2 → Step 1
    await wizardPage.clickBack();
    expect(await wizardPage.getCurrentStep()).toBe(1);
    await expect(wizardPage.step1Content).toBeVisible();
  });

  test('Next button is disabled on step 4', async () => {
    // Navigate to step 4
    await wizardPage.clickNext();
    await wizardPage.clickNext();
    await wizardPage.clickNext();

    const isEnabled = await wizardPage.isNextEnabled();
    expect(isEnabled).toBe(false);
  });

  test('Back button is enabled on steps 2-4', async () => {
    // Step 2
    await wizardPage.clickNext();
    expect(await wizardPage.isBackEnabled()).toBe(true);

    // Step 3
    await wizardPage.clickNext();
    expect(await wizardPage.isBackEnabled()).toBe(true);

    // Step 4
    await wizardPage.clickNext();
    expect(await wizardPage.isBackEnabled()).toBe(true);
  });

  test('step indicators highlight current step', async () => {
    // Step 1 active
    let activeStep = await wizardPage.getActiveStepNumber();
    expect(activeStep).toBe(1);

    // Step 2 active
    await wizardPage.clickNext();
    activeStep = await wizardPage.getActiveStepNumber();
    expect(activeStep).toBe(2);

    // Step 3 active
    await wizardPage.clickNext();
    activeStep = await wizardPage.getActiveStepNumber();
    expect(activeStep).toBe(3);

    // Step 4 active
    await wizardPage.clickNext();
    activeStep = await wizardPage.getActiveStepNumber();
    expect(activeStep).toBe(4);
  });

  test('can navigate full round trip (1→2→3→4→3→2→1)', async () => {
    // Forward
    await wizardPage.clickNext(); // 1→2
    await wizardPage.clickNext(); // 2→3
    await wizardPage.clickNext(); // 3→4
    expect(await wizardPage.getCurrentStep()).toBe(4);

    // Backward
    await wizardPage.clickBack(); // 4→3
    await wizardPage.clickBack(); // 3→2
    await wizardPage.clickBack(); // 2→1
    expect(await wizardPage.getCurrentStep()).toBe(1);
  });
});

test.describe('Wizard Keyboard Navigation', () => {
  let wizardPage: WizardPage;

  test.beforeEach(async ({ page }) => {
    wizardPage = new WizardPage(page);
    await wizardPage.goto();
  });

  test('can navigate forward with keyboard', async () => {
    await wizardPage.navigateNextWithKeyboard();
    expect(await wizardPage.getCurrentStep()).toBe(2);

    await wizardPage.navigateNextWithKeyboard();
    expect(await wizardPage.getCurrentStep()).toBe(3);
  });

  test('can navigate backward with keyboard', async () => {
    // Navigate to step 3
    await wizardPage.clickNext();
    await wizardPage.clickNext();

    // Navigate back with keyboard
    await wizardPage.navigateBackWithKeyboard();
    expect(await wizardPage.getCurrentStep()).toBe(2);

    await wizardPage.navigateBackWithKeyboard();
    expect(await wizardPage.getCurrentStep()).toBe(1);
  });

  test('buttons have proper focus indicators', async ({ page }) => {
    await wizardPage.nextButton.focus();
    const nextFocused = await page.evaluate(() => {
      const el = document.activeElement;
      return el?.textContent?.toLowerCase().includes('next') || false;
    });
    expect(nextFocused).toBe(true);
  });
});

test.describe('Wizard Accessibility', () => {
  let wizardPage: WizardPage;

  test.beforeEach(async ({ page }) => {
    wizardPage = new WizardPage(page);
    await wizardPage.goto();
  });

  test('navigation buttons have accessible labels', async () => {
    await expect(wizardPage.nextButton).toHaveAccessibleName(/next/i);
    await expect(wizardPage.backButton).toHaveAccessibleName(/back/i);
  });

  test('step content has proper heading structure', async () => {
    await expect(wizardPage.step1Content).toHaveRole('heading');
  });

  test('disabled buttons have proper aria-disabled attribute', async () => {
    // Back button should be disabled on step 1
    await expect(wizardPage.backButton).toBeDisabled();

    // Navigate to step 4
    await wizardPage.clickNext();
    await wizardPage.clickNext();
    await wizardPage.clickNext();

    // Next button should be disabled on step 4
    await expect(wizardPage.nextButton).toBeDisabled();
  });
});
```

**Verify**:
- All tests pass in Chromium (primary browser)
- Tests pass in Firefox and WebKit (if available)
- Tests cover forward navigation, backward navigation, button states
- Keyboard navigation tests pass
- Accessibility tests pass

**Done**: ✅ E2E tests created and passing

---

### Task 3: Update Test Configuration
**Type**: update
**Files**: `playwright.config.ts` (if adjustments needed)

**Action**:
Verify Playwright configuration supports wizard tests:

1. Check base URL matches playground path with base path
2. Ensure timeouts are appropriate for wizard navigation
3. Verify projects are configured for multi-browser testing

**Example configuration check:**
```typescript
// playwright.config.ts should have:
{
  use: {
    baseURL: 'http://localhost:4321',
    // ... other settings
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    // Optional: Firefox, WebKit
  ]
}
```

**Verify**:
- Tests run successfully with `npm run test:e2e`
- Base URL is correct for wizard page navigation
- Multi-browser support configured (even if only Chromium runs in CI)

**Done**: ✅ Test configuration verified

---

### Task 4: Add E2E Test Documentation
**Type**: update
**Files**: `tests/e2e/README.md` (create if doesn't exist)

**Action**:
Document the wizard E2E tests for future reference:

```markdown
# End-to-End Tests

## Overview

E2E tests use Playwright to verify the complete user experience across all wizard steps.

## Running Tests

```bash
# Run all E2E tests
npm run test:e2e

# Run in headed mode (see browser)
npm run test:e2e -- --headed

# Run specific test file
npm run test:e2e -- wizard-navigation.spec.ts

# Debug mode
npm run test:e2e -- --debug
```

## Test Structure

### Page Objects (`tests/e2e/pages/`)
- `WizardPage.ts` - Encapsulates wizard interactions

### Test Specs (`tests/e2e/specs/`)
- `wizard-navigation.spec.ts` - Wizard navigation flow tests

## Wizard Tests

### Coverage
- ✅ Forward navigation through all 4 steps
- ✅ Backward navigation to previous steps
- ✅ Button states (enabled/disabled at correct steps)
- ✅ Step indicator highlighting
- ✅ Keyboard navigation (Enter on focused buttons)
- ✅ Accessibility (ARIA labels, roles, disabled states)

### Future Tests (Phases 2-4)
- Directory selection and file tree display
- Target directory selection with permissions
- Live transpilation with progress tracking
- Results preview with file selection
```

**Verify**:
- README provides clear instructions for running tests
- Documents current and planned test coverage

**Done**: ✅ Documentation created

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm run test:e2e` passes all wizard navigation tests
2. ✅ Tests run in Chromium (primary browser)
3. ✅ All navigation paths tested (forward, backward, round trip)
4. ✅ Button state tests pass (enabled/disabled validation)
5. ✅ Step indicator highlighting tests pass
6. ✅ Keyboard navigation tests pass
7. ✅ Accessibility tests pass
8. ✅ Page Object Model created and reusable
9. ✅ Documentation explains how to run tests
10. ✅ No regressions in existing E2E tests

---

## Success Criteria

- [x] WizardPage page object created with reusable methods
- [x] E2E tests cover all wizard navigation scenarios
- [x] Forward/backward navigation tested
- [x] Button states validated at each step
- [x] Step indicator highlighting verified
- [x] Keyboard navigation tested
- [x] Accessibility verified (ARIA, roles, disabled states)
- [x] All tests pass in Chromium
- [x] Documentation updated
- [x] No regressions in existing tests

---

## Output: SUMMARY.md

When this plan is complete, create `01-03-SUMMARY.md` with:

```markdown
# Phase 1, Plan 01-03: Wizard E2E Tests - COMPLETE

**Status**: ✅ Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Created WizardPage page object for reusable wizard interactions
- Implemented comprehensive E2E test suite for wizard navigation
- Added keyboard navigation tests
- Added accessibility tests
- Updated E2E test documentation

## Files Changed

- `tests/e2e/pages/WizardPage.ts` - NEW (page object)
- `tests/e2e/specs/wizard-navigation.spec.ts` - NEW (X tests)
- `tests/e2e/README.md` - NEW or UPDATED (documentation)
- `playwright.config.ts` - VERIFIED (configuration correct)

## Tests

- E2E tests: X passing, 0 failing
- Test categories:
  - Basic navigation: X tests
  - Keyboard navigation: X tests
  - Accessibility: X tests
- All tests pass in Chromium

## Verification

✅ All success criteria met
✅ Full wizard navigation flow tested
✅ Button states validated
✅ Keyboard navigation works
✅ Accessibility verified
✅ Documentation updated
✅ No regressions

## Deviations from Plan

[None] OR [List any changes made during implementation]

## Next Steps

**Phase 1 Complete!** Ready for **Phase 2: File Tree View & Source Selection**

Phase 2 will add:
- react-arborist virtualized tree component
- Source directory file discovery
- File filtering (C++ files only)
- Integration with Step 1

## Commits

- `[commit-hash]` feat(01-03): Add wizard E2E navigation tests
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/01-wizard-foundation/01-03-PLAN.md`
