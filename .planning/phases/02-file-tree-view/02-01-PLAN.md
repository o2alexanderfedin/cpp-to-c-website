# Phase 2, Plan 02-01: FileTreeView Component Foundation

**Phase**: 02 - File Tree View & Source Selection
**Plan**: 02-01 - FileTreeView Component Foundation
**Scope**: Basic tree rendering with expand/collapse using react-arborist
**Estimate**: 2 hours

---

## Objective

Create a reusable FileTreeView component using the battle-tested `react-arborist` library to provide rich directory tree visualization with expand/collapse functionality, virtualization for 1000+ files, and proper styling.

**Why**: Establishes the foundational tree component that will be reused across Steps 1, 3, and 4 for source directory browsing, live transpilation progress, and results preview. Using react-arborist (virtualized, handles 10k+ nodes) instead of building from scratch ensures performance with large codebases.

---

## Context

**Existing code to understand:**
- `@src/components/playground/wizard/Step1SourceSelection.tsx` - where tree will be integrated
- `@src/components/playground/wizard/types.ts` - FileInfo interface and WizardState
- `@src/components/playground/DirectorySelector.tsx` - existing directory selection pattern
- `@src/components/playground/ErrorDisplay.tsx` - CSS-in-JS styling pattern to follow

**Patterns to follow:**
- React 19 with TypeScript (existing pattern)
- CSS-in-JS for styling (existing pattern in all current components)
- Component tests with Vitest and @testing-library/react (existing pattern)
- Export via index.ts barrel file (existing pattern)

**New dependency:**
- `react-arborist@^3.4.0` - Tree component with built-in virtualization, drag-and-drop, keyboard navigation

**Key Requirements:**
- Tree must handle nested folder structures
- Expand/collapse functionality for folders
- File and folder icons for visual distinction
- Indentation to show hierarchy
- Support for 1000+ files without lag (react-arborist provides this built-in)
- Flexible data structure to work with FileInfo[] from wizard state

---

## Tasks

### Task 1: Install react-arborist
**Type**: dependency
**Files**: `package.json`, `package-lock.json`

**Action**:
```bash
npm install react-arborist
```

**Verify**:
- Package appears in package.json dependencies
- No version conflicts with React 19
- No peer dependency warnings

**Done**: âœ… Dependency installed and no conflicts

---

### Task 2: Create Tree Data Structure Utility
**Type**: create
**Files**: `src/components/playground/wizard/utils/buildTreeData.ts`

**Action**:
Create utility function to transform flat FileInfo[] into tree structure for react-arborist:

```typescript
import type { FileInfo } from '../types';

export interface TreeNode {
  id: string;
  name: string;
  children?: TreeNode[];
  isFolder: boolean;
  fileInfo?: FileInfo; // Leaf nodes only
}

/**
 * Build tree structure from flat file list
 * @param files - Flat list of FileInfo objects
 * @returns Root tree node with nested children
 */
export function buildTreeData(files: FileInfo[]): TreeNode {
  // Create root node
  const root: TreeNode = {
    id: 'root',
    name: 'Source Files',
    isFolder: true,
    children: [],
  };

  // Build tree by splitting paths and creating nested structure
  // Example: "src/utils/helper.cpp" -> root > src > utils > helper.cpp

  // Implementation details:
  // 1. Sort files by path for consistent tree order
  // 2. Split each path by '/'
  // 3. Create folder nodes as needed
  // 4. Attach file nodes to parent folders
  // 5. Maintain map of path -> node for efficient lookups

  return root;
}
```

**Structure requirements:**
- Each folder is a TreeNode with `isFolder: true` and `children: []`
- Each file is a TreeNode with `isFolder: false` and `fileInfo: FileInfo`
- Nodes have unique IDs (use full path as ID)
- Handle edge cases: empty directories, files in root, special characters in names

**Verify**:
- Unit tests for buildTreeData with various file structures
- Handles nested folders correctly
- Handles files in root directory
- Handles empty input (returns root with no children)

**Done**: âœ… Tree data utility created and tested

---

### Task 3: Create FileTreeView Component
**Type**: create
**Files**: `src/components/playground/wizard/FileTreeView.tsx`

**Action**:
Create tree view component using react-arborist:

```typescript
import React from 'react';
import { Tree } from 'react-arborist';
import type { FileInfo } from './types';
import type { TreeNode } from './utils/buildTreeData';
import { buildTreeData } from './utils/buildTreeData';

export interface FileTreeViewProps {
  files: FileInfo[];
  selectedFile?: string; // Path of highlighted file (for Step 3 & 4)
  onFileSelect?: (file: FileInfo) => void; // Click handler (for Step 4)
  height?: number; // Tree height in pixels (default: 400)
  showRoot?: boolean; // Show root node (default: false)
}

export const FileTreeView: React.FC<FileTreeViewProps> = ({
  files,
  selectedFile,
  onFileSelect,
  height = 400,
  showRoot = false,
}) => {
  // Build tree data from flat file list
  const treeData = React.useMemo(() => buildTreeData(files), [files]);

  // Node renderer component
  const Node = ({ node, style, dragHandle }) => {
    const isSelected = !node.data.isFolder && node.data.fileInfo?.path === selectedFile;

    return (
      <div
        style={style}
        ref={dragHandle}
        className={`tree-node ${isSelected ? 'selected' : ''}`}
        onClick={() => {
          if (!node.data.isFolder && onFileSelect && node.data.fileInfo) {
            onFileSelect(node.data.fileInfo);
          }
        }}
      >
        {/* Folder/file icon */}
        <span className="tree-icon">
          {node.data.isFolder ? (node.isOpen ? 'ğŸ“‚' : 'ğŸ“') : 'ğŸ“„'}
        </span>

        {/* Node name */}
        <span className="tree-name">{node.data.name}</span>
      </div>
    );
  };

  return (
    <div className="file-tree-view">
      <Tree
        data={showRoot ? [treeData] : treeData.children || []}
        openByDefault={false}
        width="100%"
        height={height}
        indent={24}
        rowHeight={32}
        overscanCount={10}
      >
        {Node}
      </Tree>

      <style>{`
        .file-tree-view {
          border: 1px solid #ddd;
          border-radius: 4px;
          background-color: #fff;
          overflow: hidden;
        }

        .tree-node {
          display: flex;
          align-items: center;
          padding: 0.25rem 0.5rem;
          cursor: pointer;
          user-select: none;
          transition: background-color 0.15s;
        }

        .tree-node:hover {
          background-color: #f5f5f5;
        }

        .tree-node.selected {
          background-color: #e3f2fd;
          border-left: 3px solid #4A90E2;
        }

        .tree-icon {
          margin-right: 0.5rem;
          font-size: 1.25rem;
          flex-shrink: 0;
        }

        .tree-name {
          font-size: 0.9rem;
          color: #333;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        .tree-node.selected .tree-name {
          font-weight: 600;
          color: #1976d2;
        }
      `}</style>
    </div>
  );
};
```

**Component features:**
1. Uses react-arborist's `<Tree>` component with virtualization built-in
2. Renders folder and file icons (can use emoji for now, upgrade to icon library later)
3. Supports expand/collapse (react-arborist handles this)
4. Highlights selected file (for Step 3 & 4 integration)
5. Optional click handler (for Step 4 file preview)
6. Configurable height
7. Follows existing CSS-in-JS pattern

**Accessibility:**
- Keyboard navigation (react-arborist provides this)
- ARIA attributes for screen readers
- Focus visible styles

**Verify**:
- Tree renders with nested structure
- Folders can expand/collapse
- Icons display correctly
- Selected file is highlighted
- Click handler fires for files (not folders)
- No TypeScript errors

**Done**: âœ… FileTreeView component created and renders correctly

---

### Task 4: Component Tests
**Type**: test
**Files**: `src/components/playground/wizard/FileTreeView.test.tsx`

**Action**:
Create comprehensive unit tests covering:

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { FileTreeView } from './FileTreeView';
import type { FileInfo } from './types';

describe('FileTreeView', () => {
  const mockFiles: FileInfo[] = [
    {
      path: 'src/main.cpp',
      name: 'main.cpp',
      handle: {} as FileSystemFileHandle,
      size: 1024,
    },
    {
      path: 'src/utils/helper.cpp',
      name: 'helper.cpp',
      handle: {} as FileSystemFileHandle,
      size: 512,
    },
    {
      path: 'include/common.h',
      name: 'common.h',
      handle: {} as FileSystemFileHandle,
      size: 256,
    },
  ];

  it('renders tree with files', () => {
    render(<FileTreeView files={mockFiles} />);
    // Verify tree structure rendered
  });

  it('displays folder icons for folders', () => {
    render(<FileTreeView files={mockFiles} />);
    // Verify folder icons present (src, utils, include)
  });

  it('displays file icons for files', () => {
    render(<FileTreeView files={mockFiles} />);
    // Verify file icons present (main.cpp, helper.cpp, common.h)
  });

  it('expands and collapses folders', async () => {
    render(<FileTreeView files={mockFiles} />);
    // Click folder to expand, verify children visible
    // Click again to collapse, verify children hidden
  });

  it('highlights selected file', () => {
    render(<FileTreeView files={mockFiles} selectedFile="src/main.cpp" />);
    // Verify main.cpp has selected styles
  });

  it('calls onFileSelect when file clicked', () => {
    const handleSelect = vi.fn();
    render(<FileTreeView files={mockFiles} onFileSelect={handleSelect} />);

    // Find and click main.cpp
    // Verify handleSelect called with correct FileInfo
  });

  it('does not call onFileSelect when folder clicked', () => {
    const handleSelect = vi.fn();
    render(<FileTreeView files={mockFiles} onFileSelect={handleSelect} />);

    // Click src folder
    // Verify handleSelect not called
  });

  it('handles empty file list', () => {
    render(<FileTreeView files={[]} />);
    // Should render without errors, show empty tree
  });

  it('respects custom height prop', () => {
    const { container } = render(<FileTreeView files={mockFiles} height={600} />);
    // Verify tree height is 600px
  });
});

// Separate test file for buildTreeData utility
describe('buildTreeData', () => {
  it('creates nested structure from flat file list', () => {
    // Test tree building logic
  });

  it('handles files in root directory', () => {
    // Test root-level files
  });

  it('sorts folders before files', () => {
    // Test sorting behavior
  });

  it('handles empty input', () => {
    // Test empty array
  });
});
```

**Test coverage goals:**
- All component props tested
- Expand/collapse behavior
- Selection highlighting
- Click handlers
- Edge cases (empty, root files)
- Tree data building utility
- Target: >80% coverage

**Verify**:
- All tests pass
- Coverage report shows >80%
- No console errors during test run
- Tests run in CI (npm test)

**Done**: âœ… Tests written and passing with good coverage

---

### Task 5: Export and Documentation
**Type**: update
**Files**: `src/components/playground/wizard/index.ts`

**Action**:
Add FileTreeView to barrel exports:

```typescript
// src/components/playground/wizard/index.ts
export { WizardStepper } from './WizardStepper';
export { PlaygroundWizard } from './PlaygroundWizard';
export { Step1SourceSelection } from './Step1SourceSelection';
export { Step2TargetSelection } from './Step2TargetSelection';
export { Step3Transpilation } from './Step3Transpilation';
export { Step4Results } from './Step4Results';
export { FileTreeView } from './FileTreeView'; // NEW
export type { FileTreeViewProps } from './FileTreeView'; // NEW
export type { TreeNode } from './utils/buildTreeData'; // NEW
```

**Documentation:**
Add JSDoc comments to component with usage examples:

```typescript
/**
 * FileTreeView - Virtualized tree component for displaying directory structures
 *
 * @example Basic usage
 * ```tsx
 * <FileTreeView files={sourceFiles} />
 * ```
 *
 * @example With selection and click handler
 * ```tsx
 * <FileTreeView
 *   files={sourceFiles}
 *   selectedFile={currentFilePath}
 *   onFileSelect={(file) => previewFile(file)}
 *   height={500}
 * />
 * ```
 */
```

**Verify**:
- Exports work correctly
- TypeScript autocomplete shows FileTreeView
- JSDoc appears in IDE tooltips
- No circular dependencies

**Done**: âœ… Component exported and documented

---

### Task 6: Manual Testing in Browser
**Type**: manual test
**Files**: N/A (browser testing)

**Action**:
Create temporary test page or update Step1 to render FileTreeView with mock data:

1. Add FileTreeView to Step1SourceSelection with sample files:
```typescript
const mockFiles: FileInfo[] = [
  { path: 'src/main.cpp', name: 'main.cpp', handle: {} as any, size: 1024 },
  { path: 'src/core/engine.cpp', name: 'engine.cpp', handle: {} as any, size: 2048 },
  { path: 'src/core/renderer.cpp', name: 'renderer.cpp', handle: {} as any, size: 3072 },
  { path: 'src/utils/math.h', name: 'math.h', handle: {} as any, size: 512 },
  { path: 'tests/test_main.cpp', name: 'test_main.cpp', handle: {} as any, size: 1536 },
];

// In Step1SourceSelection component:
<FileTreeView files={mockFiles} height={400} />
```

2. Start dev server: `npm run dev`
3. Navigate to playground page
4. Verify in browser:
   - Tree renders with folders (src, src/core, src/utils, tests)
   - Files appear under correct folders
   - Can expand/collapse folders
   - Folder icons change (ğŸ“ â†’ ğŸ“‚) when expanded
   - Tree scrolls if height exceeds 400px
   - No console errors
   - No visual glitches

**Browser testing checklist:**
- âœ… Tree structure displays correctly
- âœ… Expand/collapse works smoothly
- âœ… Icons render properly
- âœ… Indentation shows hierarchy clearly
- âœ… No layout shifts when expanding
- âœ… Scrolling works if content exceeds height
- âœ… Hover states work
- âœ… Keyboard navigation works (tab, arrow keys, enter)

**Verify**:
- All visual checks pass
- No console warnings or errors
- Performance is smooth (no lag)

**Done**: âœ… Manual browser testing complete

---

## Verification

**Overall checks after all tasks complete:**

1. âœ… `npm install` succeeds with react-arborist
2. âœ… `npm run test` passes all tests (unit tests for FileTreeView and buildTreeData)
3. âœ… `npm run build` succeeds without errors
4. âœ… `npm run dev` starts without errors
5. âœ… Navigate to http://localhost:4321/cpp-to-c-website/playground
6. âœ… See FileTreeView in Step 1 with mock data
7. âœ… Tree shows nested folder structure
8. âœ… Can expand folders to reveal nested files
9. âœ… Can collapse folders to hide children
10. âœ… Folder icons change between closed (ğŸ“) and open (ğŸ“‚)
11. âœ… File icons display consistently (ğŸ“„)
12. âœ… Indentation clearly shows hierarchy
13. âœ… No TypeScript errors in IDE
14. âœ… No console errors in browser
15. âœ… Tree scrolls smoothly with 50+ files

**Performance checks:**
- âœ… Tree renders in <200ms with 100 files
- âœ… Expand/collapse is instant (<50ms)
- âœ… No frame drops when scrolling
- âœ… Virtualization working (only visible nodes rendered)

---

## Success Criteria

- [x] react-arborist installed and working
- [x] buildTreeData utility converts flat FileInfo[] to tree structure
- [x] FileTreeView component renders tree with folders and files
- [x] Expand/collapse functionality works smoothly
- [x] Folder and file icons display correctly
- [x] Indentation shows hierarchy clearly
- [x] Selected file highlighting works (for future Steps 3 & 4)
- [x] Optional onFileSelect click handler (for future Step 4)
- [x] Unit tests pass with >80% coverage
- [x] Component follows existing patterns (React 19, TypeScript, CSS-in-JS)
- [x] Exports via barrel file
- [x] JSDoc documentation complete
- [x] Manual browser testing confirms functionality
- [x] All existing tests still pass (no regressions)

---

## Output: SUMMARY.md

When this plan is complete, create `02-01-SUMMARY.md` with:

```markdown
# Phase 2, Plan 02-01: FileTreeView Component Foundation - COMPLETE

**Status**: âœ… Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Installed react-arborist (virtualized tree library)
- Created buildTreeData utility to convert flat FileInfo[] to tree structure
- Created FileTreeView component with expand/collapse functionality
- Implemented folder/file icons and proper indentation
- Added selection highlighting (for Step 3 & 4 integration)
- Added optional click handler (for Step 4 file preview)
- Created comprehensive unit tests for component and utility
- Exported component via barrel file with TypeScript types
- Added JSDoc documentation with usage examples

## Files Changed

- `package.json` - Added react-arborist dependency
- `src/components/playground/wizard/utils/buildTreeData.ts` - NEW (X lines)
- `src/components/playground/wizard/utils/buildTreeData.test.ts` - NEW (X lines)
- `src/components/playground/wizard/FileTreeView.tsx` - NEW (X lines)
- `src/components/playground/wizard/FileTreeView.test.tsx` - NEW (X lines)
- `src/components/playground/wizard/index.ts` - Updated exports

## Tests

- Unit tests: X passing, 0 failing
- buildTreeData tests: X passing (edge cases covered)
- FileTreeView tests: X passing (interactions covered)
- Coverage: X% (target: >80%)

## Verification

âœ… All success criteria met
âœ… No regressions in existing tests
âœ… Tree renders and functions correctly in browser
âœ… Performance tested with 100+ file mock dataset
âœ… Virtualization working (react-arborist handles 10k+ nodes)

## Deviations from Plan

[None] OR [List any changes made during implementation]

## Next Steps

Ready for **02-02**: Tree Virtualization Performance Testing
- Benchmark with 2000-file test project
- Verify <200ms render time for 1000 files
- Test auto-scroll behavior for Step 3 integration
- Validate memory usage with large datasets

Alternatively, can proceed to **02-03**: Source Selection Integration
- Integrate FileTreeView into Step1SourceSelection
- Connect to DirectorySelector for live file discovery
- Add file filtering (show only C++ files)
- Display file count and size statistics

## Commits

- `[commit-hash]` feat(tree): Add react-arborist dependency and buildTreeData utility
- `[commit-hash]` feat(tree): Create FileTreeView component with expand/collapse
- `[commit-hash]` test(tree): Add comprehensive tests for FileTreeView and buildTreeData
- `[commit-hash]` docs(tree): Export FileTreeView and add JSDoc documentation
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/02-file-tree-view/02-01-PLAN.md`
