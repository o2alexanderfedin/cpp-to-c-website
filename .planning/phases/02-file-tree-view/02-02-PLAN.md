# Phase 2, Plan 02-02: Tree Virtualization with react-arborist

**Phase**: 02 - File Tree View & Source Selection
**Plan**: 02-02 - Tree Virtualization
**Scope**: Add react-arborist virtualization for performance with large file lists
**Estimate**: 2 hours

---

## Objective

Integrate `react-arborist` into the FileTreeView component (from 02-01) to enable high-performance virtualized rendering of file trees with 2000+ files while maintaining smooth scrolling and interaction.

**Why**: The BRIEF specifies that tree views must handle 2000+ files without lag (virtualization required). react-arborist is the selected library (from BRIEF.md line 193) because it has built-in virtualization for 10k+ nodes, React 19 support, and is actively maintained - the only public component option with these capabilities.

**Performance Target**: <200ms render time for 1000 files (BRIEF line 133)

---

## Context

**Prerequisites**:
- `02-01-PLAN.md` must be complete - FileTreeView component exists with basic tree rendering
- FileTreeView currently has expand/collapse logic, file/folder icons, indentation styling
- Component uses recursive structure that doesn't scale beyond ~100 files

**Existing code to refactor:**
- `@src/components/playground/wizard/FileTreeView.tsx` - current recursive implementation
- `@src/components/playground/wizard/FileTreeView.test.tsx` - existing tests must still pass
- `@src/components/playground/wizard/Step1SourceSelection.tsx` - uses FileTreeView

**Patterns to follow:**
- React 19 with TypeScript
- Component tests with Vitest and @testing-library/react
- Performance benchmarks in test suite

**New dependency:**
- `react-arborist@^3.4.0` - Virtualized tree component with 10k+ node support

---

## Tasks

### Task 1: Install react-arborist and type definitions
**Type**: dependency
**Files**: `package.json`, `package-lock.json`

**Action**:
```bash
npm install react-arborist
npm install -D @types/react-arborist
```

**Verify**:
- Package appears in package.json dependencies
- TypeScript types available (no import errors)
- No version conflicts with React 19

**Done**: ✅ Dependencies installed, build succeeds

---

### Task 2: Create tree data model for react-arborist
**Type**: create
**Files**: `src/lib/playground/wizard/tree-data.ts`

**Action**:
Create data transformation utilities to convert FileInfo[] (from file system) to react-arborist's tree structure:

```typescript
import type { NodeApi } from 'react-arborist';

/**
 * Tree node data structure for react-arborist
 */
export interface TreeNodeData {
  id: string;              // Unique identifier (file path)
  name: string;            // Display name (file/folder name)
  children?: TreeNodeData[]; // Child nodes (for folders)
  isFolder: boolean;       // True for directories
  size?: number;           // File size in bytes (for files)
  path: string;            // Full file path
  extension?: string;      // File extension (for syntax highlighting later)
}

/**
 * File info from File System Access API
 */
export interface FileInfo {
  path: string;
  name: string;
  type: 'file' | 'directory';
  size?: number;
  children?: FileInfo[];
}

/**
 * Convert flat or nested FileInfo array to react-arborist tree structure
 */
export function fileInfoToTreeData(files: FileInfo[]): TreeNodeData[] {
  return files.map(file => ({
    id: file.path,
    name: file.name,
    isFolder: file.type === 'directory',
    path: file.path,
    size: file.size,
    extension: file.type === 'file' ? getFileExtension(file.name) : undefined,
    children: file.children ? fileInfoToTreeData(file.children) : undefined,
  }));
}

/**
 * Extract file extension from filename
 */
function getFileExtension(filename: string): string | undefined {
  const parts = filename.split('.');
  return parts.length > 1 ? parts[parts.length - 1] : undefined;
}

/**
 * Count total nodes in tree (for benchmarking)
 */
export function countTreeNodes(nodes: TreeNodeData[]): number {
  let count = 0;
  for (const node of nodes) {
    count += 1;
    if (node.children) {
      count += countTreeNodes(node.children);
    }
  }
  return count;
}
```

**Verify**:
- TypeScript compiles without errors
- Functions transform FileInfo to TreeNodeData correctly
- Handles nested structures (folders with children)

**Done**: ✅ Data model created and type-safe

---

### Task 3: Refactor FileTreeView to use react-arborist
**Type**: refactor
**Files**: `src/components/playground/wizard/FileTreeView.tsx`

**Action**:
Replace recursive tree rendering with react-arborist's Tree component:

**Before (pseudocode - recursive approach):**
```typescript
export const FileTreeView: React.FC<FileTreeViewProps> = ({ files }) => {
  return (
    <div className="file-tree">
      {files.map(file => (
        <TreeNode key={file.path} file={file} />
      ))}
    </div>
  );
};
```

**After (virtualized approach):**
```typescript
import { Tree, type NodeApi } from 'react-arborist';
import { fileInfoToTreeData, type TreeNodeData } from '@/lib/playground/wizard/tree-data';
import { TreeNodeRenderer } from './TreeNodeRenderer';

export interface FileTreeViewProps {
  files: FileInfo[];
  currentFile?: string;        // For highlighting (Phase 3)
  onFileSelect?: (path: string) => void; // For file preview (Phase 4)
  height?: number;             // Container height for virtualization
  width?: number;              // Container width
}

export const FileTreeView: React.FC<FileTreeViewProps> = ({
  files,
  currentFile,
  onFileSelect,
  height = 600,
  width = 400,
}) => {
  const treeData = React.useMemo(
    () => fileInfoToTreeData(files),
    [files]
  );

  const handleNodeClick = React.useCallback(
    (node: NodeApi<TreeNodeData>) => {
      if (!node.data.isFolder && onFileSelect) {
        onFileSelect(node.data.path);
      }
    },
    [onFileSelect]
  );

  return (
    <div className="file-tree-container" style={{ height, width }}>
      <Tree<TreeNodeData>
        data={treeData}
        openByDefault={false}
        width={width}
        height={height}
        indent={24}
        rowHeight={32}
        onActivate={handleNodeClick}
      >
        {(props) => <TreeNodeRenderer {...props} currentFile={currentFile} />}
      </Tree>
    </div>
  );
};
```

**Key changes**:
- Uses `Tree` component from react-arborist (virtualized)
- `data` prop accepts transformed TreeNodeData
- `height` and `width` props required for virtualization calculations
- `indent` controls folder nesting indentation (24px)
- `rowHeight` sets fixed row height for virtual scrolling (32px)
- `openByDefault={false}` - folders start collapsed
- `onActivate` callback for file clicks
- Custom renderer via children render prop

**Verify**:
- Component compiles without TypeScript errors
- No runtime errors when rendering
- Props interface is backward compatible (files prop still works)

**Done**: ✅ FileTreeView refactored to use react-arborist

---

### Task 4: Create TreeNodeRenderer component
**Type**: create
**Files**: `src/components/playground/wizard/TreeNodeRenderer.tsx`

**Action**:
Create custom node renderer for react-arborist that handles:
- File/folder icons
- Expand/collapse indicators
- Current file highlighting (for Phase 3)
- Hover states
- Status icons (pending/success/error - for Phase 3)

```typescript
import type { NodeRendererProps } from 'react-arborist';
import type { TreeNodeData } from '@/lib/playground/wizard/tree-data';
import { FolderIcon, FileIcon, ChevronRightIcon } from '@/components/icons';

export interface TreeNodeRendererProps extends NodeRendererProps<TreeNodeData> {
  currentFile?: string; // Highlighted file path (Phase 3)
}

export const TreeNodeRenderer: React.FC<TreeNodeRendererProps> = ({
  node,
  style,
  currentFile,
}) => {
  const isHighlighted = node.data.path === currentFile;
  const isFolder = node.data.isFolder;

  return (
    <div
      style={style}
      className={`tree-node ${isHighlighted ? 'tree-node--highlighted' : ''}`}
      onClick={() => node.toggle()}
    >
      <div className="tree-node__content" style={{ paddingLeft: node.level * 24 }}>
        {/* Expand/collapse arrow for folders */}
        {isFolder && (
          <span
            className={`tree-node__arrow ${node.isOpen ? 'tree-node__arrow--open' : ''}`}
          >
            <ChevronRightIcon />
          </span>
        )}

        {/* File/folder icon */}
        <span className="tree-node__icon">
          {isFolder ? <FolderIcon /> : <FileIcon extension={node.data.extension} />}
        </span>

        {/* File/folder name */}
        <span className="tree-node__name">
          {node.data.name}
        </span>

        {/* File size (optional, only for files) */}
        {!isFolder && node.data.size && (
          <span className="tree-node__size">
            {formatFileSize(node.data.size)}
          </span>
        )}
      </div>
    </div>
  );
};

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}
```

**Styling** (add to component or separate CSS):
```css
.tree-node {
  cursor: pointer;
  user-select: none;
  transition: background-color 0.15s ease;
}

.tree-node:hover {
  background-color: #f0f0f0;
}

.tree-node--highlighted {
  background-color: #e3f2fd;
  font-weight: 600;
}

.tree-node__content {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 8px;
  height: 32px;
}

.tree-node__arrow {
  width: 16px;
  height: 16px;
  transition: transform 0.2s ease;
}

.tree-node__arrow--open {
  transform: rotate(90deg);
}

.tree-node__icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tree-node__name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.tree-node__size {
  font-size: 0.85em;
  color: #666;
}
```

**Verify**:
- Nodes render with correct icons
- Folders can expand/collapse
- Indentation works for nested folders
- Highlighting works when currentFile prop provided
- Hover states are responsive

**Done**: ✅ Custom node renderer created with proper styling

---

### Task 5: Create performance benchmark test
**Type**: test
**Files**: `src/components/playground/wizard/FileTreeView.benchmark.test.tsx`

**Action**:
Create benchmark test to verify virtualization performance with 2000-file project:

```typescript
import { describe, it, expect, beforeAll } from 'vitest';
import { render, waitFor } from '@testing-library/react';
import { FileTreeView } from './FileTreeView';
import type { FileInfo } from '@/lib/playground/wizard/tree-data';

/**
 * Generate large file tree for benchmarking
 */
function generateLargeFileTree(fileCount: number): FileInfo[] {
  const files: FileInfo[] = [];
  const foldersPerLevel = 10;
  const filesPerFolder = Math.ceil(fileCount / foldersPerLevel);

  for (let i = 0; i < foldersPerLevel; i++) {
    const folderName = `folder_${i}`;
    const children: FileInfo[] = [];

    for (let j = 0; j < filesPerFolder && files.length < fileCount; j++) {
      children.push({
        path: `${folderName}/file_${j}.cpp`,
        name: `file_${j}.cpp`,
        type: 'file',
        size: Math.random() * 1024 * 100, // 0-100KB
      });
    }

    files.push({
      path: folderName,
      name: folderName,
      type: 'directory',
      children,
    });
  }

  return files;
}

describe('FileTreeView Performance', () => {
  it('renders 1000 files in <200ms', async () => {
    const files = generateLargeFileTree(1000);

    const start = performance.now();
    const { container } = render(
      <FileTreeView files={files} height={600} width={400} />
    );
    const renderTime = performance.now() - start;

    expect(container.querySelector('.file-tree-container')).toBeTruthy();
    expect(renderTime).toBeLessThan(200); // BRIEF requirement: <200ms

    console.log(`Rendered 1000 files in ${renderTime.toFixed(2)}ms`);
  });

  it('renders 2000 files smoothly', async () => {
    const files = generateLargeFileTree(2000);

    const start = performance.now();
    const { container } = render(
      <FileTreeView files={files} height={600} width={400} />
    );
    const renderTime = performance.now() - start;

    expect(container.querySelector('.file-tree-container')).toBeTruthy();
    expect(renderTime).toBeLessThan(500); // Should still be fast

    console.log(`Rendered 2000 files in ${renderTime.toFixed(2)}ms`);
  });

  it('handles very large trees (5000 files)', async () => {
    const files = generateLargeFileTree(5000);

    const start = performance.now();
    const { container } = render(
      <FileTreeView files={files} height={600} width={400} />
    );
    const renderTime = performance.now() - start;

    expect(container.querySelector('.file-tree-container')).toBeTruthy();
    expect(renderTime).toBeLessThan(1000); // 1 second max for extreme case

    console.log(`Rendered 5000 files in ${renderTime.toFixed(2)}ms`);
  });

  it('only renders visible nodes (virtualization check)', async () => {
    const files = generateLargeFileTree(2000);
    const { container } = render(
      <FileTreeView files={files} height={600} width={400} />
    );

    // With virtualization, only ~18 nodes should be rendered
    // (600px height / 32px row height ≈ 18 visible rows)
    const renderedNodes = container.querySelectorAll('.tree-node');

    // Should render far fewer nodes than total files
    expect(renderedNodes.length).toBeLessThan(100); // Much less than 2000
    expect(renderedNodes.length).toBeGreaterThan(0); // But some nodes visible

    console.log(`Virtualized: ${renderedNodes.length} nodes rendered out of 2000 total`);
  });
});
```

**Verify**:
- Tests pass on first run
- Render times meet requirements (<200ms for 1000 files)
- Virtualization is working (only visible nodes rendered)
- Console logs show actual performance metrics

**Done**: ✅ Performance benchmarks passing

---

### Task 6: Update existing FileTreeView tests
**Type**: update
**Files**: `src/components/playground/wizard/FileTreeView.test.tsx`

**Action**:
Update unit tests from 02-01 to work with refactored react-arborist implementation:

**Changes needed**:
1. Import react-arborist types if needed
2. Update test setup to provide height/width props
3. Adjust selectors if DOM structure changed
4. Ensure expand/collapse tests still work (now via react-arborist API)
5. Add new tests for virtualization-specific behavior

**Example test updates**:
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { FileTreeView } from './FileTreeView';

describe('FileTreeView', () => {
  const mockFiles: FileInfo[] = [
    {
      path: 'src',
      name: 'src',
      type: 'directory',
      children: [
        { path: 'src/main.cpp', name: 'main.cpp', type: 'file', size: 1024 },
        { path: 'src/utils.h', name: 'utils.h', type: 'file', size: 512 },
      ],
    },
  ];

  it('renders file tree with folders and files', () => {
    render(<FileTreeView files={mockFiles} height={400} width={300} />);

    expect(screen.getByText('src')).toBeTruthy();
    // Expand folder first (react-arborist starts collapsed)
    fireEvent.click(screen.getByText('src'));

    expect(screen.getByText('main.cpp')).toBeTruthy();
    expect(screen.getByText('utils.h')).toBeTruthy();
  });

  it('highlights current file when provided', () => {
    const { container } = render(
      <FileTreeView
        files={mockFiles}
        currentFile="src/main.cpp"
        height={400}
        width={300}
      />
    );

    // Expand to see children
    fireEvent.click(screen.getByText('src'));

    const highlightedNode = container.querySelector('.tree-node--highlighted');
    expect(highlightedNode?.textContent).toContain('main.cpp');
  });

  // ... more tests
});
```

**Verify**:
- All existing tests still pass
- New virtualization-specific tests added
- Test coverage remains >80%

**Done**: ✅ Tests updated and passing

---

### Task 7: Update Step1SourceSelection to use new props
**Type**: update
**Files**: `src/components/playground/wizard/Step1SourceSelection.tsx`

**Action**:
Update Step1SourceSelection to provide height/width props to FileTreeView:

```typescript
export const Step1SourceSelection: React.FC = () => {
  const [files, setFiles] = React.useState<FileInfo[]>([]);

  // ... existing file selection logic ...

  return (
    <div className="step-source-selection">
      <h2>Select Source Directory</h2>

      {/* Directory selector button */}
      <DirectorySelector onSelect={handleDirectorySelect} />

      {/* File tree view with virtualization */}
      {files.length > 0 && (
        <div className="source-file-tree">
          <FileTreeView
            files={files}
            height={600}  // Fixed height for virtualization
            width={400}   // Fixed width for consistent layout
          />

          {/* File count statistics */}
          <div className="file-stats">
            <p>{countTreeNodes(fileInfoToTreeData(files))} files discovered</p>
          </div>
        </div>
      )}
    </div>
  );
};
```

**Verify**:
- Step 1 still renders correctly
- Tree view displays when directory selected
- No TypeScript errors
- Layout looks good in browser

**Done**: ✅ Step 1 integration updated

---

### Task 8: Visual regression testing in browser
**Type**: manual testing
**Files**: N/A (browser testing)

**Action**:
Manually test in development browser:

1. Start dev server: `npm run dev`
2. Navigate to playground page
3. Advance to Step 1 (Source Selection)
4. Select a directory with many files (100+ files if possible)
5. Verify:
   - Tree renders quickly (no lag)
   - Scrolling is smooth
   - Folders expand/collapse correctly
   - File names and icons display properly
   - No console errors
   - Layout doesn't break on resize

**Create test project if needed**:
```bash
# Generate test project with 2000 files
mkdir -p /tmp/test-project-2000
cd /tmp/test-project-2000
for i in {1..100}; do
  mkdir -p folder_$i
  for j in {1..20}; do
    echo "// Test file $i-$j" > folder_$i/file_$j.cpp
  done
done
```

**Verify**:
- Visual appearance matches design
- Performance feels responsive
- No visual glitches during scrolling
- Folders expand/collapse smoothly

**Done**: ✅ Visual testing complete, no issues found

---

## Verification

**Overall checks after all tasks complete:**

1. ✅ `npm install` succeeds with react-arborist
2. ✅ `npm run test` passes all tests (including benchmarks)
3. ✅ `npm run dev` starts without errors
4. ✅ Navigate to playground, advance to Step 1
5. ✅ Select directory with 100+ files - tree renders instantly
6. ✅ Scroll through tree - smooth, no jank
7. ✅ Expand/collapse folders - works correctly
8. ✅ Benchmark tests show <200ms render for 1000 files
9. ✅ Virtualization test shows only visible nodes rendered
10. ✅ No TypeScript errors in IDE
11. ✅ No console errors or warnings in browser
12. ✅ Tree view handles 2000-file test project smoothly

---

## Success Criteria

- [x] react-arborist installed and configured
- [x] FileTreeView refactored to use Tree component
- [x] TreeNodeRenderer created with file/folder icons
- [x] tree-data.ts utilities convert FileInfo to TreeNodeData
- [x] Performance benchmark tests pass (<200ms for 1000 files)
- [x] Virtualization verified (only visible nodes rendered)
- [x] Existing FileTreeView tests updated and passing
- [x] Step1SourceSelection integration updated
- [x] Manual browser testing confirms smooth performance
- [x] All existing tests still pass (no regressions)

---

## Performance Targets (from BRIEF)

**Requirement**: Tree view render <200ms for 1000 files
**Requirement**: Tree must handle 2000+ files without lag
**Requirement**: File highlighting update <50ms during transpilation (Phase 3)

**Expected results with react-arborist:**
- 1000 files: ~50-100ms render time (well under 200ms target)
- 2000 files: ~100-200ms render time (smooth)
- 5000 files: ~200-400ms render time (still usable)
- Only 15-20 nodes rendered regardless of total file count (virtualization)
- Scroll performance: 60fps (browser-native scrolling)

---

## Integration Points

**Used by** (in this phase):
- `Step1SourceSelection.tsx` - displays source directory tree

**Used by** (in future phases):
- `Step3Transpilation.tsx` - shows tree with live highlighting (Phase 3)
- `Step4Results.tsx` - shows transpiled files tree (Phase 4)

**Dependencies**:
- `02-01-PLAN.md` - FileTreeView component foundation must exist
- `react-arborist@^3.4.0` - external virtualization library

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| react-arborist API changes | Medium | Lock to specific version (^3.4.0), test thoroughly |
| Performance doesn't meet targets | High | Benchmark tests enforce <200ms requirement, fail fast |
| TypeScript type conflicts | Low | Install @types/react-arborist, use strict typing |
| Existing tests break | Medium | Update tests incrementally, maintain coverage |
| Custom styling conflicts with library | Low | Use CSS modules or scoped styles, test visually |

---

## Output: SUMMARY.md

When this plan is complete, create `02-02-SUMMARY.md` with:

```markdown
# Phase 2, Plan 02-02: Tree Virtualization - COMPLETE

**Status**: ✅ Complete
**Completed**: [date]
**Duration**: [actual time]

## What Was Built

- Installed react-arborist virtualization library
- Created tree-data.ts utilities for data transformation
- Refactored FileTreeView to use react-arborist Tree component
- Created TreeNodeRenderer for custom node display
- Added performance benchmark tests (1000, 2000, 5000 files)
- Verified virtualization (only visible nodes rendered)
- Updated Step1SourceSelection integration

## Performance Results

- 1000 files: Xms render (target: <200ms) ✅
- 2000 files: Xms render ✅
- 5000 files: Xms render ✅
- Virtualization: X nodes rendered out of 2000 total ✅

## Files Changed

- `package.json` - Added react-arborist dependency
- `src/lib/playground/wizard/tree-data.ts` - NEW (X lines)
- `src/components/playground/wizard/FileTreeView.tsx` - REFACTORED (X lines)
- `src/components/playground/wizard/TreeNodeRenderer.tsx` - NEW (X lines)
- `src/components/playground/wizard/FileTreeView.benchmark.test.tsx` - NEW (X lines)
- `src/components/playground/wizard/FileTreeView.test.tsx` - UPDATED (X lines)
- `src/components/playground/wizard/Step1SourceSelection.tsx` - UPDATED (X lines)

## Tests

- Unit tests: X passing, 0 failing
- Benchmark tests: 4 passing (1000/2000/5000 file tests + virtualization check)
- Coverage: X% (target: >80%)

## Verification

✅ All success criteria met
✅ Performance targets exceeded
✅ No regressions in existing tests
✅ Tree handles 2000+ files smoothly in browser
✅ Virtualization confirmed working

## Deviations from Plan

[None] OR [List any changes made during implementation]

## Next Steps

Ready for **02-03**: Source Selection Integration
- Wire tree view to Step 1 with file discovery
- Add file filtering (C++ files only)
- Display file count and size statistics

## Commits

- `[commit-hash]` feat(wizard): Add react-arborist virtualization to FileTreeView
- `[commit-hash]` feat(wizard): Create tree data model and utilities
- `[commit-hash]` feat(wizard): Add TreeNodeRenderer with icons and styling
- `[commit-hash]` test(wizard): Add performance benchmarks for tree virtualization
- `[commit-hash]` test(wizard): Update FileTreeView tests for react-arborist
```

---

**Ready to execute**: Run this plan with `/run-plan .planning/phases/02-file-tree-view/02-02-PLAN.md`
