# Phase 21, Plan 21-01: Fix File Tree Auto-Scroll to Currently Processing File

**Phase**: 21 - Bugfix: File tree not scrolling to currently processing file
**Plan**: 21-01 - Fix react-arborist scrollTo implementation
**Type**: Bugfix
**Estimate**: 20 minutes
**Created**: 2025-12-22

---

## Objective

Fix the FileTreeView component to automatically scroll to the currently processing file during transpilation, keeping it visible in the viewport.

**Why This Matters**:
- Users can't see which file is currently being processed if it's off-screen
- File tree shows status updates (âœ“ âœ— ğŸ”„) but doesn't auto-scroll to active file
- Poor UX - users must manually scroll to find the file being processed
- Phase 20 fixed status updates, but scroll behavior is broken

**Success**: File tree automatically scrolls to currently processing file, keeping it centered in viewport

---

## Context

### Current State (Broken)

**What User Sees**:
- File tree expands and shows status icons correctly (Phase 20 fix)
- File being processed has ğŸ”„ icon and yellow highlight
- BUT if file is off-screen (scrolled out of view), user doesn't see the progress
- No auto-scroll to bring currently processing file into view

**Root Cause**:
```typescript
// FileTreeView.tsx - LINE 73-82
useEffect(() => {
  if (autoScroll && selectedFile && treeRef.current) {
    // Find the node for the selected file
    // react-arborist provides scrollTo functionality via the Tree ref
    const tree = treeRef.current;
    if (tree && tree.scrollTo) {
      tree.scrollTo(selectedFile);  // âŒ This is NOT working!
    }
  }
}, [selectedFile, autoScroll]);
```

**Why It's Broken**:
1. `tree.scrollTo()` is being called but not actually scrolling
2. Possible reasons:
   - Wrong API usage (missing alignment parameter)
   - Node not found (ID mismatch)
   - Tree not properly initialized when scrollTo is called
   - Timing issue (useEffect running before Tree is ready)

### Architecture

```
Step3Transpilation
  â”œâ”€â”€ currentFile state (path of file being processed)
  â”œâ”€â”€ onFileStarted callback â†’ updates currentFile to current path
  â”œâ”€â”€ onFileCompleted callback â†’ keeps currentFile until next file
  â””â”€â”€ passes currentFile as selectedFile to FileTreeView
        â†“
FileTreeView
  â”œâ”€â”€ receives selectedFile prop (e.g., "src/main.cpp")
  â”œâ”€â”€ buildTreeData creates nodes with id = file path
  â”œâ”€â”€ useEffect watches selectedFile changes
  â””â”€â”€ calls tree.scrollTo(selectedFile) â†’ âŒ NOT WORKING
```

**Expected Behavior**:
- When file "src/utils.cpp" starts processing
- Step3 sets currentFile = "src/utils.cpp"
- FileTreeView receives selectedFile = "src/utils.cpp"
- useEffect triggers
- tree.scrollTo("src/utils.cpp", "center") scrolls to that file
- File with ğŸ”„ icon is centered in viewport

---

## Root Cause Analysis

After researching react-arborist v3.4.3 API, the issue is:

### Issue 1: Missing Alignment Parameter
```typescript
tree.scrollTo(selectedFile);  // âŒ No alignment specified
```

Should be:
```typescript
tree.scrollTo(selectedFile, "center");  // âœ… Centers node in viewport
```

### Issue 2: Potential Timing Issue
The `useEffect` might run before the Tree component is fully rendered and ready. Need to ensure Tree is initialized.

### Issue 3: Node ID Verification
Need to verify that `selectedFile` path matches the node `id` created by `buildTreeData()`.

From `buildTreeData.ts:54`:
```typescript
const fileNode: TreeNode = {
  id: nextPath,  // This is the full path (e.g., "src/main.cpp")
  name: part,
  isFolder: false,
  fileInfo: file,
};
```

So node ID = file path âœ… This is correct.

---

## Tasks

### Task 1: Fix scrollTo API Call with Alignment
**Type**: Code Fix
**Action**: Add "center" alignment parameter to scrollTo call
**Files**: `src/components/playground/wizard/FileTreeView.tsx`

**Steps**:
1. Read FileTreeView.tsx (lines 73-82)
2. Change `tree.scrollTo(selectedFile)` to `tree.scrollTo(selectedFile, "center")`
3. This centers the currently processing file in the viewport
4. Verify TypeScript compiles

**Before** (line 73-82):
```typescript
useEffect(() => {
  if (autoScroll && selectedFile && treeRef.current) {
    // Find the node for the selected file
    // react-arborist provides scrollTo functionality via the Tree ref
    const tree = treeRef.current;
    if (tree && tree.scrollTo) {
      tree.scrollTo(selectedFile);  // âŒ Missing alignment
    }
  }
}, [selectedFile, autoScroll]);
```

**After**:
```typescript
useEffect(() => {
  if (autoScroll && selectedFile && treeRef.current) {
    const tree = treeRef.current;
    if (tree && tree.scrollTo) {
      // Scroll to currently processing file, centered in viewport
      tree.scrollTo(selectedFile, "center");
    }
  }
}, [selectedFile, autoScroll]);
```

**Why This Works**:
- `"center"` alignment centers the node in the viewport
- react-arborist automatically opens parent folders if needed
- No manual expansion required
- Smooth scrolling to target node

**Verify**:
- âœ… TypeScript compiles without errors
- âœ… No console errors about scrollTo
- âœ… File tree scrolls during transpilation

**Done When**: FileTreeView.tsx updated, compiles cleanly

---

### Task 2: Add Timing Safety Check
**Type**: Code Enhancement
**Action**: Ensure Tree is ready before calling scrollTo
**Files**: `src/components/playground/wizard/FileTreeView.tsx`

**Steps**:
1. Add small delay or check if Tree is initialized
2. Use `setTimeout` or check `tree.props` to verify Tree is ready
3. Only call scrollTo if Tree has data

**Enhanced Implementation**:
```typescript
useEffect(() => {
  if (autoScroll && selectedFile && treeRef.current) {
    const tree = treeRef.current;

    // Ensure Tree is ready before scrolling
    if (tree && tree.scrollTo && typeof tree.scrollTo === 'function') {
      // Small delay to ensure Tree is fully rendered
      setTimeout(() => {
        try {
          tree.scrollTo(selectedFile, "center");
        } catch (err) {
          console.warn('Failed to scroll to file:', selectedFile, err);
        }
      }, 50);
    }
  }
}, [selectedFile, autoScroll]);
```

**Why This Helps**:
- 50ms delay ensures Tree DOM is ready
- try/catch prevents crashes if scrollTo fails
- Console warning helps debugging

**Verify**:
- âœ… No timing-related scroll failures
- âœ… Scroll works reliably every time
- âœ… No console errors

**Done When**: Timing safety added, tested

---

### Task 3: Manual Browser Testing
**Type**: Testing
**Action**: Verify auto-scroll works during transpilation
**Files**: None (browser testing)

**Steps**:
1. Dev server should hot-reload automatically
2. Open: http://localhost:4321/cpp-to-c-website/playground
3. Select source directory with many C++ files (50+ files for better test)
4. Select target directory
5. Start transpilation
6. **Watch File Status panel during execution**:
   - âœ… File tree scrolls automatically to currently processing file
   - âœ… File with ğŸ”„ icon is centered in viewport
   - âœ… Can see status progression without manual scrolling
   - âœ… Scrolling is smooth and not jarring

**Expected Behavior**:
```
File Status (auto-scrolls as files are processed)
  ğŸ“ build
  ğŸ“ include
  ğŸ“‚ src              (expanded)
    âœ“ main.cpp       (completed - green)
    âœ“ utils.cpp      (completed - green)
    ğŸ”„ helper.cpp    (in progress - CENTERED IN VIEWPORT)  â† Auto-scrolled here
    â³ parser.cpp    (pending - visible below)
    â³ lexer.cpp     (pending)
    ... (more files)
```

**Verify**:
- âœ… Tree scrolls to each new file as it starts processing
- âœ… Currently processing file (ğŸ”„) is centered in viewport
- âœ… Users can see progress without manual scrolling
- âœ… Scrolling works even with 100+ files

**Done When**: Auto-scroll confirmed working in browser

---

### Task 4: Commit Fix
**Type**: Git
**Action**: Commit the working fix
**Files**: `FileTreeView.tsx`

**Steps**:
1. Stage changes: `git add src/components/playground/wizard/FileTreeView.tsx`
2. Commit with descriptive message
3. Reference Phase 21-01

**Commit Message**:
```
fix(21-01): Enable auto-scroll to currently processing file in FileTreeView

Root cause: scrollTo() called without alignment parameter
- react-arborist scrollTo requires alignment: "center", "start", "end"
- Missing alignment prevented proper scrolling behavior
- File tree didn't scroll to show currently processing file

Solution: Add "center" alignment to scrollTo call
- Scroll to currently processing file, centered in viewport
- Added timing safety with setTimeout to ensure Tree is ready
- Added try/catch for error handling

Impact:
- Users see currently processing file without manual scrolling
- File tree auto-scrolls to ğŸ”„ file during transpilation
- Better UX - can track progress in real-time
- Works with large file lists (100+ files)

Fixes: Phase 21-01 - File tree auto-scroll during transpilation
```

**Verify**:
- âœ… Commit created successfully
- âœ… Commit message is descriptive
- âœ… References Phase 21-01

**Done When**: Changes committed to git

---

## Verification

**Overall Success Criteria**:
- âœ… Added "center" alignment to scrollTo call
- âœ… Added timing safety (setTimeout + try/catch)
- âœ… TypeScript compiles without errors
- âœ… File tree auto-scrolls to currently processing file
- âœ… Scrolling is smooth and centered
- âœ… No console errors
- âœ… Changes committed to git

**Definition of Done**:
- Browser testing confirms auto-scroll works
- Currently processing file (ğŸ”„) is centered in viewport
- Users can see progress without manual scrolling
- Commit created with detailed explanation

---

## Output

Create `21-01-SUMMARY.md` with:

### What Was Completed
- âœ… Task 1: Fixed scrollTo API call with "center" alignment
- âœ… Task 2: Added timing safety check
- âœ… Task 3: Browser verification results
- âœ… Task 4: Changes committed

### Code Changes
```diff
# src/components/playground/wizard/FileTreeView.tsx

  useEffect(() => {
    if (autoScroll && selectedFile && treeRef.current) {
      const tree = treeRef.current;
-     if (tree && tree.scrollTo) {
-       tree.scrollTo(selectedFile);
-     }
+     if (tree && tree.scrollTo && typeof tree.scrollTo === 'function') {
+       setTimeout(() => {
+         try {
+           tree.scrollTo(selectedFile, "center");
+         } catch (err) {
+           console.warn('Failed to scroll to file:', selectedFile, err);
+         }
+       }, 50);
+     }
    }
  }, [selectedFile, autoScroll]);
```

### Verification Results
**Before Fix**:
- âŒ File tree didn't auto-scroll during transpilation
- âŒ Couldn't see currently processing file if off-screen
- âŒ Users had to manually scroll to find ğŸ”„ file

**After Fix**:
- âœ… File tree auto-scrolls to currently processing file
- âœ… File with ğŸ”„ icon is centered in viewport
- âœ… Smooth scrolling as files are processed
- âœ… Works with large file lists (100+ files)

### Commits
- Commit hash and message

### Impact
- Users see currently processing file without manual scrolling
- Better UX - real-time progress tracking
- File tree auto-scrolls during transpilation
- Complements Phase 20 status indicators with auto-scroll

---

**Status**: â¬œ Not Started
**Next**: Execute this plan to fix file tree auto-scroll
