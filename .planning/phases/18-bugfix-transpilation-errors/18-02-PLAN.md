# Phase 18, Plan 18-02: Automated WASM Path Testing with Playwright

**Phase**: 18 - Bugfix: Transpilation 161/161 Errors
**Plan**: 18-02 - Automated path resolution testing
**Type**: Automated Testing
**Estimate**: 1 hour
**Created**: 2025-12-22

---

## Objective

Use Playwright MCP to automatically test the WASM worker test page and identify which path resolution approach successfully loads WASM files in Web Worker context, without manual browser interaction.

**Why This Matters**:
- Previous manual attempts used `window.location` → `self.location` → `import.meta.env.BASE_URL`, all failed with 404
- Manual browser testing is slow and requires user intervention
- Playwright MCP can automate the browser interaction and capture exact results
- Need to identify working path before applying fix to production code

**Success**: Automated test runs, captures test results, identifies which path(s) work, we apply the fix

---

## Context

### Current State
```typescript
// WasmTranspilerAdapter.ts (line 59-60) - CURRENT (BROKEN)
const baseUrl = import.meta.env.BASE_URL || '/';
const wasmJsPath = `${baseUrl}wasm/cpptoc.js`;
// Results in: /cpp-to-c-website/wasm/cpptoc.js → 404 Not Found
```

### Test Page Created
- `src/pages/wasm-test.html` - Test harness with UI
- `src/workers/wasm-test.worker.ts` - Tests 6 different path approaches
- Dev server running: http://localhost:4321/cpp-to-c-website/wasm-test.html

### Path Approaches Being Tested
1. Vite BASE_URL: `${import.meta.env.BASE_URL}wasm/cpptoc.js`
2. Hard-coded with base: `/cpp-to-c-website/wasm/cpptoc.js`
3. Hard-coded without base: `/wasm/cpptoc.js`
4. Relative from root: `wasm/cpptoc.js`
5. Origin + base: `${self.location.origin}/cpp-to-c-website/wasm/cpptoc.js`
6. Origin + root: `${self.location.origin}/wasm/cpptoc.js`

### Architecture
```
TranspilationController
  ↓
WorkerPoolController (7 workers)
  ↓
transpiler.worker.ts
  ↓
WasmTranspilerAdapter.initialize() ← 404 happens here
  ↓
fetch(`${baseUrl}wasm/cpptoc.js`) ← needs correct path
```

---

## Tasks

### Task 1: Navigate to Test Page with Playwright
**Type**: Automated Testing
**Action**: Use Playwright MCP to navigate to the test page
**Files**: None (browser automation)

**Steps**:
1. Use `mcp__playwright__browser_navigate` to open test page
2. Use `mcp__playwright__browser_snapshot` to verify page loaded
3. Confirm "Run Tests" button is visible

**Verify**:
- ✅ Page loads without errors
- ✅ Test UI is visible
- ✅ "Run Tests" button exists

**Done When**: Browser snapshot shows test page UI

---

### Task 2: Execute WASM Path Tests
**Type**: Automated Testing
**Action**: Click "Run Tests" button and wait for results
**Files**: None (browser automation)

**Steps**:
1. Use `mcp__playwright__browser_click` to click "Run Tests" button
2. Use `mcp__playwright__browser_wait_for` to wait for test completion
   - Wait for text: "Test Summary:" (indicates results ready)
3. Use `mcp__playwright__browser_snapshot` to capture results table

**Verify**:
- ✅ Worker created successfully
- ✅ All 6 tests executed
- ✅ Results table displayed
- ✅ At least one test shows SUCCESS status

**Done When**: Results table captured with success/failure for each approach

---

### Task 3: Analyze Results and Identify Solution
**Type**: Analysis
**Action**: Parse test results to find working path(s)
**Files**: None (analysis only)

**Steps**:
1. Review Playwright snapshot/screenshot of results table
2. Identify which test(s) show "✅ SUCCESS" status
3. Extract the exact path that worked
4. Document why that approach works vs. others

**Verify**:
- ✅ At least one working path identified
- ✅ Reason for success understood
- ✅ Can explain why other approaches failed

**Done When**: Know exact path resolution strategy to use

---

### Task 4: Apply Fix to WasmTranspilerAdapter
**Type**: Code Fix
**Action**: Update WasmTranspilerAdapter with working path
**Files**: `src/adapters/WasmTranspilerAdapter.ts`

**Steps**:
1. Read current implementation (lines 45-110)
2. Replace broken path logic with working approach from tests
3. Add comment explaining why this approach works
4. Verify TypeScript compiles without errors

**Example Fix** (if hard-coded path works):
```typescript
// Line 59-60
// Use hard-coded base path - works in both main thread and workers
// (import.meta.env.BASE_URL fails in worker context)
const baseUrl = '/cpp-to-c-website/';
const wasmJsPath = `${baseUrl}wasm/cpptoc.js`;
```

**Verify**:
- ✅ TypeScript compiles without errors
- ✅ No eslint warnings
- ✅ Comment explains the choice
- ✅ Code is cleaner/simpler than before

**Done When**: Fix applied and compiles cleanly

---

### Task 5: Verify Fix with Full Transpilation Flow
**Type**: Integration Testing
**Action**: Use Playwright to test actual transpilation
**Files**: None (browser automation)

**Steps**:
1. Navigate to playground: `/cpp-to-c-website/playground`
2. Use `mcp__playwright__browser_click` to click "Select Directory"
   - **Note**: File picker dialog cannot be automated - skip directory selection
3. Instead, check browser console for WASM initialization
4. Use `mcp__playwright__browser_console_messages` to verify:
   - "✅ WASM Transpiler initialized successfully" appears
   - No "404 Not Found" errors
   - No "window is not defined" errors

**Verify**:
- ✅ WASM adapter initializes without 404 errors
- ✅ Console shows successful initialization
- ✅ No path resolution errors in console

**Done When**: Console confirms WASM loads successfully in production code

---

### Task 6: Commit Fix
**Type**: Git
**Action**: Commit the working fix
**Files**: `src/adapters/WasmTranspilerAdapter.ts`

**Steps**:
1. Stage changes: `git add src/adapters/WasmTranspilerAdapter.ts`
2. Commit with descriptive message
3. Reference Phase 18 in commit message

**Commit Message**:
```
fix(18): Fix WASM path resolution using [identified approach]

Root cause: import.meta.env.BASE_URL doesn't work in Web Worker context
Solution: [describe winning approach from tests]

Automated testing with Playwright MCP identified that [path approach]
successfully loads WASM files in worker context.

Previous attempts:
- window.location → fails (window not defined in workers)
- self.location → fails (returns worker script path)
- import.meta.env.BASE_URL → fails (not available in workers)

Fixes: Phase 18-02 - All 161 transpilation errors
Impact: Enables parallel WASM transpilation in browser workers
```

**Verify**:
- ✅ Commit created successfully
- ✅ Commit message is descriptive
- ✅ References Phase 18-02

**Done When**: Changes committed to git

---

## Verification

**Overall Success Criteria**:
- ✅ Playwright successfully navigates to test page
- ✅ Automated test execution captures results
- ✅ At least one path approach shows SUCCESS
- ✅ Working path identified and documented
- ✅ Fix applied to WasmTranspilerAdapter
- ✅ TypeScript compiles without errors
- ✅ Console confirms WASM loads in production
- ✅ Changes committed to git
- ✅ No 404 errors in any context

**Definition of Done**:
- Test page automated with Playwright MCP
- Test results analyzed
- Root cause fully understood (why other approaches failed)
- Working fix applied and verified
- Commit created with detailed explanation

---

## Output

Create `18-02-SUMMARY.md` with:

### What Was Completed
- ✅ List each task with completion status
- ✅ Playwright automation results
- ✅ Test results table (which paths worked/failed)
- ✅ Analysis of why winning approach works
- ✅ Code changes made

### Test Results
```
| Path Approach | Status | Details |
|---------------|--------|---------|
| Vite BASE_URL | ❌/✅ | HTTP status / error |
| Hard-coded with base | ❌/✅ | HTTP status / error |
| ... | ... | ... |
```

### Root Cause Analysis
- **Problem**: [Describe the path resolution issue]
- **Why Previous Fixes Failed**: [window → self.location → BASE_URL]
- **Why This Fix Works**: [Explain winning approach]
- **Technical Details**: [Worker context, module loading, etc.]

### Code Changes
```diff
# src/adapters/WasmTranspilerAdapter.ts

- const baseUrl = import.meta.env.BASE_URL || '/';
+ const baseUrl = '[working path]';
```

### Verification Results
- ✅ WASM loads in worker context
- ✅ No 404 errors
- ✅ Console shows successful initialization
- ✅ TypeScript compiles cleanly

### Commits
- Commit hash and message

### Impact
- Before: 161/161 files failed with 404 errors
- After: WASM loads successfully in all 7 workers
- Result: Parallel transpilation enabled

---

## Notes

### Playwright MCP Capabilities
- ✅ Navigate to pages
- ✅ Click buttons
- ✅ Wait for content
- ✅ Capture snapshots/screenshots
- ✅ Read console messages
- ❌ Cannot interact with native file picker dialogs

### Fallback Testing Strategy
If Playwright cannot fully test transpilation flow:
1. Focus on WASM initialization in console
2. User manually tests directory selection after fix applied
3. Console verification is sufficient to confirm fix

### Deviations from Plan
Any deviations will be documented in SUMMARY.md per standard deviation rules:
- Auto-fix bugs immediately
- Auto-fix blockers immediately
- Document all changes

---

**Status**: ⬜ Not Started
**Next**: Execute this plan using Playwright MCP automation
